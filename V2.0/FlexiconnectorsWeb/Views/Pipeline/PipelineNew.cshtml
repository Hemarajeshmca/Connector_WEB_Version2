        @*@model List<ConnectionDto>*@
@model Connection
@{
    Layout = "~/Views/Shared/_Layout.cshtml";
}

<script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
<link href="https://kendo.cdn.telerik.com/2024.1.319/styles/kendo.default-v2.min.css" rel="stylesheet" />

<style>
    /* .k-animation-container {
        top: 260px !important;
    } */
    .k-window-titlebar .k-window-actions {
        display: block !important;
    }

    #existingdataset-list {
        width: 405px !important;
        box-sizing: border-box;
    } 

    .show-tab-important {
        opacity: 1 !important;
        display: block !important;
    }

    .k-header, .k-treemap-title, .k-grid-header .k-header > .k-link {
        color: #fff !important;
    }

    .k-grid-header th.k-header > .k-link {
        padding: .7em 0.6em .7em .6em !important;
    }

    #grid_dsfieldMapping .k-header .k-grid-toolbar {
        background-image: none, linear-gradient(to bottom, rgb(250, 250, 250) 0, rgb(250, 250, 250) 100%);
    }

    select {
        color: black !important;
    }

    /* Close button styling */
    .custom-close {
        position: absolute;
        top: 10px;
        right: 10px;
        background: none;
        border: none;
        font-size: 20px;
        cursor: pointer;
        z-index: 1000; /* Ensures it's above content */
    }

    /* Scrollable content */
    .popup-content {
        max-height: 350px; /* Adjust height as needed */
        overflow-y: auto; /* Enables vertical scrolling */
        padding: 20px;
        margin-top: 40px; /* Ensures space below close button */
        border: 1px solid #ccc; /* Optional border for clarity */
    }
</style>

<style>

    .switch {
        position: relative;
        display: inline-block;
        width: 50px;
        height: 26px;
    }

        .switch input {
            opacity: 0;
            width: 0;
            height: 0;
        }

    .slider {
        position: absolute;
        cursor: pointer;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background-color: #ccc;
        -webkit-transition: .4s;
        transition: .4s;
    }

        .slider:before {
            position: absolute;
            content: "";
            height: 19px;
            width: 19px;
            left: 1px;
            bottom: 4px;
            background-color: white;
            -webkit-transition: .4s;
            transition: .4s;
        }

    input:checked + .slider {
        background-color: #2196F3;
    }

    input:focus + .slider {
        box-shadow: 0 0 1px #2196F3;
    }

    input:checked + .slider:before {
        -webkit-transform: translateX(26px);
        -ms-transform: translateX(26px);
        transform: translateX(26px);
    }

    /* Rounded sliders */
    .slider.round {
        border-radius: 34px;
    }

        .slider.round:before {
            border-radius: 50%;
        }

    #send {
        position: fixed;
        bottom: 25%;
        left: 5%;
    }

    .nav-tabs > li.active > a, .nav-tabs > li.active > a:focus, .nav-tabs > li.active > a:hover {
        color: #fff !important;
        cursor: default;
        background-color: #872e7b !important;
        border: 1px solid #872e7b !important;
        border-bottom-color: transparent;
    }

    .nav-tabs > li > a {
        margin-right: 2px;
        line-height: 1.42857143;
        border: 1px solid #808080;
        border-radius: 4px 4px 0 0;
        background: #808080 !important;
        color: #fff !important;
    }

    .nav-align-top > .tab-content, .nav-align-right > .tab-content, .nav-align-bottom > .tab-content, .nav-align-left > .tab-content {
        box-shadow: none !important;
    }

    /*  div#spinner {
                    display: none !important;
                } */

    .content-wrapper {
        min-height: 564px !important;
        margin-top: -13px !important;
    }

    .btns {
        margin-top: 23px;
        /* width: 100%; */
    }

    #home .table {
        table-layout: fixed;
        width: 100%;
    }

        #home .table td, .table th {
            max-width: 200px;
            word-wrap: break-word;
            white-space: normal;
            padding: 8px;
        }

            #home .table td:nth-child(2), .table th:nth-child(2) {
                max-width: 400px;
            }

        #home .table th {
            word-wrap: break-word;
            text-align: center;
        }

        #home .table td, .table th {
            text-align: left;
        }

    #menu2 .table {
        table-layout: fixed;
        width: 100%;
    }

        #menu2 .table td, .table th {
            max-width: 200px;
            word-wrap: break-word;
            white-space: normal;
            padding: 8px;
        }

            #menu2 .table td:nth-child(2), .table th:nth-child(2) {
                max-width: 400px;
            }

        #menu2 .table th {
            word-wrap: break-word;
            text-align: center;
        }

        #menu2 .table td, .table th {
            text-align: left;
        }
</style>


<style>

    .k-grid td {
        line-height: 2.3em;
    }

    .modal-content {
        top: 17px;
        left: 100px;
    }

    .cancel {
        width: 100px;
        border: 1px solid red !important;
        background: transparent;
        font-weight: bold;
        color: red;
        border: 0 none;
        border-radius: 5px !important;
        cursor: pointer;
        padding: 9px 5px;
        margin: 10px 5px 0px 5px;
    }

    .save {
        width: 100px;
        background: #0fc9b7;
        border-radius: 5px;
        font-weight: bold;
        color: #ffff;
        border: 0 none;
        border-radius: 5px;
        cursor: pointer;
        padding: 10px 5px;
        /* margin: 10px 5px;*/
    }

    .demo-wrapper {
        grid-template-columns: 180px 1fr;
    }

    .k-h4 {
        line-height: 26px;
        margin-bottom: 0;
    }

    .k-window-titlebar {
        display: none !important;
        background-color: transparent !important;
    }

    .kd-nodata-wrapper {
        display: block !important;
        padding-top: 20px !important;
    }


    /* Breakpoints for full screen demo: max:599px, min:759px and max: 959 */

    .demo-wrapper {
        grid-template-columns: 1fr;
    }

    .avatar {
        display: block !important;
    }

    .side-container {
        display: none !important;
    }

    .main-container {
        padding-bottom: 0;
    }

    .content-expanded {
        border-end-end-radius: 0;
        border-end-start-radius: 0;
    }


    /* Breakpoint for full screen demo: max:359px */

    .avatar {
        width: 32px;
        height: 32px;
    }

    html.k-webkit.k-webkit114 {
        overflow: hidden;
    }

    div.k-window-content {
        overflow: hidden;
        box-shadow: 0 0 8px 8px rgba(153, 153, 153, 0.8) !important;
    }

    .k-window-title {
        position: absolute;
        left: 9.44em;
        right: 0.44em;
        overflow: hidden;
        cursor: default;
        text-overflow: ellipsis;
        font-weight: bold;
        color: green;
        display: none;
    }

    div.k-window {
        box-shadow: 0 0 8px 8px rgba(153, 153, 153, 0.8) !important;
        padding-top: 0px !important;
    }


    .modal-dialog {
        margin: 11% auto;
    }
</style>
<style>

    .show {
        display: block;
    }

    * {
        margin: 0;
        padding: 0;
    }

    html {
        height: 100%;
    }

    /*form styles*/
    #msform {
        position: relative;
        padding: 0px 10px;
    }

    .k-grid-md td, .k-grid-md .k-table-td {
        padding-block: 5px !important;
    }

    .k-grid {
        border-width: 1px;
        border-style: solid;
        box-sizing: border-box;
        outline: 0;
        font-family: inherit;
        font-size: 14px;
        line-height: 1.4285714286;
        display: flex;
        flex-direction: column;
        position: relative;
        -webkit-touch-callout: none;
        -webkit-tap-highlight-color: rgba(0, 0, 0, 0);
    }

    .navbar {
        margin-bottom: 0px !important;
    }

    #msform fieldset .form-card {
        margin: 0px !important;
        border: 0 none;
        background: #fff;
        border-radius: 0px;
        box-shadow: 0 2px 2px 2px rgba(0, 0, 0, 0.2);
        padding: 20px 29px 30px 43px;
        box-sizing: border-box;
        margin: 0 3% 20px 3%;
        width: 100%;
        /*stacking fieldsets above each other*/
        position: relative;
        height: 67vh;
    }

    #msform fieldset {
        background: white;
        border: 0 none;
        border-radius: 0.5rem;
        box-sizing: border-box;
        margin: 0;
        padding-bottom: 20px;
        /*stacking fieldsets above each other*/
        position: relative;
        background-color: transparent;
    }

        /*Hide all except first fieldset*/
        #msform fieldset:not(:first-of-type) {
            display: none;
        }

        #msform fieldset .form-card {
            text-align: left;
            height: 60vh;
        }

    /*Blue Buttons*/
    #msform .action-button {
        width: 100px;
        background: #0fc9b7;
        border-radius: 5px;
        font-weight: bold;
        color: #ffff;
        border: 0 none;
        border-radius: 5px;
        cursor: pointer;
        padding: 10px 5px;
        margin: 10px 5px;
    }
    /*
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        #msform .action-button:hover, #msform .action-button:focus {
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            box-shadow: 0 0 0 2px white, 0 0 0 3px skyblue;
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        }*/

    /*Previous Buttons*/
    #msform .action-button-previous {
        width: 100px;
        border: 1px solid red !important;
        background: transparent;
        font-weight: bold;
        color: red;
        border: 0 none;
        border-radius: 5px !important;
        cursor: pointer;
        padding: 10px 5px;
        margin: 10px 5px;
    }

    /*   #msform .action-button-previous:hover, #msform .action-button-previous:focus {
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            box-shadow: 0 0 0 2px white, 0 0 0 3px #616161;
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        }*/

    /*Dropdown List Exp Date*/
    select.list-dt {
        border: none;
        outline: 0;
        border-bottom: 1px solid #ccc;
        padding: 2px 5px 3px 5px;
        margin: 2px;
    }

        select.list-dt:focus {
            border-bottom: 2px solid skyblue;
        }

    /*The background card*/
    .card1 {
        z-index: 0;
        border: none;
        border-radius: 0.5rem;
        position: relative;
    }

    /*FieldSet headings*/
    .fs-title {
        font-size: 25px;
        color: #2C3E50;
        margin-bottom: 10px;
        font-weight: bold;
        text-align: left;
    }

    /*progressbar*/
    #progressbar {
        margin-bottom: 0px;
        overflow: hidden;
        color: #0c0c0c;
    }

        #progressbar .active {
            color: #fff;
            background-color: #872e7b !important;
        }

        #progressbar li {
            list-style-type: none;
            font-size: 12px;
            width: 20%;
            float: left;
            position: relative;
        }

            /*ProgressBar before any progress*/
            #progressbar li:before {
                width: 50px;
                height: 50px;
                line-height: 45px;
                display: block;
                font-size: 18px;
                color: #ffffff;
                background: lightgray;
                border-radius: 50%;
                margin: 0 auto 10px auto;
                padding: 2px;
            }

            /*ProgressBar connectors*/
            #progressbar li:after {
                content: '';
                width: 100%;
                height: 2px;
                background: lightgray;
                position: absolute;
                left: 0;
                top: 25px;
                z-index: -1;
            }

            /*Color number of the step and the connector before it*/
            #progressbar li.active:before, #progressbar li.active:after {
                background: skyblue;
            }

    /*Imaged Radio Buttons*/
    .radio-group {
        position: relative;
        margin-bottom: 25px;
    }

    .radio {
        display: inline-block;
        width: 204;
        height: 104;
        border-radius: 0;
        background: lightblue;
        box-shadow: 0 2px 2px 2px rgba(0, 0, 0, 0.2);
        box-sizing: border-box;
        cursor: pointer;
        margin: 8px 2px;
    }

        .radio:hover {
            box-shadow: 2px 2px 2px 2px rgba(0, 0, 0, 0.3);
        }

        .radio.selected {
            box-shadow: 1px 1px 2px 2px rgba(0, 0, 0, 0.1);
        }

    .choose-source .connector-details .container .connector .connector-info {
        padding: 0.5rem;
        cursor: pointer;
        display: flex;
        height: inherit;
        flex-direction: column;
        align-items: center;
        justify-content: space-evenly;
        grid-gap: 0.5rem;
        gap: 0.5rem;
    }

    *:not(.p-inputtext):not(.p-button):focus {
        box-shadow: none !important;
    }

    *:not(.p-inputtext):not(.p-button):focus {
        box-shadow: none !important;
    }

    /*Fit image in bootstrap div*/
    .fit-image {
        width: 100%;
        object-fit: cover;
    }

    .choose-source .connector-details .container .connector .highlight {
        width: 140px;
        height: 130px;
        box-shadow: 0 2px 5px #0000004d;
        border: 4px solid #53adde;
        transition: .3s;
        border-radius: 5px;
    }

    .mandatory {
        color: red;
    }

    .col-md-12 {
        width: 100%;
    }

    .item {
        padding-left: 5px;
        padding-right: 5px;
    }

    .item-card {
        transition: 0.5s;
        cursor: pointer;
    }

    .item-card-title {
        font-size: 15px;
        transition: 1s;
        cursor: pointer;
    }

        .item-card-title i {
            font-size: 15px;
            transition: 1s;
            cursor: pointer;
            color: #ffa710
        }

    .card-title i:hover {
        transform: scale(1.25) rotate(100deg);
        color: #18d4ca;
    }

    .card:hover {
        transform: scale(1.05);
        box-shadow: 10px 10px 15px rgba(0,0,0,0.3);
    }

    .card-text {
        height: 80px;
    }

    .card::before, .card::after {
        position: absolute;
        top: 0;
        right: 0;
        bottom: 0;
        left: 0;
        transform: scale3d(0, 0, 1);
        transition: transform .3s ease-out 0s;
        background: rgba(255, 255, 255, 0.1);
        content: '';
        pointer-events: none;
    }

    .card::before {
        transform-origin: left top;
    }

    .card::after {
        transform-origin: right bottom;
    }

    .card:hover::before, .card:hover::after, .card:focus::before, .card:focus::after {
        transform: scale3d(1, 1, 1);
    }

    #page-content-wrapper {
        padding: 15px;
        width: 80% !important;
    }

    .k-multiselect .k-multiselect-wrap {
        white-space: nowrap;
    }

    .tab-color {
        background-color: grey !important;
        padding: 12px;
        color: #fff;
    }

    .py-2 {
        padding-top: 0.5rem !important;
        padding-bottom: 0.5rem !important;
    }

    .px-3 {
        padding-left: 1rem !important;
        padding-right: 1rem !important;
    }

    .split-button .button-label[_ngcontent-vhm-c150] {
        border-bottom-right-radius: 4px;
        border-top-right-radius: 4px;
        display: inline-block;
        width: max-content;
    }

    .py-2 {
        padding-top: 0.5rem !important;
        padding-bottom: 0.5rem !important;
    }

    .px-3 {
        padding-left: 1rem !important;
        padding-right: 1rem !important;
    }

    .bg-blue-400 {
        background-color: #0fc9b7 !important;
    }

    .text-white {
        color: #fff !important;
    }

    .cursor-pointer {
        cursor: pointer !important;
    }

    .border-none {
        border-width: 0 !important;
        border-style: none;
    }

    .h6, h6 {
        font-size: 15px;
        color: black;
        text-align: right;
    }

    .hide-selected > div.k-input-values {
        display: none;
    }

    html input[disabled], button[disabled] {
        background: #0fc9b759;
        cursor: not-allowed !important;
        opacity: 1;
        /* cursor: default !important;
                    opacity:0.5%; */
    }

    .custom-disabled {
        background-color: #e0e0e0 !important; 
    }

 /*    .enable_disable{
        background: #0fc9b759;
        cursor: not-allowed !important;
        opacity: 1;
    } */

    .btntestconn {
        background: #0fc9b7;
        font-weight: bold;
        color: white;
        border: 0 none;
        border-radius: 5px;
        cursor: pointer;
        padding: 10px 10px;
        float: right
    }

    .query_clr {
        background-color: #2196f3 !important;
    }

    .no-file-chosen {
        color: transparent;
    }

    .checked-row-background {
        background-color: yellow;
    }

    th.k-header {
        color: white;
    }

    .set_val {
        cursor: pointer;
        border: 1px solid green;
        background: green;
        padding: 1px 17px;
        border-radius: 3px;
        margin-left: 41px;
    }

        .set_val > a {
            color: #fff;
            text-align: center;
        }

    .disabled {
        color: gray;
        border: 1px solid gray;
        background: gray;
        opacity: 0.8;
        border-radius: 3px;
        margin-left: 41px;
        padding: 1px 17px;
        pointer-events: none;
        cursor: not-allowed;
    }

        .disabled > a {
            color: #000;
            text-align: center;
        }

    #msform .action-button:focus-visible {
        outline: none; /* Removes the default outline */

        border: 2px solid #0fc9b7;
    }

    .listicon {
        padding-left: 9px;
        padding-right: 8px;
        left: 10px;
        padding-top: 9px;
        padding-bottom: 3px;
        background: #fff;
        color: #872e7b !important;
        border-radius: 4px;
    }

        .listicon > a {
            color: #872e7b !important;
        }
</style>
<!DOCTYPE html>
<html>
<body>
    <div>
        <div style="height:auto;">
            @*<div class="content-wrapper" style="padding:10px;">*@
            <div style="padding:10px;">
                <div class="card1">
                    <div class="row">
                        <div class="col-md-12 mx-0">
                            <form id="msform">
                                <div style="position: absolute; top: 2px; right: 5px; z-index: 1000; padding: 10px;">
                                    <a onclick="goToList()" class="listicon" title="Go to List">
                                        <span class="glyphicon glyphicon-list" style="font-size:22px;" aria-hidden="true"></span>
                                    </a>
                                </div>

                                <ul id="progressbar" style="padding: 8px 0px;">
                                    <li class="active tab-color" id="pipelne"><strong>Pipeline</strong></li>
                                    <li class="tab-color" id="datasource"><strong>Data Source</strong></li>
                                    <li class="tab-color" id="preprocess"><strong>Pre Processing</strong></li>
                                    <li class="tab-color" id="processing"><strong>Processing</strong></li>
                                    <li class="tab-color" id="postprocessing"><strong>Post Processing</strong></li>
                                </ul>
                                <fieldset id="tab1">
                                    <div class="form-card" style="height: 64vh;">
                                        <div class="row" style="margin-left: -29px;margin-bottom: 6px;margin-top: -7px;">
                                            <div class="col-sm-2">
                                                <label class="form-label">PipeLine Code </label>
                                                <input class="form-control" id="txtppl_code" type="text" name="pipeline_code" disabled />
                                            </div>
                                            <div class="col-sm-2">
                                                <label class="form-label">Status </label>
                                                <input class="form-control" id="txtppl_status" type="text" name="pipeline_status" disabled />
                                            </div>
                                        </div>
                                        <div class="row">
                                            <div class="col-sm-5">
                                                <div class="row">
                                                    <div class="col-sm-4" style="width: 33.33333333%;padding-left: 0%;">
                                                        <input class="form-control" type="text" id="txt_ppl_gid" name="txt_ppl_gid" style="display:none" />
                                                        <input class="form-control" type="text" id="txt_ppl_code" name="txt_ppl_code" style="display:none" />
                                                        <input class="form-control" type="text" id="txt_ppl_status" name="txt_ppl_status" style="display:none" />
                                                        <input class="form-control" type="text" id="txt_fileextension" name="txt_fileextension" style="display:none" />
                                                        <input class="form-control" type="text" id="txt_macrofileextension" name="txt_macrofileextension" style="display:none" />
                                                        <input class="form-control" type="text" id="txt_source_db_type" name="txt_source_db_type" style="display:none" />
                                                        <input class="form-control" type="text" id="txt_table_view_query_type" name="txt_table_view_query_type" style="display:none" />
                                                        <input class="form-control" type="text" id="txt_table_view_query_desc" name="txt_table_view_query_desc" style="display:none" />
                                                        <label class="form-label">PipeLine Name </label>
                                                        <span class="mandatory">*</span>
                                                        <input class="form-control" style="width: 249%" id="txtppl_name" type="text" name="pipeline" />
                                                    </div>
                                                    <div class="col-sm-4">
                                                    </div>
                                                    <div class="col-sm-4">
                                                    </div>
                                                </div>
                                                <div class="row">
                                                    <div class="col-sm-4" style="width: 33.33333333%;padding-left: 0%;">
                                                        <label class="form-label">Description </label>
                                                        <textarea class="form-control" id="txtppl_desc" type="text" name="txtppl_desc" style="width: 356px;height: 220px;resize: none;"></textarea>
                                                    </div>
                                                    <div class="col-sm-4">
                                                    </div>
                                                    <div class="col-sm-4">
                                                    </div>
                                                </div>

                                            </div>

                                            <div class="col-sm-7">
                                            </div>
                                        </div>
                                    </div>
                                    <div class="navbar fixed-bottom" style="min-height:0px;"></div>
                                    <input style="float: right;margin-right: 0%;" type="button" id='btn_nextppl' onclick="pplheadersave()" name="next" class="next action-button" value="Next" />
                                </fieldset>
                                <fieldset id="tab2">
                                    <div class="form-card" style="height: 64vh;padding: 10px 36px;">
                                        <label id="lbl_info_ds" style="color:brown; margin-top: -12px;margin-bottom: 0px;"> </label>
                                        <ul id="cc_progressbar" style="padding: 8px;padding-left: 0px;text-align: center;">
                                            <li class="active cc_tab-color" id="templateSelection"><a data-toggle="tab" style="color: #fff;">Template Selection</a></li>
                                            <li class="cc_tab-color" id="datasetSelection"><a data-toggle="tab" style="color: #fff;">Dataset Selection</a></li>
                                        </ul>

                                        <div id="templateSelection_conf">
                                            <div class="row">
                                                <div class="col-md-6">
                                                    <div>
                                                        <label>Connectors</label>
                                                        <span class="mandatory">*</span>
                                                        <select class="form-control" id="connectors" onchange="getdblist($('#connectors').val())" name="ConnectorsId" style="width:100%;">
                                                            <option value="">-- Select --</option>
                                                            @foreach (var connector in ViewBag.Connectors)
                                                            {
                                                                <option value="@connector.Id">@connector.Name</option>
                                                            }
                                                        </select>
                                                    </div>
                                                    <div id="div_srcdbname" style="display:none;">
                                                        <label>Source DataBase Name</label>
                                                        <span class="mandatory">*</span>
                                                        <select class="form-control" onchange="gettablelist($('#connectors').val(),$('#databasename').val())" id="databasename" name="databasename">
                                                        </select>
                                                    </div>
                                                    <div id="div_tvq" style="display:none;">
                                                        <label>Source Table/View/Query</label>
                                                        <span class="mandatory">*</span>
                                                        <select class="form-control" id="src_tblviewquery" name="src_tblviewquery">
                                                            <option selected value="">-- Select --</option>
                                                            <option value="T">Table</option>
                                                            <option value="V">View</option>
                                                            <option value="Q">Custom Query</option>
                                                        </select>
                                                    </div>
                                                    @* Hema changes start*@
                                                    @* div for API *@
                                                    <div id="div_apiurl" style="display:none;">
                                                        <div class="row">
                                                            <div class="col-sm-12">
                                                                <div class="row" style="margin-top: -1%;">
                                                                    <div class="col-sm-3">
                                                                        <label>Method</label>
                                                                        <select readonly id="sel" class="form-control">
                                                                            @* <option value="">  Select  </option> *@ 
                                                                <option value="GET">GET</option>
                                                                        </select>
                                                                    </div>
                                                                    <div class="col-sm-6">
                                                                        <label>Enter URL</label>
                                                                        <input style="display:none;" class="form-control" id="txt_api_gid" type="text" name="txt_api_gid" />
                                                                        <input type="text" class="form-control" id="url" />
                                                                    </div>
                                                                    <div class="col-sm-3">
                                                                        @* <button type="button" onclick="importurl()" class="btn btn-sm btn-primary btns">Import</button> *@
                                                                        <button type="button" onclick="saveapiHeader()" class="btn btn-sm btn-primary btns">Save</button>
                                                                    </div>
                                                                </div>

                                                                <div class="row mt-3" style="margin-left:0%;padding-top:1%;margin-top:10px;">

                                                                    <ul class="nav nav-tabs">
                                                                        <li class="active"><a data-toggle="tab" href="#home">Params</a></li>
                                                                        <li><a data-toggle="tab" href="#menu1">Authorization</a></li>
                                                                        <li><a data-toggle="tab" href="#menu2">Headers</a></li>
                                                                        <li><a data-toggle="tab" href="#menu3">Body</a></li>
                                                                    </ul>
                                                                    <div class="tab-content">
                                                                        <div id="home" style="padding: 0px;" class="tab-pane fade in active">
                                                                            <div class="col-xs-12" style="margin-top:10px;">
                                                                                <table class="table table-bordered table-sm" style="margin-bottom: 0px !important;">
                                                                                    <thead>
                                                                                        <tr>
                                                                                            <th>Key</th>
                                                                                            <th>Value</th>
                                                                                            <th>Description</th>
                                                                                        </tr>
                                                                                    </thead>
                                                                                </table>
                                                                                <div style="max-height: 300px; overflow-y: auto; height: 100px;">
                                                                                    <table class="table table-bordered table-sm">
                                                                                        <tbody id="table-body">
                                                                                            <tr>
                                                                                                <td><input type="text" id="key" class="form-control" /></td>
                                                                                                <td><input type="text" id="value" class="form-control" /></td>
                                                                                                <td><input type="text" id="desc" class="form-control" /></td>
                                                                                            </tr>
                                                                                        </tbody>
                                                                                    </table>
                                                                                </div>
                                                                            </div>
                                                                        </div>
                                                                        <div id="menu1" class="tab-pane fade">
                                                                            <div class="col-sm-6" style="margin-top:10px;">
                                                                                <select id="sel_auth" class="form-control">
                                                                                    <option value="select">  Select  </option>
                                                                                    <option value="no">No Auth</option>
                                                                                    <option value="auth">Basic Auth</option>
                                                                                    <option value="bearer">Bearer Token</option>
                                                                                    <option value="jwt">JWT Bearer</option>
                                                                                    <option value="digest">Digest Auth</option>
                                                                                    <option value="oauth">OAuth 2.0</option>
                                                                                </select>
                                                                            </div>
                                                                        </div>
                                                                        <div id="menu2" class="tab-pane fade">
                                                                            <div class="col-xs-12" style="margin-top:10px;padding:0px;">
                                                                                <table class="table table-bordered table-sm" style="margin-bottom: 0px !important;">
                                                                                    <thead>
                                                                                        <tr>
                                                                                            <th>Key</th>
                                                                                            <th>Value</th>
                                                                                            <th>Description</th>
                                                                                        </tr>
                                                                                    </thead>
                                                                                </table>
                                                                                <div style="max-height: 300px; overflow-y: auto; height: 100px;">
                                                                                    <table class="table table-bordered table-sm">
                                                                                        <tbody id="headerTableBody">
                                                                                            @* <tr>
                                                                        <td><input type="text" id="key" class="form-control" /></td>
                                                                        <td><input type="text" id="key" class="form-control" /></td>
                                                                        <td><input type="text" id="key" class="form-control" /></td>
                                                                    </tr> *@
                                                                                        </tbody>
                                                                                    </table>
                                                                                </div>
                                                                            </div>
                                                                        </div>
                                                                        <div id="menu3" class="tab-pane fade">
                                                                            <div class="row">
                                                                                <div class="col-sm-3" style="margin-top:10px;">
                                                                                    <div class="form-check form-check-inline">
                                                                                        <input class="form-check-input" type="radio" name="radioFilter" id="filternone" value="formnone" />
                                                                                        <label class="form-check-label" for="inlineRadio1">none</label>
                                                                                    </div>
                                                                                </div>
                                                                                <div class="col-sm-3" style="margin-top:10px;">
                                                                                    <div class="form-check form-check-inline">
                                                                                        <input class="form-check-input" type="radio" name="radioFilter" id="filter-formdata" value="formdata" />
                                                                                        <label class="form-check-label" for="inlineRadio1">form-data</label>
                                                                                    </div>
                                                                                </div>
                                                                                <div class="col-sm-3" style="margin-top:10px;">
                                                                                    <div class="form-check form-check-inline">
                                                                                        <input class="form-check-input" type="radio" name="radioFilter" id="filter-raw" value="raw" />
                                                                                        <label class="form-check-label" for="inlineRadio1">raw</label>
                                                                                    </div>
                                                                                </div>
                                                                                <div class="col-sm-3" style="margin-top:10px;">
                                                                                    <div class="form-check form-check-inline" id="rawoptions" value="rawoptions" style="display:none;">
                                                                                        <select id="sel_data" class="form-control">
                                                                                            <option value="Json">JSON</option>
                                                                                            <option value="JS">JavaScript</option>
                                                                                        </select>
                                                                                    </div>
                                                                                </div>
                                                                            </div>
                                                                            <div class="row mt-3" id="formdata" style="display:none;">
                                                                                <div class="col-sm-12" style="margin-top:10px;">
                                                                                    <table class="table table-bordered table-sm">
                                                                                        <thead>
                                                                                            <tr>
                                                                                                <th>Key</th>
                                                                                                <th>Value</th>
                                                                                                <th>Description</th>
                                                                                            </tr>
                                                                                        </thead>
                                                                                        <tbody>
                                                                                            <tr>
                                                                                                <td><input type="text" id="key" class="form-control" /></td>
                                                                                                <td><input type="text" id="key" class="form-control" /></td>
                                                                                                <td><input type="text" id="key" class="form-control" /></td>
                                                                                            </tr>
                                                                                        </tbody>
                                                                                    </table>
                                                                                </div>
                                                                            </div>
                                                                            <div class="row mt-3" id="raw" style="display:none;">
                                                                                <div class="col-sm-12" style="margin-top:10px;">
                                                                                    <textarea class="form-control" rows="5" id="comment" name="text"></textarea>
                                                                                </div>
                                                                            </div>
                                                                        </div>
                                                                    </div>
                                                                </div>

                                                                <div class="row" style="margin-left: 2px;display:none">
                                                                    <button type="button" onclick="saveapiHeader()" id="send" class="btn btn-sm btn-primary btns">Save</button>
                                                                </div>

                                                            </div>
                                                        </div>
                                                    </div>
                                                    @* Hema changes End*@
                                                    <div class="form-group" id="div_fileinput" style="display:none;margin-top: 4px;">
                                                        <div class="col-md-6" style="margin-left: -12px;">
                                                             <label class="form-label">Select File</label>
                                                            <span class="mandatory">*</span>
                                                            <input type="file" id="fileInput" name="fileInput" value="test" accept=".xlsx" onchange="file_change(this)">
                                                         </div>
                                                        <div class="col-md-6" style="visibility:hidden">
                                                            <label class="form-label">Select Macro File</label>                                                            
                                                            <input type="file" id="fileInput_macro" name="fileInput_macro" value="macro" accept=".xlsm" onchange="macro_file_change(this)">
                                                        </div>
                                                    </div>

                                                    <div id="div_delimited">
                                                        <div class="row">
                                                            <div class="col-md-6">
                                                                <label class="form-label">Column Separator </label>
                                                                <span class="mandatory">*</span>
                                                                <input style="display:none;" class="form-control" id="txt_pplcsvheader_gid" type="text" name="txt_pplcsvheader_gid" />
                                                                <input class="form-control" type="text" id="txt_columnseparator" name="txt_columnseparator" />
                                                            </div>
                                                            <div class="col-md-6">
                                                                <label class="form-label">Number Of Columns </label>
                                                                <span class="mandatory">*</span>
                                                                <input class="form-control" type="number" id="txt_number_of_columns" name="txt_number_of_columns" min="1" oninput="validateNumberInput(this,'serialno')" />
                                                            </div>
                                                        </div>
                                                        <div class="row">
                                                            <div class="col-md-6">
                                                                <label class="form-label">Date Format </label>
                                                                @Html.DropDownListFor(model => model.SelectedMasterId, Model.masterDatas, "--Select--", new { @class = "form-control", id = "txt_date_format" })
                                                            </div>
                                                            <div class="col-md-6">
                                                                <label class="form-label">Time Format </label>
                                                                @Html.DropDownListFor(model => model.SelectedMasterId, Model.masterDatas, "--Select--", new { @class = "form-control", id = "txt_datetime_format" })
                                                                @* <input class="form-control" type="text" id="txt_datetime_format" name="txt_datetime_format" /> *@
                                                            </div>
                                                        </div>
                                                        <div class="row">
                                                            <div class="col-md-6">
                                                                <label class="form-label">Number of Lines to Skip </label>
                                                                <input class="form-control" type="number" id="txt_linesto_skip" name="txt_linesto_skip" min="0" max="10" oninput="validateNumberInput(this,'')" />
                                                            </div>
                                                            <div class="col-md-6">
                                                                <input style="margin-top: 21px;margin-right: 0%;" type="button" id='btn_saveCsvHeader' onclick="saveCsvHeader()" class="save" value="Save" />
                                                            </div>
                                                        </div>
                                                    </div>

                                                    <div id="div_selectfile">
                                                        <div class="col-md-6">
                                                            <label class="form-label" style="color:green;margin-left: -13px;" id="selectedfilename"></label>
                                                        </div>
                                                        <div class="col-md-6" style="visibility:hidden">
                                                            <label class="form-label" style="color:green" id="selectedmacrofilename"></label>
                                                        </div>
                                                    </div>

                                                    <div id="div_downloadtemp" style="display:none;">
                                                        <div class="row">
                                                            <div class="col-md-6">
                                                                <button disabled id="temp_download" class="save query_clr" style="width:185px;margin-left: 0px;margin-top: 6px;" onclick="DownloadTemplate()" type="button" name="DownloadTemp">
                                                                    Download Template
                                                                </button>
                                                            </div>
                                                            <div class="col-md-6" style="visibility:hidden">
                                                                <button disabled id="macro_temp_download" class="save query_clr" style="width:185px;margin-left: 0px;margin-top: 6px;" onclick="DownloadMacroTemplate()" type="button" name="DownloadTemp">  Download Macro Template </button>
                                                            </div>
                                                        </div>                                                        
                                                    </div>

                                                    <div class="col-sm-6" id="img_div">
                                                        <img id="imgmysql" src="~/Content/images/mysql.png" alt="My Image" hidden>
                                                        <img id="imgpostgres" src="~/Content/images/postgres.png" alt="My Image" hidden>
                                                        <img id="imgcsv" style="margin-top: 5px; height: 76px; width: 73px;" src="~/Content/images/csv.png" alt="My Image" hidden>
                                                        <img id="imgexcel" src="~/Content/images/excel.png" alt="My Image" hidden>
                                                    </div>
                                                </div>
                                                <div class="col-md-6" id="grid_tvc" style="margin-top: -64px;">
                                                    <input class="form-control" id="txt_tableview_desc" type="text" name="txt_tableview_desc" style="display:none" />
                                                    <input class="form-control" id="txt_sheetname" type="text" name="txt_sheetname" style="display:none" />

                                                    <div id="div_table" hidden>
                                                        <label>Source Table List</label>
                                                        <div id="srctblsearch" style="margin-top: -2.5%;">
                                                        </div>
                                                    </div>
                                                    <div id="div_view" hidden>
                                                        <label>Source View List</label>
                                                        <div id="srcviewsearch" style="margin-top: -2.5%;">
                                                        </div>
                                                    </div>
                                                    <div id="div_excel" hidden>
                                                        <label>Excel Sheet List</label>
                                                        <div id="srcexcelsearch" style="margin-top: -2.5%;">
                                                        </div>
                                                    </div>

                                                    <div id="div_query" hidden>
                                                        <label>Query</label>
                                                        <div id="cust_query">
                                                            <div>
                                                                <textarea id="txt_cusquery" style=" height: 40vh;width: 100%;border: 1px solid #d9c3c3;border-radius: 5px;resize: none;"></textarea>
                                                            </div>
                                                            <div>
                                                                <input style="padding:5px;float:right;" type="button" onclick="checkquery('CustomQuery')" class="save query_clr" value="Check Query" />
                                                                @* <button class="save query_clr" style="float:right;" onclick="checkquery('CustomQuery')" type="button" name="checkquery">Check Query</button> *@
                                                            </div>
                                                        </div>
                                                    </div>

                                                    <div id="div_csv" hidden>
                                                        <button type="button" id="btn_addcsv" onclick="addcsvColumns()" class="text-white cursor-pointer border-none outline-none p-shadow-3 bg-blue-600">
                                                            <span class="button-icon py-2 px-3" style="background-color:#175650 !important;">
                                                                <i class="glyphicon glyphicon-plus "></i>
                                                            </span><span class="button-label py-2 px-3 bg-blue-400">Add Column</span>
                                                        </button>
                                                        <div id="srccsvsearch" style="margin-top: -1%;"> </div>
                                                    </div>

                                                    <div id="div_api" hidden>
                                                        <div id="srcapidssearch" style="margin-top: -1%;">
                                                        </div>

                                                    </div>


                                                </div>
                                            </div>
                                        </div>
                                        <div id="datasetSelection_conf" style="display:none;">
                                            <div class="row">
                                                <div class="row" style="margin-left: 16px;">
                                                    <input type="radio" id="rdo_new_ds" name="rdo_dsmode" value="New" selected onclick="toggleDivs('new')" />
                                                    <label>Add New Dataset</label>                                                    
                                                    &nbsp;&nbsp;&nbsp;
                                                    <input type="radio" id="rdo_existing_ds" name="rdo_dsmode" value="Matched" onclick="toggleDivs('existing')" />
                                                    <label>Dataset Matched</label>
                                                    &nbsp;&nbsp;&nbsp;
                                                    <input type="radio" id="rdo_existingall_ds" name="rdo_dsmode" value="Unmatched" onclick="toggleDivs('existingall')" />
                                                    <label>Dataset Unmatched</label>
                                                </div>

                                                <div class="row" id="add_newds" style="margin-top:15px;margin-left: 5px !important;display: none;">
                                                    <div class="col-md-5">
                                                        <label class="form-label">Dataset Name </label>
                                                        <span class="mandatory">*</span>
                                                        <input class="form-control" id="txtds_gid" type="text" name="dataset_gid" style="display:none" />
                                                        <input class="form-control" id="txtds_code" type="text" name="dataset_code" style="display:none" />
                                                        <input class="form-control" id="txtds_name" type="text" name="dataset" />
                                                    </div>
                                                    <div class="col-md-5">
                                                        <label>Category</label>
                                                        <span class="mandatory">*</span>
                                                        <select class="form-control" id="txtds_category" name="ds_category">
                                                            <option value="">-- Select --</option>
                                                            <option value="BankStatement">Bank Statement</option>
                                                            <option value="Ledger">Ledger</option>
                                                            <option value="Dump">Dump</option>
                                                        </select>
                                                    </div>
                                                    <div class="col-md-2">
                                                        <input style="float: left;margin-top: 14%;padding: 5px 9px;width: 90%;" type="button" id='btn_saveds' onclick="dsSave()" name="save" class="btn btn-sm btn-primary btns" value="Save" />
                                                    </div>
                                                </div>

                                                <div class="row" id="add_existingds" style="margin-top: 5px;margin-left: 23px !important;">
                                                      <div class="row">
                                                        <div class="col-sm-5">
                                                            <label style="margin-top: 6px;">Target DataSet</label>
                                                            <span style="margin-top: 6px;" class="mandatory">*</span> &nbsp;&nbsp;
                                                            <input hidden id="trgdataset" />                                                           
                                                            <input id="existingdataset" />
                                                        </div>
                                                        <div class="col-md-5">
                                                            <label style="margin-top: 6px;">Category</label>
                                                            <span style="margin-top: 6px;" class="mandatory">*</span> &nbsp;&nbsp;
                                                            <select class="form-control" id="txtds_category1" name="ds_category" disabled>
                                                                <option value="">-- Select --</option>
                                                                <option value="BankStatement">Bank Statement</option>
                                                                <option value="Ledger">Ledger</option>
                                                                <option value="Dump">Dump</option>
                                                            </select>
                                                        </div>
                                                        <div class="col-md-2">
                                                            <input style="float: left;margin-top: 18%;padding: 5px 9px;width: 80%;" type="button" id='btn_saveds' onclick="SaveExistingDS()" name="save" class="btn btn-sm btn-primary btns" value="Save" />
                                                        </div>
                                                    </div>
                                                </div>
                                                <div style="display:none" id="ds_grid"> </div>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="navbar fixed-bottom" style="min-height:0px; margin:0px;"></div>
                                    <input style="float: right;margin-right: 0%;" type="button" id='btn_nextppl1' name="btn_nextppl1" class="next action-button" value="Next" />
                                    <input style=" float: right;" type="button" id="btn_prvs1" name="previous" class="previous action-button-previous" value="Previous" />
                                </fieldset>
                                <fieldset id="tab3">
                                    <div class="form-card" style="height:64vh;padding-left: 29px;">
                                        <div style="margin-top: -8px;"> <label id="lbl_info" style="color:brown"> </label> </div>
                                        <ul id="cc_progressbar" style="padding: 8px;padding-left: 0px;text-align: center;">
                                            <li class="active cc_tab-color" id="fieldmappingTab"><a data-toggle="tab" style="color: #fff;">Field Mapping</a></li>
                                            <li class="cc_tab-color" id="filtersTab"><a data-toggle="tab" style="color: #fff;">Filters</a></li>
                                        </ul>
                                        <div style="display:none;" id="expression_conf">
                                            <div class="row">
                                                <h6 style="text-align: center;font-size: 17px;color: green;font-weight: 700;">
                                                    Expressions
                                                </h6>
                                            </div>
                                            <div class="row" style="padding-left: 6px;">
                                                <div class="col-md-4" style="margin-left: 1%;">
                                                    <div class="row">
                                                        <label>Expression Name</label>
                                                        <span class="mandatory">*</span>
                                                        <input style="display:none;" class="form-control" id="txt_pplsourcefield_gid" type="text" name="txt_pplsourcefield_gid" />
                                                        <input class="form-control" id="txt_expression_name" type="text" name="txt_expression_name" style="height: 25%;" />
                                                    </div>
                                                    <div class="row">
                                                        <label>Expression Datatype</label>
                                                        <span class="mandatory">*</span>
                                                        <select class="form-control" id="drp_datatype" name="drp_datatype" style="width:100%;height:25%">
                                                            <option value="-- Select --">-- Select --</option>
                                                            <option value="TEXT">TEXT</option>
                                                            <option value="INTEGER">INTEGER</option>
                                                            <option value="DATE">DATE</option>
                                                            <option value="DATETIME">DATETIME</option>
                                                            <option value="NUMERIC">NUMERIC</option>
                                                        </select>
                                                    </div>
                                                    <div class="row">
                                                        <label>Expression</label>
                                                        <span class="mandatory">*</span>
                                                        <textarea class="form-control" type="text" id="txt_expression_field" onclick="document.getElementById('btn_expressionsave').disabled = true;" name="txt_expression_field" style="color: black; height: 88px;line-height: 20px;resize: none;"></textarea>
                                                    </div>
                                                    <div class="row" style="margin-top: 1%;">
                                                        <input style="padding:5px;" type="button" id='btn_expcheckquery' onclick="IsCheckQuery('Expression')" class="save query_clr" value="Check Query" />
                                                        <input style="margin-left: 2%;padding:5px;" type="button" id='btn_expressionsave' onclick="PPLexpressionSave()" class="save" value="Save" disabled />
                                                        <input style="margin-left: 2%; padding:4px 5px;" onclick="closeexpressionpopup()" type="button" id='btn_expressioncancel' class="cancel" value="Close" />
                                                    </div>
                                                </div>
                                                <div class="col-md-7">
                                                    <div class="row">
                                                        <label style="margin-left:7%;">Expression List</label>
                                                    </div>

                                                    <div class="row" id="expressionsearch" style="margin-top: -1%;margin-left: 1%;">
                                                    </div>
                                                </div>
                                            </div>
                                        </div>

                                        <div id="fieldmapping_conf">


                                            <div id="show_ds" style="margin-top: -5%;">                                             
                                                <div class="row">
                                                    <div class="col-sm-4">
                                                    </div>
                                                    <div class="col-sm-4">
                                                    </div>
                                                    <div class="col-sm-4" id="btn_save" style="margin-left:69%; display: flex;">
                                                        <input style="padding: 1rem !important;cursor:pointer;" type="button" onclick="fieldmapsave()" id='btn_fieldmapsave_new' class="save" value="Save" />
                                                        <input style="padding: 1rem !important;cursor:pointer;margin-left: 12px; color: red;background-color: white;border: 1px solid red;" type="button" onclick="revert()" id='btn_fieldmapRevert' class="save" value="Revert" />
                                                        <div style="display: inline-flex; align-items: center; position: relative; margin-left: 12px;">
                                                            <input type="button" id="btn_addnew" class="save" value="Expression" style="padding: 1rem 2.5rem 1rem 2.5rem !important; cursor: pointer; position: relative; z-index: 1;" />
                                                            <span class="button-icon" style="position: absolute; left: 0.5rem; z-index: 2;"> <i class="glyphicon glyphicon-plus" style="color: #175650 !important;"></i>  </span>
                                                        </div>
                                                    </div>
                                                </div>

                                                <div class="row" id="dataset_fieldMapping"> </div>
                                                <div>
                                                    <label id="parent_pipeline" style="color:red; display:none;">
                                                    </label>
                                                </div>
                                            </div>
                                        </div>

                                        <div style="display:none;" id="filters_conf">
                                            <div class="row" style="padding-left: 1.5%;">
                                                <div class="col-md-6">
                                                    <div>
                                                        <h2 style="margin-top: 10px;margin-bottom:0px; text-align: center;font-size: 17px;color: green;font-weight: 700;">
                                                            Inclusion
                                                        </h2>
                                                    </div>
                                                    <div class="row">
                                                        <input style="display:none;" class="form-control" id="txt_filter_gid" type="text" name="txt_filter_gid" />
                                                        <label>Filter Condition</label>
                                                        <span class="mandatory">*</span>
                                                        <textarea class="form-control" type="text" id="txt_filtercond" name="txt_filtercond" oninput="togglebutton('Filter')" onclick="document.getElementById('btn_filtersave').disabled = true;" style="width:95%;height:175px;color: black;resize: none;"></textarea>
                                                    </div>
                                                    <div class="row" style="margin-top: 2%;">
                                                        <input type="button" id='btn_flcheckquery' class="save query_clr" onclick="ExcelIsCheckQuery('Filter',$('#txt_source_db_type').val())" value="Check Query" />
                                                        <input style="margin-left: 2%;" type="button" id='btn_filtersave' onclick="pplfiltercondsave()" class="save" value="Save" disabled />
                                                    </div>
                                                </div>
                                                <div class="col-md-6">
                                                    <div>
                                                        <h2 style="margin-top: 10px;margin-bottom:0px;text-align: center;font-size: 17px;color: red;font-weight: 700;"> Exclusion</h2>
                                                    </div>
                                                    <div class="row">
                                                        <input style="display:none;" class="form-control" id="txt_rejection_gid" type="text" name="txt_rejection_gid" />
                                                        <label>Rejection Condition</label>
                                                        <span class="mandatory">*</span>
                                                        <textarea class="form-control" type="text" id="txt_rejectioncond" name="txt_rejectioncond" oninput="togglebutton('Rejection')" onclick="document.getElementById('btn_rejectionsave').disabled = true;" style="width:95%;height:175px;color: black;resize: none;"></textarea>
                                                    </div>
                                                    <div class="row" style="margin-top: 2%;">
                                                        <input type="button" id='btn_rjcheckquery' class="save query_clr" onclick="ExcelIsCheckQuery('Rejection',$('#txt_source_db_type').val())" value="Check Query" />
                                                        <input style="margin-left: 2%;" type="button" id='btn_rejectionsave' onclick="pplrejectioncondsave()" class="save" value="Save" disabled />
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="navbar fixed-bottom" style="min-height:0px;"></div>
                                    <input style="float: right;margin-right: 0%;" type="button" onclick="pplsave()" id='btn_nextppl2' name="next" class="next action-button"
                                           value="Next" />
                                    <input style=" float: right;" type="button" name="previous" id="btn_prvs2" class="previous action-button-previous" value="Previous" />
                                </fieldset>

                                <fieldset id="tab4">                                
                                    @await Html.PartialAsync("_dataProcessinglist", Model)
                                    <input style="float: right;margin-right: -0%;" type="button" id='btn_nextppl3' name="next" class="next action-button" value="Next" />
                                    <input style="float: right;margin-right: 1%;" type="button" name="previous" id="btn_prvs3" class="previous action-button-previous" value="Previous" />
                                </fieldset>
                                <fieldset id="tab5">                                    
                                    <div class="form-card" style="height: 64vh;overflow-y: auto;padding: 10px 30px;">
                                        <div>
                                            <label id="lbl_info2" style="color:brown">
                                            </label>
                                        </div>
                                        <div id="div_finalization">

                                            <div class="row" style="margin-top:1%">
                                                <div class="col-md-4">
                                                    <input class="form-control" type="text" id="txt_pplfinalization_gid" name="txt_pplfinalization_gid" style="display:none" />
                                                    <label>Run Type</label>
                                                    <span class="mandatory">*</span>
                                                    <select class="form-control" onchange="schedulecron_cond()" id="run_type" name="run_type">
                                                        <option>--select--</option>
                                                        <option value="On Demand" selected>On Demand</option>
                                                        <option value="Scheduled Run">Scheduled Run</option>
                                                        <option value="Dependent">Dependent</option>
                                                    </select>
                                                </div>

                                                <div class="col-md-4">
                                                    <label>Parent Dataset</label>
                                                    <span id="txt_parentdataset_s" class="mandatory" style="display:none;">*</span>
                                                    <input class="form-control" id="txt_parentdataset" type="text" name="txt_parentdataset" style="display:none;" />
                                                    <select class="form-control" id="parentdataset" name="parentdataset">
                                                        <option value="">-- Select --</option>
                                                    </select>
                                                </div>

                                                <div class="col-md-4" id="Scheduled_expression">
                                                    <label class="form-label">Scheduled Cron Expression</label>
                                                    <span id="txt_cronexpr_s" class="mandatory" style="display:none;">*</span>
                                                    <span class="disabled" id="btn_editscheduler" onclick="scheduler_pop()"> <a> Edit </a></span>
                                                    <input class="form-control" id="txt_cronexpr" type="text" placeholder="Ex: 24-hour format (HH:mm)" name="txt_cronexpr" disabled />
                                                </div>

                                            </div>
                                            <div class="row" style="margin-top:1%">
                                                <div class="col-md-4">
                                                    <label>Extract Mode</label>
                                                    <span id="extract_mode_s" style="display: none;" class="mandatory">*</span>
                                                    <select class="form-control" id="extract_mode" onchange="extracttext_cond()" name="extract_mode">
                                                        <option selected>--select--</option>
                                                        <option value="Incremental records">Incremental records</option>
                                                        <option value="Pull last X days">Pull last X days</option>
                                                        <option value="Pull all records">Pull all records</option>
                                                    </select>
                                                </div>
                                                <div class="col-sm-4">
                                                    <label>Upload Mode</label>
                                                    <span class="mandatory">*</span>
                                                    <select class="form-control" id="upload_mode" onchange="rejectduplicate_cond()" name="upload_mode">
                                                        <option>--select--</option>
                                                        <option selected>Insert or Update based on key</option>
                                                        <option>Insert or Update based on key with log</option>
                                                        <option>Append</option>
                                                        <option>Clean and Insert</option>
                                                    </select>
                                                </div>
                                                <div class="col-sm-4">
                                                    <label>Key Field</label>
                                                    <span id="keyfield_drp_s" style="display:inline;" class="mandatory">*</span>
                                                    <select class="form-control multi-select" id="keyfield_drp" name="keyfield_drp">
                                                    </select>
                                                </div>
                                            </div>
                                            <div class="row" style="margin-top: 1%;">
                                                <div class="col-md-4">
                                                    <label id="div_lblExtractcond">Extract Condition</label>
                                                    <span id="setVal" onclick="SetValuePopUp()"> <a>Set Value </a></span>
                                                    @* <label id="div_lblField" style="display:none; margin-left:10px;">Field</label> *@
                                                    <textarea class="form-control" id="txt_extractcond" onblur="submitBtnCondition()" type="text" name="txt_extractcond" style="width: 353px;height: 113px;resize: none;"></textarea>
                                                </div>

                                                <div class="col-md-4">
                                                    <div class="row" style="margin: -1px;">
                                                        <label class="form-label">Pull last X days</label>
                                                        <span id="txt_pulllstxdays_s" class="mandatory" style="display:none;">*</span>
                                                        <input class="form-control" id="txt_pulllstxdays" value="0" type="text" name="txt_pulllstxdays" maxlength="2" disabled />
                                                    </div>

                                                    <div class="row" style="margin: -1px;">
                                                        <button class="save query_clr" style="margin-top: 5%;" id="btn_fin_chkquery" onclick="IsCheckQuery('ExtractCondition')" type="button" name="btn_fin_chkquery">  Check Query </button>
                                                    </div>
                                                </div>
                                                <div class="col-md-4">
                                                    <div class="row" style="margin: -1px;">
                                                        <div class="row" style="margin-top:1%;margin-left: 0%;margin: -1px;margin-top: 7%;">
                                                            <input type="checkbox" checked id="chkbox_rejduplicate" name="chkbox_rejduplicate" onchange="rejectduplicatedwn()" />
                                                            <label class="form-label">Reject Duplicates</label>
                                                        </div>
                                                        <div class="row" style="margin-top:1%;margin-left: 0%;margin: -1px;">
                                                            <input type="radio" id="rdo_abort1" name="rdo_rej_mode" onclick="rejectduplicatedwn()" />
                                                            <label>Abort on Duplicates</label>
                                                            &nbsp;&nbsp;&nbsp;
                                                            <input type="radio" checked id="rdo_continue1" name="rdo_rej_mode" onclick="rejectduplicatedwn()" />
                                                            <label>Continue with Duplicates </label>
                                                        </div>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                    <input style="float: right;margin-right: 0%;" onclick="Getpplstatus('finsave')" type="button" id="btn_submit" name="next" class="next action-button" value="Submit" />
                                    <input style="float: right;margin-right: 1%;" type="button" name="fin_prvus" id="fin_prvus" class="previous action-button-previous" value="Previous" />
                                </fieldset>
                            </form>
                        </div>
                    </div>
                </div>

            </div>
        </div>
    </div>
    <div>@await Html.PartialAsync("_dataProcessingrules", Model)</div>
    <div class="modal" tabindex="-1" role="dialog" id="viewexcludecolumn" aria-hidden="true">
        <div class="modal-dialog modal-lg" role="dialog">
            <div class="modal-content">
                <div class="modal-body" style="margin-top: -26px;">
                    <div class="row">
                        <div class="col-sm-4">
                        </div>
                        <div class="col-sm-4">
                            <h4 style="font-size: 15px;text-align: center;color: #1a9950;font-weight: 600;">Exclude column</h4>
                        </div>
                        <div class="col-sm-4">
                        </div>
                    </div>
                    <hr style="margin-top:-1px; width:100%;" />
                    <div class="row">

                        <div class="col-md-6">
                            <div>
                                <label class="form-label">
                                    Cleansing Action
                                </label>
                                <select class="form-control" id="fieldtype" name="cleaningaction">
                                    <option value="">-- Select --</option>
                                    <option value="FR">Find and Replace Text</option>
                                    <option value="TT" selected>Truncate Text</option>
                                    <option value="RW">Remove Whitespace</option>
                                    <option value="FRT">Find and Remove Text</option>
                                    <option value="ET">Extract Text</option>
                                    <option value="PS">Add Prefix and Suffix</option>
                                    <option value="CC">Change Case</option>
                                    <option value="VM">Value Mapper</option>
                                    <option value="BN">Boolean Number</option>
                                    <option value="BS">Boolean to String</option>
                                </select>
                            </div>

                        </div>
                        <div class="col-md-6">
                            <div>
                                <label>Choose Fields</label>
                                <select class="form-control" id="fieldtype" name="cleaningaction">
                                    <option value="" selected>-- Select --</option>
                                    <option value="">Bank Name</option>
                                    <option value="">Bank Branch Name</option>
                                    <option value="">IFSC Code</option>
                                    <option value="">Bank Branch Address</option>
                                    <option value="">Rural Urban Branch</option>
                                    <option value="">Pincode</option>
                                    <option value="">created By</option>
                                    <option value="">Entry Code</option>
                                </select>
                            </div>
                        </div>
                    </div>

                    <div class="row" style="padding-bottom:5px;margin-top:5px;padding-left:10px;padding-right:10px">
                        <div class="col-sm-4">
                        </div>
                        <div class="col-sm-4"> </div>
                        <div class="col-sm-4" style="margin-top: 2%;text-align: right;">
                            @* <button type="button" class="btn btn-sm btn-success me-2" style="background: #38b55a;border-color: #38b55a;width:40%">Save</button>&nbsp;&nbsp;&nbsp;
                            <button type="button" class="btn btn-sm btn-success me-2" style="background: red;border-color: red;width:40%" onclick="closeModel()">Cancel</button>
                            *@
                            <input style="float: right;margin-right: 0%;" type="button" id='next' class="save" value="Save" />
                            <input style=" float: right; margin-top: 0%;" type="button" id="btn_prvs4" class="cancel action-button-previous" onclick="closeModel()" value="Cancel" />
                        </div>
                    </div>

                </div>
            </div>
        </div>
    </div>

    <div> @await Html.PartialAsync("_setValues", Model) </div>
    <div> @await Html.PartialAsync("_schedulerexpression", Model) </div>
    <div> @await Html.PartialAsync("_csvColumns", Model) </div>
    <div> @await Html.PartialAsync("_apiColumns", Model) </div>
    <div> @await Html.PartialAsync("_importURL", Model)</div>

    <div class="modal" id="field_mappingPopup">
        <div class="modal-dialog modal-xl">
            <div class="modal-content" style="height:500px;">
                <div class="modal-header">
                </div>
                <div class="modal-body" style="margin-top: -26px;">
                    <div class="row">
                        <div class="col-sm-4">
                        </div>
                        <div class="col-sm-4">
                            <h4 style="font-size: 15px;text-align: center;color: #1a9950;font-weight: 600;">Set Value</h4>
                        </div>
                        <div class="col-sm-4">
                            <i class="bx bx-x cursor-pointer" data-bs-dismiss="modal" style="color: #000000;float:right"></i>
                        </div>
                    </div>
                    <hr style="margin-top:-1px; width:100%;" />
                    <div class="container" style="padding:0px !important;">
                        @await Html.PartialAsync("_setValues", Model)
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Kendo Window -->
    <div id="viewPopupWindow" style="display: none; position: relative;">
        <!-- Close Button (Fixed at Top-Right) -->
        <button id="closePopup" class="custom-close">&times;</button>

        <!-- Scrollable Content -->
        <div class="popup-content">
            <h3 id="popupDatasetName"></h3> <!-- Dataset Name -->
            <pre id="jsonOutput"></pre>
        </div>
    </div>

</body>
</html>

<script>
  const input = document.getElementById('searchInput');
  const dropdown = document.getElementById('dropdownList');
  const hiddenValue = document.getElementById('selectedValue');

  input.addEventListener('focus', () => {
    dropdown.style.display = 'block';
  });

  input.addEventListener('input', () => {
    const filter = input.value.toLowerCase();
    const options = dropdown.querySelectorAll('div');
    options.forEach(option => {
      option.style.display = option.textContent.toLowerCase().includes(filter) ? 'block' : 'none';
    });
  });

  dropdown.addEventListener('click', e => {
    if (e.target.dataset.value) {
      input.value = e.target.textContent;
      hiddenValue.value = e.target.dataset.value;
      dropdown.style.display = 'none';
    }
  });

  document.addEventListener('click', e => {
    if (!e.target.closest('.dropdown-container')) {
      dropdown.style.display = 'none';
    }
  });
</script>

<script>

    $(document).ready(function () {
        let popupWindow = $("#viewPopupWindow").kendoWindow({
            width: "800px",
            height: "500px",
            title: "Dataset Details",
            visible: false,
            modal: true,
            resizable: false
        }).data("kendoWindow");

        // Open Popup Function
        function openViewPopup(datasetNames) {
            var datasetName = datasetNames;
            $("#popupDatasetName").text("Dataset Name: " + datasetName); // Set dataset name
            // Dummy JSON response (Replace with actual API data)
            let apiResponses = JSON.stringify(JSON.parse(apiResponse)[datasetName], null, 4);

            // Show JSON inside the Kendo Window
            $("#jsonOutput").text(apiResponses);

            // Open the Kendo Window
            let popupWindow = $("#viewPopupWindow").data("kendoWindow");
            popupWindow.center().open();
        }

        // Close Button Click Event
        $("#closePopup").on("click", function () {
            popupWindow.close();
        });

        // Make the function globally available
        window.openViewPopup = openViewPopup;
    });

    var _user_code = "";
    //     $(document).on("change", ".k-dropdown", function() {
    //     var selectedValue = $(this).val();
    //     var row = $(this).closest("tr");
    //     var grid = $("#grid").data("kendoGrid");
    //     var dataItem = grid.dataItem(row);
    //     dataItem.set("field_type", selectedValue);  // Update data model with selected value
    // });
    var field_list = [];
    var datasetfiledname = [];
    var dataset_name = [];
    var excel_file = "";
    var excel_path = "";
    var fieldmapping_status = false;
    var isNewDataset = false;
    var iscloneDS = false;
    var ppl_mode = "";
    var hasSourcefield = false;
    var selectedAPIDS = "";
    var ds_name1 = "";
    var selectedDataset = "";
    var dataset_grid1 = [];
    var dateformatfield = [];
    var getppldataset = [];
    var sourceFieldNames = [];
    var isExistingds = false;
    var has_fieldmapsaved = "false";
    var dskeyfield;
    var showplusIcon = false;
    var gridhasChange = false;
    var tabRedirection = false;
    var hasActiveDataset = false;
    $(document).ready(function () {
        sessionStorage.removeItem('DS');
        ppl_mode = sessionStorage.getItem("ppl_mode");
        field_list= cmbsourcefield();
        _user_code = sessionStorage.getItem("userCode");
        $("#selectedfilename").val("");
        if(ppl_mode == 'Edit'){
            var getdsgridelement = document.getElementById("ds_grid");
            getdsgridelement.style.display = "block";
            Newdatasetgrid(getppldataset);
        }  else {
            var getdsgridelement = document.getElementById("ds_grid");
            getdsgridelement.style.display = "block";
            Newdatasetgrid([]);
        }
        document.getElementById("rdo_new_ds").checked = true;
        toggleDivs('new');
        //loadgrid([]);
        loadapigrid([]);
        loaddatasetgrid([]);
        var apiResponse = null;
        SrcCsvGrid([]);
        SrcApiGrid([]);
        $("#filters_conf").hide();
        RejectionGrid([]);
        $("#rejection_conf").hide();
        $("#dataprocessing_conf").hide();
        FilterGrid([]);
        ValidationGrid([]);
       // loadparenttrgtbl('', '');
        $("#updatedtimestamp").show();
        fetchppl(@ViewBag.id);
        var inputValue = '';
        document.getElementById('setVal').classList.remove('disabled');
        document.getElementById('setVal').classList.add('set_val');
        document.getElementById('txt_cronexpr').addEventListener('blur', function () {
            inputValue = this.value;
            var regex = /^(?:2[0-3]|[01][0-9]):[0-5][0-9]$/; // Regex for 24-hour format (HH:mm)
            if (!regex.test(inputValue)) {
                jAlert("Please enter a valid time in 24-hour format (HH:mm)", "Connector");
                //this.value = ''; // Clear the input field if the input is invalid
                //inputValue = '';
                return;
            }
        });
        // Add keypress event listener to the input field
        $('#txt_pulllstxdays').keypress(function (event) {
            // Get the keycode of the pressed key
            var keycode = event.keyCode ? event.keyCode : event.which;

            // Allow only numeric input (48-57 are keycodes for digits 0-9)
            if (!(keycode >= 48 && keycode <= 57)) {
                event.preventDefault(); // Prevent the default action
            }
        });
        GetDrpDownDateList();
        GetDrpDownTimeList();
    });
    var current_fs, next_fs, previous_fs; //fieldsets
    var opacity;

    $(".next").click(function () {

        current_fs = $(this).parent();
        next_fs = $(this).parent().next();

       var grid = $("#grid_dataset").data("kendoGrid");
       if(grid != null) {
       var selectedRow = grid.dataSource._data;
        if (selectedRow.length > 0) {
            var dataItem = selectedRow[0];
            var datasetCode = dataItem.dataset_code;
            if(dataItem.selected == true) {
            sessionStorage.setItem("DS", JSON.stringify(dataItem));
            } else {

            }

          }
       }


        if ($("#txtppl_name").val() != "") {

            /*if ($('#cc_progressbar li.active').attr('id') != "templateSelection" && $("fieldset").index(current_fs) == 1) {
                $("#progressbar li").eq($("fieldset").index(next_fs)).addClass("active");
                $("#progressbar li").eq($("fieldset").index(current_fs)).removeClass("active");
            }*/
            if ($('#cc_progressbar li.active').attr('id') == "templateSelection" && $("fieldset").index(current_fs) == 1){

            }else{
                $("#progressbar li").eq($("fieldset").index(next_fs)).addClass("active");
                $("#progressbar li").eq($("fieldset").index(current_fs)).removeClass("active");
            }

            if($("#txtds_code").val()) {
                Processing(next_fs);
            }

            var checkbox = document.getElementById("chkbox_rejduplicate");
            var upldmode = document.getElementById("upload_mode");
            var v_upldmode = upldmode.value;
            var ext_mode = document.getElementById("extract_mode");
            var v_ext_mode = ext_mode.value;
            var runtype = document.getElementById("run_type");
            var v_runtype = runtype.value;
            var v_cron_expression = $("#txt_cronexpr").val();
            var v_lastxdays = $("#txt_pulllastxdays").val();
            var parentdataset = document.getElementById("parentdataset");
            var v_parentdataset = parentdataset.value;
            var radio3 = document.getElementById("rdo_abort1");
            var radio4 = document.getElementById("rdo_continue1");
            var v_duplicate_mode = "";

            if (radio3.checked) {
                v_duplicate_mode = "Abort on Duplicates";
            } else if (radio4.checked) {
                v_duplicate_mode = "Continue With Duplicates";
            }

            if (current_fs.context.value == "Submit" && checkbox.checked == true && $('#keyfield_drp').val() == undefined) {
                // Stay on same screen
            }
            else if (current_fs.context.value == "Submit" && v_runtype == "--select--") {
                jAlert("Please Select the runtype..!", "Connector");
                return;
                // Stay on same screen
            }
            else if (current_fs.context.value == "Submit" && v_runtype == "Scheduled Run" && v_cron_expression == "") {
                jAlert("Cron Expression Cannot be blank.", "Connector");
                return;
                // Stay on same screen
            }
            else if (current_fs.context.value == "Submit" && v_runtype == "Dependent" && v_parentdataset == "") {
                jAlert("Please Select the Parent Dataset..!", "Connector");
                return;
                // Stay on same screen
            }
            else if (current_fs.context.value == "Submit" && $("#txt_source_db_type").val() == "MySql" && v_ext_mode == "--select--") {
                jAlert("Please Select the Extract Mode..!", "Connector");
                return;
                // Stay on same screen
            }
            else if (current_fs.context.value == "Submit" && v_upldmode == "--select--") {
                jAlert("Please Select the Upload Mode..!", "Connector");
                return;
                // Stay on same screen
            }
            else if (current_fs.context.value == "Submit" && (v_upldmode == "Insert or Update based on key" || v_upldmode == "Insert or Update based on key with log")
                && $("#keyfield_drp").val() == undefined) {
                jAlert("Please Select the Keyfield..!", "Connector");
                return;
                // Stay on same screen
            }

            else if (current_fs.context.value == "Submit" && (v_ext_mode == "Incremental records" || v_ext_mode == "Pull last X days") && $('#txt_extractcond').val().trim() == "") {
                jAlert("Extract condition Cannot be blank.", "Connector");
                return;
                // Stay on same screen
            }
            else if (current_fs.context.value == "Submit" && v_ext_mode == "Pull last X days" && parseInt($("#txt_pulllstxdays").val(), 10) <= 0) {
                jAlert("Pull last X days Cannot be blank.", "Connector");
                return;
                // Stay on same screen
            }
            else if (current_fs.context.value == "Submit" && v_upldmode == "Clean and Insert" &&
                (checkbox.checked == false && v_duplicate_mode != "Abort on Duplicates") &&
                $("#keyfield_drp").val() != undefined) {
                jAlert("Please Check the Reject Duplicates (or) remove the keyfield..!", "Connector");
                return;
                // Stay on same screen
            }
            else if (current_fs.context.value == "Submit" && v_duplicate_mode == "Abort on Duplicates" && multselectedval == "") {
                jAlert("Please Select the Keyfield..!", "Connector");
                return;
            }
             else if (current_fs.context.value == "Next" && current_fs.context.id == 'btn_nextppl1' && selectedDataset == "") {
                document.getElementById('pipelne').classList.remove('active');
                document.getElementById('datasource').classList.add('active');
                document.getElementById('preprocess').classList.remove('active');
                document.getElementById('processing').classList.remove('active');
                document.getElementById('postprocessing').classList.remove('active');
                $("#tab1").hide();
                $("#tab2").show();
                $("#tab3").hide();
                $("#tab4").hide();
                $("#tab5").hide();
                //loadexistingdataset("");

             } else if (current_fs.context.value == "Next" && current_fs.context.id == 'btn_nextppl2' && gridhasChange == true) {
                 document.getElementById('pipelne').classList.remove('active');
                document.getElementById('datasource').classList.remove('active');
                document.getElementById('preprocess').classList.add('active');
                document.getElementById('processing').classList.remove('active');
                document.getElementById('postprocessing').classList.remove('active');
                $("#tab1").hide();
                $("#tab2").hide();
                $("#tab3").show();
                $("#tab4").hide();
                $("#tab5").hide();
             } else if(current_fs.context.value == "Previous" && current_fs.content.id == 'btn_prvs2' && gridhasChange == true) {
                 document.getElementById('pipelne').classList.remove('active');
                document.getElementById('datasource').classList.remove('active');
                document.getElementById('preprocess').classList.add('active');
                document.getElementById('processing').classList.remove('active');
                document.getElementById('postprocessing').classList.remove('active');
                $("#tab1").hide();
                $("#tab2").hide();
                $("#tab3").show();
                $("#tab4").hide();
                $("#tab5").hide();
             }  else {
                current_fs.hide();
                next_fs.show();
                current_fs.animate({ opacity: 0 }, {
                    step: function (now) {
                        opacity = 1 - now;

                        current_fs.css({
                            'display': 'none',
                            'position': 'relative'
                        });
                        next_fs.css({ 'opacity': opacity });
                    },
                });
            }
        }
    });

    $(".previous").click(function () {
        current_fs = $(this).parent();
        previous_fs = $(this).parent().prev();

        if($('#cc_progressbar li.active').attr('id') != "datasetSelection"){
                $("#progressbar li").eq($("fieldset").index(previous_fs)).addClass("active");
                $("#progressbar li").eq($("fieldset").index(current_fs)).removeClass("active");
        }

        if(current_fs.context.value == "Previous" && current_fs[0].id == 'tab3' && gridhasChange == true) {
                document.getElementById('pipelne').classList.remove('active');
                document.getElementById('datasource').classList.remove('active');
                document.getElementById('preprocess').classList.add('active');
                document.getElementById('processing').classList.remove('active');
                document.getElementById('postprocessing').classList.remove('active');
                $("#tab1").hide();
                $("#tab2").hide();
                $("#tab3").show();
                $("#tab3").addClass("show-tab-important");
                $("#tab4").hide();
                $("#tab5").hide();
        } else if(current_fs.context.value == "Previous" && current_fs[0].id == 'tab3' && gridhasChange == false) {
            document.getElementById('pipelne').classList.remove('active');
            document.getElementById('datasource').classList.add('active');
            document.getElementById('preprocess').classList.remove('active');
            document.getElementById('processing').classList.remove('active');
            document.getElementById('postprocessing').classList.remove('active');
            $("#tab1").hide();
            $("#tab2").show();
            $("#tab2").addClass("show-tab-important");
            $("#tab3").hide();
            $("#tab3").removeClass("show-tab-important");
            $("#tab4").hide();
            $("#tab5").hide();
        }else if(current_fs.context.value == "Previous" && current_fs[0].id == 'tab2' && $('#cc_progressbar li.active').attr('id') == 'datasetSelection') {

                $('#cc_progressbar li').removeClass('active');
                $('#templateSelection').addClass('active');
                $('#templateSelection_conf').show();
                $('#datasetSelection_conf').hide();
                $("#tab1").hide();
                $("#tab1").removeClass("show-tab-important");
                $("#tab2").show();
                $("#tab2").addClass("show-tab-important");
                $("#tab3").hide();
                //$("#tab3").removeClass("show-tab-important");
                $("#tab4").hide();
                $("#tab5").hide();
                fetchppl($("#txt_ppl_gid").val());
        } else if (current_fs.context.value == "Previous" && current_fs[0].id == 'tab2' && $('#cc_progressbar li.active').attr('id') == 'templateSelection') {
            $('#cc_progressbar li').removeClass('active');
            $('#templateSelection').removeClass('active');
            $('#templateSelection_conf').hide();
            $('#datasetSelection_conf').hide();
            $("#tab1").show();
            $("#tab1").addClass("show-tab-important");
            $("#tab2").hide();
            $("#tab2").removeClass("show-tab-important");
            $("#tab3").hide();
            $("#tab4").hide();
            $("#tab5").hide();
        }
        else
        {
            current_fs.hide();
            previous_fs.show();

            current_fs.animate({ opacity: 0 }, {
                step: function (now) {
                opacity = 1 - now;
                current_fs.css({
                    'display': 'none',
                    'position': 'relative'
                });
            previous_fs.css({ 'opacity': opacity });
            },
            });

        }

        if(current_fs[0].id == 'tab3' && isNewDataset == true)
        {
                isNewDataset = false;
                var checkbox = document.querySelector('input[type="checkbox"]');
                checkbox.checked = false;
        }
    });

    $('.radio-group .radio').click(function () {
        $(this).parent().find('.radio').removeClass('selected');
        $(this).addClass('selected');
    });

    $(".submit").click(function () {
        return false;
    })

    // Multiselect for pulldays keyfield
    var dspdkeyfield = new kendo.data.DataSource({
        data: [
            { Keyfield_name: "insert_date" },
            { Keyfield_name: "update_date" },
            { Keyfield_name: "row_timestamp" }
        ],
        sort: { field: "Keyfield_name", dir: "asc" }
    });

    $("#pulldays_kf_drp").kendoMultiSelect({
        dataSource: dspdkeyfield,
        autoHeight: true,
        autoClose: false,
        filter: "contains",
        dataTextField: "Keyfield_name", // Define the dataTextField to display the 'Keyfield_name' property in the dropdown
        noDataTemplate: $("#noDataTemplate").html()
    });

    // Multiselect for updatetimestamp
    var dsupdatetimestamp = new kendo.data.DataSource({
        data: [
            { Keyfield_name: "insert_date" },
            { Keyfield_name: "update_date" },
            { Keyfield_name: "accbal_gid" }
        ],
        sort: { field: "Keyfield_name", dir: "asc" }
    });

    $("#updtimestamp").kendoMultiSelect({
        dataSource: dsupdatetimestamp,
        autoHeight: true,
        autoClose: false,
        filter: "contains",
        dataTextField: "Keyfield_name", // Define the dataTextField to display the 'Keyfield_name' property in the dropdown
        noDataTemplate: $("#noDataTemplate").html()
    });

    $("#keyfield_drp").kendoMultiSelect({
        dataSource: dskeyfield,
        autoHeight: true,
        autoClose: false,
        filter: "contains",
        dataTextField: "name", // Define the dataTextField to display the 'Keyfield_name' property in the dropdown
        dataValueField: "id",
        noDataTemplate: $("#noDataTemplate").html()
    });

    // });
</script>
<script>
       function GetSourceDBType(conn_code) {
           if (conn_code != "" && conn_code != null && conn_code != undefined) {
               $.ajax({
                   type: 'GET',
                   url: '@Url.Action("GetsrcDbType", "Pipeline")?Connection_code=' + conn_code,
                   //url: "../Pipeline/GetsrcDbType?Connection_code=" + conn_code,
                   contentType: false,
                   processData: false,
                   cache: false,
                   success: function (response) {
                       $("#imgmysql").attr("hidden", true);
                       $("#imgpostgres").attr("hidden", true);
                       $("#imgcsv").attr("hidden", true);
                       $("#imgexcel").attr("hidden", true);
                       $("#div_delimited").hide();
                       $("#div_csv").hide();
                       document.getElementById('txt_extractcond').disabled = false;
                       document.getElementById('extract_mode').disabled = false;
                       document.getElementById("extract_mode_s").style.display = "inline";
                       document.getElementById('btn_fin_chkquery').disabled = false;
                       $("#txt_source_db_type").val(response.source_db_type);
                       if (response.source_db_type == "MySql") {
                           $("#div_srcdbname").show();
                           $("#div_tvq").show();
                           $("#grid_tvc").show();
                           $("#div_fileinput").hide();
                           $("#div_downloadtemp").hide();
                           $("#div_excel").hide();
                           $("#div_csv").hide();
                           $("#imgmysql").removeAttr("hidden");
                           $("#img_div").show();
                           $("#txt_sheetname").val("");
                           $("#txt_fileextension").val("");
                           $("#div_apiurl").hide();
                           $("#div_api").hide();
                           document.getElementById("selectedfilename").textContent = "";
                       }
                       else if (response.source_db_type == "Postgres") {
                           $("#div_srcdbname").show();
                           $("#databasename").val("");
                           $("#div_tvq").show();
                           $("#src_tblviewquery").val("");
                           $("#div_fileinput").hide();
                           $("#div_downloadtemp").hide();
                           $("#div_excel").hide();
                           $("#div_csv").hide();
                            $("#div_api").hide();
                            $("#div_apiurl").hide();
                           document.getElementById("selectedfilename").textContent = "";
                           $("#imgpostgres").removeAttr("hidden");
                       }
                       else if (response.source_db_type == "CSV") {
                           $("#div_srcdbname").hide();
                           $("#databasename").val("");
                           $("#div_tvq").hide();
                           $("#src_tblviewquery").val("");
                           $("#div_fileinput").hide();
                           $("#div_downloadtemp").hide();
                           $("#div_excel").hide();
                           $("#grid_tvc").show();
                           $("#div_csv").show();
                           $("#div_delimited").show();
                            $("#div_apiurl").hide();
                            $("#div_api").hide();
                           $("#imgcsv").removeAttr("hidden");
                       }
                       else if (response.source_db_type == "Excel") {
                           $("#div_srcdbname").hide();
                           $("#databasename").val("");
                           $("#div_tvq").hide();
                           $("#grid_tvc").show();
                           $("#src_tblviewquery").val("");
                           $("#div_csv").hide();
                           $("#div_fileinput").show();
                           $("#div_downloadtemp").show();
                            $("#div_api").hide();
                           $("#div_apiurl").hide();
                           $("#imgexcel").removeAttr("hidden");
                        //  document.getElementById("btn_nextppl1").disabled = true;
                           document.getElementById('txt_extractcond').disabled = true;
                           document.getElementById('btn_fin_chkquery').disabled = true;
                           document.getElementById('extract_mode').disabled = true;
                           document.getElementById("extract_mode_s").style.display = "none";
                       }
                       else if (response.source_db_type == "API") {
                           $("#div_srcdbname").hide();
                           $("#databasename").val("");
                           $("#div_tvq").hide();
                           $("#src_tblviewquery").val("");
                           $("#div_csv").hide();
                           $("#div_fileinput").hide();
                           $("#div_downloadtemp").hide();
                           $("#div_excel").hide();
                           $("#div_selectfile").hide();
                           $("#div_apiurl").show();
                           $("#div_api").show();
                       }
                   },
                   error: function (er) {
                       jAlert(er, "Error");
                   }
               });
           }
       }
       var path = "";
       var sheet_name = "";
       var sheet_name1 = "";
       var previous_targetds = "";

       function fetchppl(id) {
           drpkeyfield();
           var id = @ViewBag.pipeline_id;
           if (id == "" || id == "0") {
               id = $('#txt_ppl_gid').val();
                $('#txtppl_code').val("");
                $('#txtppl_status').val("Draft");
           }
           else {
              // document.getElementById("btn_nextppl").disabled = true;
             //  document.getElementById("btn_nextppl1").disabled = true;
           }
           if (id != "") {
               $.ajax({
                   type: "GET",
                   url: '@Url.Action("Readpipeline", "Pipeline")?id=' + id,
                   dataType: "json",
                   contentType: 'application/json; charset=utf-8',
                   success: function (response) {
                       hasActiveDataset = response.haveActiveDataset;
                       $('#txt_ppl_gid').val(response.pipeline_gid);
                       $('#txt_ppl_code').val(response.pipeline_code);
                       $('#txt_ppl_status').val(response.pipeline_status);
                       $('#txtppl_code').val(response.pipeline_code);
                       $('#txtppl_status').val(response.pipeline_status);
                       $('#txtpipelinecode').val(response.pipeline_code);
                       $('#txt_fileextension').val(response.source_file_name);
                      // $('#txt_macrofileextension').val(response.macro_file_name);
                       $('#txtppl_name').val(response.pipeline_name);
                       $('#txtppl_desc').val(response.pipeline_desc);
                       var defaultValue = response.connection_code;
                       $('#connectors').val(defaultValue);
                       if (defaultValue) {
                           $('#connectors').prop('disabled', true);
                       }
                       if (defaultValue != "" && defaultValue != null && defaultValue != undefined) {
                           GetSourceDBType(defaultValue);
                           //getdblist(defaultValue);
                           var connection_code = defaultValue;
                           $("#fileInput").addClass('no-file-chosen');
                           var e = document.getElementById("connectors");
                           var value = e.value;
                           var text = e.options[e.selectedIndex].text;

                           if (text == "-- Select --") {
                               // $("#div_fileinput").hide();
                               // $("#grid_tvc").hide();
                               // $("#div_selectfile").hide();
                               // $("#img_div").hide();
                               // $("#div_srcdbname").hide();
                               // $("#div_tvq").hide();
                               //document.getElementById("btn_nextppl1").disabled = true;
                           }
                           else {
                               //document.getElementById("btn_nextppl1").disabled = false;
                               $.ajax({
                                   type: "GET",
                                   url: '@Url.Action("Getconndblist", "Pipeline")?connection_code=' + connection_code,
                                   //url: "../Pipeline/Getconndblist?connection_code=" + connection_code,
                                   dataType: "json",
                                   contentType: 'application/json; charset=utf-8',
                                   success: function (data) {
                                       var select = $("#databasename");

                                       // Clear existing options
                                       select.empty();
                                       // Add new options from the JSON data
                                       select.append($("<option>").attr("value", "").text("-- Select --"));

                                       $.each(data, function (index, item) {
                                           select.append($("<option>").attr("value", item.name).text(item.name));
                                       });


                                       var db_name = response.db_name;
                                       $("#txt_table_view_query_type").val(response.table_view_query_type);
                                       if (response.table_view_query_type == "Q") {
                                           $('#txt_cusquery').val(response.table_view_query_desc);
                                       }
                                       $("#txt_trgdataset").val(response.target_dataset_code);
                                       previous_targetds = response.target_dataset_code;
                                       // loadtrgtbl(response.target_dataset_code, response.target_dataset_code);
                                       $("#txt_table_view_query_desc").val(response.table_view_query_desc);
                                       $('#databasename').val((response.db_name));
                                       $('#src_tblviewquery').val(response.table_view_query_type);
                                       $('#txt_tableview_desc').val(response.table_view_query_desc);
                                       fetchpplcond("Filter");
                                       fetchpplcond("Rejection");
                                       fetchpplcond("Validation");
                                       checkTVQ(response.table_view_query_type);
                                       if ((response.sheet_name) != null && (response.sheet_name) != "") {
                                           var extension = response.source_file_name;
                                           var lastIndex = extension.lastIndexOf(".");
                                           if (lastIndex !== -1) {
                                               var fileexts = extension.substring(lastIndex);
                                           }
                                           path = response.file_path + response.pipeline_code + fileexts;//"D:\\Mohan\\Gitlab\\Github\\FlexiConnectorsWeb\\wwwroot\\uploads\\" + response.pipeline_code + fileexts;
                                           sheet_name = response.sheet_name;
                                           if (fileexts != null || fileexts != undefined) {
                                               getexcelsheetlist(path, '');
                                           }
                                       }
                                       TablefieldGriddata();
                                       GetSrcCsvlist(response.pipeline_code);
                                       GetSrcApilist(response.pipeline_code);
                                       fetchpplfinalization();
                                       fetchpplcsvheader();
                                       fetchpplapiheader();
                                       extractcond_label();
                                       loadgriddataprocessing([]);
                                       document.getElementById("btn_nextppl").disabled = false;
                                      // document.getElementById("btn_nextppl1").disabled = false;
                                       $('#txt_sheetname').val(response.sheet_name);
                                       document.getElementById("selectedfilename").textContent = response.source_file_name;
                                      // document.getElementById("selectedmacrofilename").textContent = response.macro_file_name ? response.macro_file_name : "";
                                       const filename = document.getElementById("selectedfilename").textContent.trim();
                                       //const macroFilename = document.getElementById("selectedmacrofilename").textContent.trim();
                                       const button = document.getElementById("temp_download");
                                      // const macroButton = document.getElementById("macro_temp_download");                                   
                                       if (filename) {
                                           button.disabled = false;
                                       } else {
                                           button.disabled = true;
                                       }      
                                       // if (macroFilename) {
                                       //     macroButton.disabled = false;
                                       // } else {
                                       //     macroButton.disabled = true;
                                       // }
                                       if (response.source_file_name == "") {
                                           $("#fileInput").removeClass('no-file-chosen');

                                       } else {
                                           $("#div_selectfile").show();
                                           $("#fileInput").addClass('no-file-chosen');
                                           document.getElementById("selectedfilename").style.setProperty("margin-bottom", "0px", "important");
                                       }
                                       // if (response.macro_file_name == "") {
                                       //     $("#fileInput_macro").removeClass('no-file-chosen');
                                       // } else {
                                       //     $("#fileInput_macro").addClass('no-file-chosen');
                                       // }
                                   },
                                   error: function (er) {
                                       jAlert(er, "Error");
                                   }
                               });
                           }
                       }else
                       {
                            $("#div_srcdbname").hide();
                            $("#div_tvq").hide();
                            $("#div_apiurl").hide();
                            $("#div_fileinput").hide();
                            $("#div_delimited").hide();
                            $("#div_selectfile").hide();
                            $("#div_downloadtemp").hide();
                            $("#img_div").hide();
                            $("#grid_tvc").hide();
                            document.getElementById("btn_nextppl1").disabled = true;
                       }

                       if ($('#txt_ppl_status').val() === 'Active') {
                           $('#connectors').prop('disabled', true);
                       }
                   },
                   error: function (er) {
                       jAlert(er, "Error");
                   }
               });
           }
       }

       function SrcTableGrid(data1) {
           try {
               $("#srcTableGrid").remove();
               $('#srctblsearch').append('<div id="srcTableGrid" style="width: 96%; height: 350px !important; margin-top: 15px;margin-left: 0px;"></div>');
               $("#srcTableGrid").kendoGrid({
                   dataSource: {
                       data: data1,
                       schema: {
                           model: {
                               fields: {
                                   name: { type: "string" },
                                   Action: { type: "boolean" },
                               }
                           }
                       },
                       pageSize: 2000,
                   },
                   height: 306,
                   width: 1058,
                   pageable: true,
                   sortable: true,
                   filterable: true,
                   selectable: "single",
                   columns: [
                       {
                           field: "Action",
                           title: "Select", // Change column title
                           template: '<input type="radio" name="radioGroup" #= Action ? "checked" : "" # onclick="TableselectRow(this)" />', // Add radio button template
                           sortable: false,
                           filterable: false,
                           width: 50
                       },
                       {
                           field: "name",
                           title: "Table Name",
                           width: 200
                       }],
                   editable: "inline",
                   dataBound: function () {
                       selectRadioButtonByValue_tbl();
                       // Iterate through each row and set background color based on the checked radio button
                       $("#srcTableGrid tbody tr").each(function () {
                           var row = $(this);
                           var radio = row.find('input[name="radioGroup"]');

                           if (radio.prop("checked")) {
                               // Set the background color for the checked row
                               row.addClass("checked-row-background");
                           } else {
                               // Remove background color for other rows
                               row.removeClass("checked-row-background");
                           }
                       });
                   }

               });
           }
           catch (err) {
               jAlert(er, "Error");
           }
       }

       function selectRadioButtonByValue_tbl() {
           var grid = $("#srcTableGrid").data("kendoGrid");
           var dataSource = grid.dataSource;

           for (var i = 0; i < dataSource.total(); i++) {
               var dataItem = dataSource.at(i);
               if (dataItem.name === $('#txt_tableview_desc').val()) {
                   var row = grid.table.find("tr")[i];
                   var radio = $(row).find("input[type='radio']");
                   radio.prop("checked", true);
                   break; // Exit the loop once the radio button is found and selected
               }
               //else{
               //    $("#srcTableGrid input[type='radio']:first").prop('checked', true);
               //}
           }
       }

       function SrcViewGrid(data1) {
           try {
               $("#SrcViewGrid").remove();
               $('#srcviewsearch').append('<div id="SrcViewGrid" style="width: 98%; height: 350px !important; margin-top: 15px;margin-left: 0px;"></div>');
               $("#SrcViewGrid").kendoGrid({
                   dataSource: {
                       data: data1,
                       schema: {
                           model: {
                               fields: {
                                   name: { type: "string" },
                                   Action: { type: "boolean" },
                               }
                           }
                       },
                       pageSize: 2000,
                   },
                   height: 306,
                   width: 1058,
                   pageable: true,
                   sortable: true,
                   filterable: true,
                   selectable: "single",
                   columns: [
                       {
                           field: "Action",
                           title: "Select", // Change column title
                           template: '<input type="radio" name="radioGroup1" #= Action ? "checked" : "" # onclick="ViewselectRow(this)" />', // Add radio button template
                           sortable: false,
                           filterable: false,
                           width: 50
                       },
                       {
                           field: "name",
                           title: "View Name",
                           width: 200
                       }],
                   editable: "inline",
                   dataBound: function () {
                       selectRadioButtonByValue_view();
                       $("#SrcViewGrid tbody tr").each(function () {
                           var row = $(this);
                           var radio = row.find('input[name="radioGroup1"]');

                           if (radio.prop("checked")) {
                               // Set the background color for the checked row
                               row.addClass("checked-row-background");
                           } else {
                               // Remove background color for other rows
                               row.removeClass("checked-row-background");
                           }
                       });
                   }
                   // editable: false,
               });
           }
           catch (err) {
               jAlert(er, "Error");
           }
       }

       function SrcExcelGrid(data1) {
           try {
               $("#SrcExcelGrid").remove();
               $('#srcexcelsearch').append('<div id="SrcExcelGrid" style="width: 98%; height: 350px !important; margin-top: 15px;margin-left: 0px;"></div>');
               $("#SrcExcelGrid").kendoGrid({
                   dataSource: {
                       data: data1,
                       schema: {
                           model: {
                               fields: {
                                   name: { type: "string" },
                                   Action: { type: "boolean" },
                               }
                           }
                       },
                       pageSize: 2000,
                   },
                   height: 306,
                   width: 1058,
                   pageable: true,
                   sortable: true,
                   filterable: true,
                   selectable: "single",
                   columns: [
                       {
                           field: "Action",
                           title: "Select", // Change column title
                           template: '<input type="radio" name="radioGroup2" #= Action ? "checked" : "" # onclick="ExcelselectRow(this)" />', // Add radio button template
                           sortable: false,
                           filterable: false,
                           width: 50
                       },
                       {
                           field: "name",
                           title: "Sheet Name",
                           width: 200
                       }],
                   editable: "inline",
                   dataBound: function () {
                       selectRadioButtonByValue_excel();
                   }
                   // editable: false,
               });
           }
           catch (err) {
               jAlert(er, "Error");
           }
       }

       function selectRadioButtonByValue_view() {
           var grid = $("#SrcViewGrid").data("kendoGrid");
           var dataSource = grid.dataSource;

           for (var i = 0; i < dataSource.total(); i++) {
               var dataItem = dataSource.at(i);
               if (dataItem.name === $('#txt_tableview_desc').val()) {
                   var row = grid.table.find("tr")[i];
                   var radio = $(row).find("input[type='radio']");
                   radio.prop("checked", true);
                   break; // Exit the loop once the radio button is found and selected
               }
               //else{
               //    $("#srcTableGrid input[type='radio']:first").prop('checked', true);
               //}
           }
       }

       function selectRadioButtonByValue_excel() {
           var grid = $("#SrcExcelGrid").data("kendoGrid");
           var dataSource = grid.dataSource;

           for (var i = 0; i < dataSource.total(); i++) {
               var dataItem = dataSource.at(i);
               if (dataItem.name === $('#txt_sheetname').val()) {
                   var row = grid.table.find("tr")[i];
                   var radio = $(row).find("input[type='radio']");
                   radio.prop("checked", true);
                   break; // Exit the loop once the radio button is found and selected
               }
           }
       }

       function TableselectRow(radio) {
          // document.getElementById("btn_nextppl1").disabled = false;
           var grid = $("#srcTableGrid").data("kendoGrid");
           var dataItem = grid.dataItem($(radio).closest("tr"));
           dataItem = dataItem.name;
           return dataItem;
       }

       function ViewselectRow(radio1) {
          // document.getElementById("btn_nextppl1").disabled = false;
           var grid1 = $("#SrcViewGrid").data("kendoGrid");
           var dataItem1 = grid1.dataItem($(radio1).closest("tr"));
           dataItem1 = dataItem1.name;
           return dataItem1;
       }

       function ExcelselectRow(radio2) {
            if(hasActiveDataset == true){
                let text = "On changing Template (Expression, Inclusion,\n" +
                "Rejection, Validation, Conversion Rules) will be deleted.\n " +
                " Are You sure to change the Template ?  ";
                radio2.checked = false;
                jConfirm(text, "Flexi Connector", function (f) {
                if (f == true) {
                        var pipelineCode = $('#txt_ppl_code').val();
                        var data = {};
                        data.dataset_systemflag = "";
                        data.pipelinedet_id = 0;
                        data.pipeline_code = pipelineCode;
                        data.dataset_name = "",
                        data.datasetCode = "";
                        data.dataset_id = 0;
                        data.dataset_category = "",
                        data.clone_dataset = "";
                        data.active_status = "";
                        data.inactive_reason = "";
                        data.in_action = "EXCELCHANGE";
                        data.in_action_by =_user_code;
                        data.pipelinedet_dataset_type = $('input[name="rdo_dsmode"]:checked').val();
                        $.ajax({
                        type: "Post",
                        url: '@Url.Action("datasetheader", "Pipeline")',
                        data: JSON.stringify(data),
                        dataType: "json",
                        contentType: 'application/json; charset=utf-8',
                        success: function (response) {
                            var res = JSON.parse(response);
                               if(res.length >= 0 && res[0].out_result == 1){
                                radio2.checked = true;
                                jAlert(res[0].out_msg, "Connector");
                                   var grid2 = $("#SrcExcelGrid").data("kendoGrid");
                                   var dataItem2 = grid2.dataItem($(radio2).closest("tr"));
                                   dataItem2 = dataItem2.name;
                                   ds_name1 = "Sheet1";
                                   const input = $('#fileInput').val();
                                   var fileext_val = $('#txt_fileextension').val();
                                   if (fileext_val == "") {
                                       fileext_val = input.toString();
                                   }
                                   var extension = fileext_val;
                                   var lastIndex = extension.lastIndexOf(".");
                                   if (lastIndex !== -1) {
                                       var fileexts = extension.substring(lastIndex);
                                   }
                                   var filename = $('#txt_ppl_code').val() + fileexts;
                                   var formData = new FormData();
                                   formData.append('file_Paths', input);
                                   formData.append('sheetName', dataItem2);
                                   formData.append('filename', filename);
                                   $.ajax({
                                       url: '@Url.Action("validatefile", "Pipeline")',
                                       type: 'Post',
                                       data: formData,
                                       processData: false,
                                       contentType: false,
                                       success: function (response) {
                                           if (response == true) {
                                               $('#txt_sheetname').val(dataItem2);
                                           } else {
                                              document.getElementById("btn_nextppl1").disabled = true;
                                               jAlert("sheet has no record..!", "Connector");
                                           }
                                       },
                                       error: function (er) {
                                           jAlert(er, "Error");
                                       }
                                   });
                                  }
                            },
                            error: function (er) {
                                jAlert(er, "Error");
                            }
                        });
                    } 
                    else {
                        const gridInstance = $("#SrcExcelGrid").data("kendoGrid");
                        if (gridInstance) {
                            gridInstance.dataSource.read();
                            gridInstance.refresh(); 
                        }
                    }
                });
           } else {
           var ppl_code = $('#txt_ppl_code').val();
           var grid2 = $("#SrcExcelGrid").data("kendoGrid");
           var dataItem2 = grid2.dataItem($(radio2).closest("tr"));
           dataItem2 = dataItem2.name;
           ds_name1 = "Sheet1";
           const input = $('#fileInput').val();
           var fileext_val = $('#txt_fileextension').val();
           if (fileext_val == "") {
               fileext_val = input.toString();
           }
           var extension = fileext_val;
           var lastIndex = extension.lastIndexOf(".");
           if (lastIndex !== -1) {
               var fileexts = extension.substring(lastIndex);
           }
           var filename = $('#txt_ppl_code').val() + fileexts;
           var formData = new FormData();
           formData.append('file_Paths', input);
           formData.append('sheetName', dataItem2);
           formData.append('filename', filename);
           $.ajax({
               url: '@Url.Action("validatefile", "Pipeline")',
               type: 'Post',
               data: formData,
               processData: false,
               contentType: false,
               success: function (response) {
                   if (response == true) {
                       $('#txt_sheetname').val(dataItem2);
                   } else {
                      document.getElementById("btn_nextppl1").disabled = true;
                       jAlert("sheet has no record..!", "Connector");
                   }
               },
               error: function (er) {
                   jAlert(er, "Error");
               }
           });
          }
           
       }

       function TablefieldGriddata() {
           var ppl_code = $('#txt_ppl_code').val();
           $.ajax({
               type: 'GET',
               url: '@Url.Action("Readpplfieldmapping", "Pipeline")?pipeline_code=' + ppl_code,
               contentType: false,
               processData: false,
               cache: false,
               success: function (response) {
                  // DrpdownSrcExpression(ppl_code, "");
                   var getres = [];
                   if(response.length > 0){
                   for(var i=0; i< response.length; i++){
                       getres.push({
                           "field_type": "TEXT",
                           "field_length": "255",
                           "seq_no": i+1,
                           "dataset_field_desc": response[i].dataset_field_desc,
                           "dataset_field_name":response[i].dataset_field_name,
                           "default_value":response[i].default_value,
                           "delete_flag":response[i].delete_flag,
                           "field_mandatory":response[i].field_mandatory,
                           "pipeline_code":response[i].pipeline_code,
                           "ppl_field_name":response[i].ppl_field_name,
                           "pplfieldmapping_flag":response[i].pplfieldmapping_flag,
                           "pplfieldmapping_gid":response[i].pplfieldmapping_gid,
                           "selected":response[i].selected,
                           "updated_by":response[i].updated_by,
                           "updated_date":response[i].updated_date,
                       });
                   }
                   loadgrid(getres);
                   }

               },
               error: function (er) {
                   jAlert(er, "Error");
               }
           });
       }

       function FieldMappingGriddata() {
           var ppl_code = $('#txt_ppl_code').val();
           var data_set = document.getElementById("trgdataset").value;
           var lastIndex = data_set.lastIndexOf("-");
           if (lastIndex !== -1) {
               data_set = extension.substring(lastIndex);
           }
           var src = "";
           $.ajax({
               type: 'GET',
               url: '@Url.Action("Readpplfieldmap", "Pipeline")?pipeline_code=' + ppl_code + "&dataset=" + data_set + "&source_name=" + src,
               contentType: false,
               processData: false,
               cache: false,
               success: function (response) {
                   //loadgrid(response);
               },
               error: function (er) {
                   jAlert(er, "Error");
               }
           });
       }

       /* DataProcessing Grid Start*/
       function loadgriddataprocessing(data1) {
           try {

               var data1 = [
                   {
                       extaraction_type: "Data Cleansing",
                       process: "Truncate Text",
                       field_name: "Balance Amount",
                       Action: "-"
                   }
               ];
               $("#dataprocesingmaingrid").remove();
               $('#dataprocessingmaindiv').append('<div id="dataprocesingmaingrid" style="margin-top: 15px;margin-left: 13px;"></div>');
               $("#dataprocesingmaingrid").kendoGrid({
                   dataSource: {
                       data: data1,
                       schema: {
                           model: {
                               fields: {
                                   extaraction_type: { type: "string" },
                                   process: { type: "string" },
                                   field_name: { type: "string" },
                                   Action: { type: "String" },
                               }
                           }
                       },
                       pageSize: 10,
                   },
                   height: 305,
                   width: 1058,

                   pageable: true,
                   sortable: true,
                   filterable: true,
                   //selectable: "multiple",
                   //toolbar: [{ name: "create", text: " " }],
                   columns: [

                       {
                           field: "extaraction_type",
                           title: "Extraction Type",
                           width: 200,
                       },
                       {
                           field: "process",
                           title: "Cleansing Action",
                           width: 200
                       },
                       {
                           field: "field_name",
                           title: "Choose Field",
                           width: 200
                       },
                       {
                           field: "Action",
                           title: "Action",
                           template: "<i class='glyphicon glyphicon-trash' onclick='deletepplfieldmap($(this))' style='color:red;margin-left: 40% !important'></i>",
                           width: 80
                       },
                   ],
               });
           }
           catch (err) {
               jAlert(er, "Error");
           }
       }

       function DataProcessingGriddata() {
           var ppl_code = $('#txt_ppl_code').val();
           $.ajax({
               type: 'GET',
               url: '@Url.Action("Readpplfieldmap", "Pipeline")?pipeline_code=' + ppl_code,
               //url: "../Pipeline/Readpplfieldmap?pipeline_code=" + ppl_code,
               contentType: false,
               processData: false,
               cache: false,
               success: function (response) {
                   loadgriddataprocessing(response);
               },
               error: function (er) {
                   jAlert(er, "Error");
               }
           });
       }

       /* DataProcessing Grid End*/

       function deletepplfieldmap(e) {
           let text = "Are you sure to delete?";
           jConfirm(text, "Connector", function (f) {
               if (f == true) {
                   var entityGrid = $("#TablefieldGrid").data("kendoGrid");
                   var pplfieldmap_gid = entityGrid.dataItem(e.select().closest("tr")).pplfieldmapping_gid;
                   $.ajax({
                       type: "Post",
                       url: '@Url.Action("Deleteexistingpplfieldmap", "Pipeline")?id=' + pplfieldmap_gid,
                       //url: "../Pipeline/Deleteexistingpplfieldmap?id=" + pplfieldmap_gid,
                       dataType: "json",
                       contentType: 'application/json; charset=utf-8',
                       success: function (response) {
                           jAlert(response, "Connector", function (g) {
                               if (g == true) {
                                   var pplgid = $("#txt_ppl_gid").val();
                                   fetchppl(pplgid);
                                   //location.reload();
                               }
                           });
                           //jAlert(response, "Connector");
                           //alert(response);
                       },
                       error: function (er) {
                           jAlert(er, "Error");
                       }
                   });
               }
               else {
                   text = "You canceled!";
               }
           });

       }

       btn_addnew.addEventListener("click", function () {
           GetExpressionlines($("#txt_ppl_code").val());
           //ExpressionGrid([]);
           expression_conf.classList.add("show");
           $("#expression_conf").kendoWindow();
           var dialog = $("#expression_conf").data("kendoWindow");
           dialog.open().element.closest(".k-window").css({
               top: 110,
               left: 130,
               height: 381,
               width: 1033,

           });
       });

       var v_srctblviewqry_desc = "";
       var v_srctblviewqry_type = "";

       function pplheadersave() {
            if ($("#txtppl_name").val() == "" || $("#txtppl_name").val() == null || $("#txtppl_name").val() == undefined) {
                jAlert("Please enter pipeline name.", "Connector");
                return;
            }
            var current_date = new Date;
            var ppl_code = $("#txt_ppl_code").val();

            if ($("#txt_ppl_gid").val() == "") {
                var insppl = {};
                insppl.pipeline_gid = "0";
                insppl.pipeline_name = $("#txtppl_name").val();
                insppl.pipeline_desc = $("#txtppl_desc").val();
                insppl.created_date = current_date;
                insppl.created_by = _user_code;
                insppl.pipeline_status = "Draft";
                var insppl1 = insppl;
                $.ajax({
                    type: "Post",
                    url: '@Url.Action("Addnewpipeline", "Pipeline")',
                    data: JSON.stringify(insppl1),
                    dataType: "json",
                    contentType: 'application/json; charset=utf-8',
                    success: function (response) {
                        $('#txt_ppl_gid').val(response);
                        setTimeout(function () {
                            fetchppl(response);
                        }, 600);
                    },
                    error: function (er) {
                        jAlert(er, "Error");
                    }
                });
            } else {
                var updppl = {};
                var pipelineGid = $("#txt_ppl_gid").val();
                updppl.pipeline_gid = pipelineGid;
                updppl.pipeline_name = $("#txtppl_name").val();
                updppl.pipeline_desc = $("#txtppl_desc").val();
                updppl.updated_date = current_date;
                updppl.updated_by = _user_code;
                updppl.pipeline_status = $("#txt_ppl_status").val();
                var updppl1 = updppl;
                var stngyfy = JSON.stringify(updppl1)
                $.ajax({
                    type: "Post",
                    url: '@Url.Action("Updateexistingpipeline", "Pipeline")',
                    data: JSON.stringify(updppl1),
                    dataType: "json",
                    contentType: 'application/json; charset=utf-8',
                    success: function (response) {
                    fetchppl(pipelineGid);
                    },
                    error: function (er) {
                        jAlert(er, "Error");
                    }
                });
            }
        }

       function pplsave() {
           if ($("#txtppl_name").val() == "" || $("#txtppl_name").val() == null || $("#txtppl_name").val() == undefined) {
               jAlert("Please enter pipeline name.", "Connector");
               return;
           }
           var current_date = new Date;
           var conn_code = document.getElementById("connectors");
           var v_conn_code = conn_code.value;

           var db_name = document.getElementById("databasename");
           var v_db_name = db_name.value;

           var selectedfile = document.getElementById("selectedfilename").textContent;
          // var selectedmacrofile = document.getElementById("selectedmacrofilename").textContent;
           var sheet_name1 = document.getElementById("txt_sheetname").value;
           var srctblviewqry_type = document.getElementById("src_tblviewquery");
           v_srctblviewqry_type = srctblviewqry_type.value;
            var trg_tbl = $('#txtds_code').val();
           var ppl_code = $("#txt_ppl_code").val();
           var v_trg_table = trg_tbl.toString().split('-')[0];
           var label = document.getElementById('lbl_info');
           var label1 = document.getElementById('lbl_info1');
           var label2 = document.getElementById('lbl_info2');
           var label3 = document.getElementById('lbl_info_ds');
           var selectedOption = conn_code.options[conn_code.selectedIndex];
           var selectedText = selectedOption.textContent;
           var getDSName = JSON.parse(sessionStorage.getItem("DS"));
           label.innerHTML = "Pipeline Name -> " + $("#txtppl_name").val() + ";Connector Name -> " + selectedText + ";Target Dataset -> " + selectedDataset;
           label1.innerHTML = "Pipeline Name -> " + $("#txtppl_name").val() + ";Connector Name -> " + selectedText + ";Target Dataset -> " + selectedDataset;
           label2.innerHTML = "Pipeline Name -> " + $("#txtppl_name").val() + ";Connector Name -> " + selectedText + ";Target Dataset -> " + selectedDataset;
           label3.innerHTML = "Pipeline Name -> " + $("#txtppl_name").val();
           if (v_srctblviewqry_type == "T") {
               var radioButton = $("input[name='radioGroup']:checked");
               if (radioButton.length > 0) {
                   v_srctblviewqry_desc = TableselectRow(radioButton[0]);
               }
           }
           else if (v_srctblviewqry_type == "V") {
               var radioButton = $("input[name='radioGroup1']:checked");
               if (radioButton.length > 0) {
                   v_srctblviewqry_desc = ViewselectRow(radioButton[0]);
               }
           }
           else if (v_srctblviewqry_type == "Q") {
               v_srctblviewqry_desc = document.getElementById("txt_cusquery").value;
           }
           else {
               v_srctblviewqry_desc = trg_tbl.toString().split('-')[1];
           }
           var trg_tbl = document.getElementById("trgdataset").value;
           var v_trg_table = trg_tbl.toString().split('-')[0];

           if ($("#txt_ppl_gid").val() == "") {
               var insppl = {};
               insppl.pipeline_gid = "0";
               insppl.pipeline_name = $("#txtppl_name").val();
               insppl.pipeline_desc = $("#txtppl_desc").val();
               insppl.connection_code = v_conn_code;
               insppl.db_name = v_db_name;
               insppl.table_view_query_type = v_srctblviewqry_type;
               insppl.table_view_query_desc = v_srctblviewqry_desc;
               insppl.target_dataset_code = v_trg_table;
               insppl.created_date = current_date;
               insppl.created_by = _user_code;
               insppl.pipeline_status = "Draft";
               var insppl1 = insppl;
               $.ajax({
                   type: "Post",
                   url: '@Url.Action("Addnewpipeline", "Pipeline")',
                   data: JSON.stringify(insppl1),
                   dataType: "json",
                   contentType: 'application/json; charset=utf-8',
                   success: function (response) {
                       $('#txt_ppl_gid').val(response);
                       setTimeout(function () {
                           fetchppl(response);
                       }, 600);
                   },
                   error: function (er) {
                       jAlert(er, "Error");
                   }
               });
           }
           else {
               var updppl = {};
               var pipelineGid = $("#txt_ppl_gid").val();
               updppl.pipeline_gid = pipelineGid;
               updppl.pipeline_name = $("#txtppl_name").val();
               updppl.pipeline_desc = $("#txtppl_desc").val();
               updppl.connection_code = v_conn_code;
               updppl.db_name = v_db_name;
               updppl.source_file_name = selectedfile;
              // updppl.macro_file_name = selectedmacrofile;
               updppl.sheet_name = sheet_name1;
               updppl.table_view_query_type = v_srctblviewqry_type;
               updppl.table_view_query_desc = v_srctblviewqry_desc;
               updppl.target_dataset_code = v_trg_table; //"DS235";
               updppl.updated_date = current_date;
               updppl.updated_by = _user_code;
               updppl.pipeline_status = "Active";//$("#txt_ppl_status").val();
               var updppl1 = updppl;
               var stngyfy = JSON.stringify(updppl1)
               $.ajax({
                   type: "Post",
                   url: '@Url.Action("Updateexistingpipeline", "Pipeline")',
                   data: JSON.stringify(updppl1),
                   dataType: "json",
                   contentType: 'application/json; charset=utf-8',
                   success: function (response) {
                    fetchppl(pipelineGid);
                   },
                   error: function (er) {
                       jAlert(er, "Error");
                   }
               });
           }
       }

       function srctablefields(connection_code, databasename, sourcetable) {
           $.ajax({
               type: 'GET',
               url: '@Url.Action("GetSourceTableFielddrp", "Pipeline")?conn_code=' + connection_code + "&dbname=" + databasename +
                   "&srctable=" + sourcetable,
               dataType: "json",
               contentType: 'application/json; charset=utf-8',
               success: function (data) {
                   var select = $("#srcfield");

                   // Clear existing options
                   select.empty();
                   // Add new options from the JSON data
                   select.append($("<option>").attr("value", "").text("-- Select --"));

                   $.each(data, function (index, item) {
                       select.append($("<option>").attr("value", item.id).text(item.name));
                   });

               },
               error: function (er) {
                   jAlert(er, "Error");
               }
           });
       }

       function DrpdownSrcExpression(pipeline_code, source_type) {
           $.ajax({
               type: 'GET',
               url: '@Url.Action("GetSrcExpressionDrpdown", "Pipeline")?pipeline_code=' + pipeline_code + '&source_type=' + source_type,
               async: false,
               dataType: "json",
               contentType: 'application/json; charset=utf-8',
               success: function (data) {
                 //  sourceFieldNames = data;
               },
               error: function (er) {
                   jAlert(er, "Error");
               }
           });
       }

       function srcexcelfields(pipeline_code, path, sheetname,datasetinsert) {
           var dataset_code = $("#txtds_code").val();
           $.ajax({
               type: 'GET',
               url: '@Url.Action("GetSourceExcelFielddrp", "Pipeline")?pipeline_code=' + pipeline_code + "&path=" + path + "&sheetname=" + sheetname + "&user_code=" + _user_code+"&dataset_code="+dataset_code+"&datasetinsert="+datasetinsert,
               async: false,
               dataType: "json",
               contentType: 'application/json; charset=utf-8',
               success: function (data) {

                        Changetargetds("Yes");

                   var select = $("#id_pplfieldname");
                   select.empty();
                   select.append($("<option>").attr("value", "").text("-- Select --"));
                   for (var i = 0; i < data.length; i++) {
                       var optionName = data[i].name;
                       var selected = "Tran Date" === optionName ? 'selected' : '';
                       select.append($("<option >").attr("value", optionName).text(optionName));
                   }
               },
               error: function (er) {
                   jAlert(er, "Error");
               }
           });
       }

       function srcmysqlfields(conn_code, pipeline_code, db_name, table_view_query_desc, table_view_query_type, ds_code, datasetInsert) {
           $.ajax({
               type: 'GET',
               url: '@Url.Action("GetSourcetvqFielddrp", "Pipeline")?conn_code=' + conn_code + "&pipeline_code=" + pipeline_code + "&db_name="
                   + db_name + "&src_table=" + table_view_query_desc + "&table_view_query_type=" + table_view_query_type + "&user_code=" 
                   + _user_code + "&dataset_code=" + ds_code + "&datasetInsert=" + datasetInsert,
               async: false,
               dataType: "json",
               contentType: 'application/json; charset=utf-8',
               success: function (data) {                   
                   Changetargetds("Yes");
                   var select = $("#id_pplfieldname");

                   // Clear existing options
                   select.empty();
                   // Add new options from the JSON data
                   select.append($("<option>").attr("value", "").text("-- Select --"));

                   for (var i = 0; i < data.length; i++) {
                       var optionName = data[i].name;
                       var selected = "Tran Date" === optionName ? 'selected' : '';
                       select.append($("<option >").attr("value", optionName).text(optionName));
                   }
               },
               error: function (er) {
                   jAlert(er, "Error");
               }
           });
       }

       function trgtablefields(dataset_code) {
           $.ajax({
               type: 'GET',
               url: '@Url.Action("GetTargetTableFielddrp", "Pipeline")?dataset_code=' + dataset_code,
               //url: "../Pipeline/GetTargetTableFielddrp?dataset_code=" + dataset_code,
               dataType: "json",
               contentType: 'application/json; charset=utf-8',
               success: function (data) {
                   var select = $("#trgfield");

                   // Clear existing options
                   select.empty();
                   // Add new options from the JSON data
                   select.append($("<option>").attr("value", "").text("-- Select --"));

                   $.each(data, function (index, item) {
                       select.append($("<option>").attr("value", item.dataset_field_name).text(item.dataset_field_desc));
                   });

               },
               error: function (er) {
                   jAlert(er, "Error");
               }
           });
       }

       function drpkeyfield_old() {
           var conn_code = document.getElementById("connectors");
           var v_conn_code = conn_code.value;

           var db_name = document.getElementById("databasename");
           var v_db_name = db_name.value;

           var trg_tbl = document.getElementById("trgdataset");
           var v_trg_table = trg_tbl.value;
           v_trg_table = v_trg_table.toString().split('-')[1];

           $.ajax({
               type: 'GET',
               url: '@Url.Action("GetKeyFielddrp", "Pipeline")?conn_code=' + v_conn_code + "&dbname=" + v_db_name + "&table_name=" + v_trg_table,
               //url: "../Pipeline/GetKeyFielddrp?conn_code=" + v_conn_code + "&dbname=" + v_db_name + "&table_name=" + v_trg_table,
               dataType: "json",
               contentType: 'application/json; charset=utf-8',
               success: function (data) {
                   var select = $("#keyfield");

                   // Clear existing options
                   select.empty();
                   // Add new options from the JSON data
                   select.append($("<option>").attr("value", "").text("-- Select --"));

                   $.each(data, function (index, item) {
                       select.append($("<option>").attr("value", item.name).text(item.name));
                   });
               },
               error: function (er) {
                   jAlert(er, "Error");
               }
           });
       }

       function drpkeyfield() {
           //var trg_tbl =  document.getElementById("trgdataset");
           var v_trg_table = $("#txtds_code").val();
          // v_trg_table = v_trg_table.toString().split('-')[1];
          var ppl_code = $('#txt_ppl_code').val();
           if (v_trg_table != undefined && v_trg_table != null && v_trg_table != "") {
               $.ajax({
                   type: 'GET',
                   url: '@Url.Action("GetTrgKeyFielddrp", "Pipeline")?table_name=' + v_trg_table + "&pipeline_code=" +ppl_code,
                   dataType: "json",
                   contentType: 'application/json; charset=utf-8',
                   success: function (data) {

    var multiSelect = $("#keyfield_drp").data("kendoMultiSelect");

       // Clear selected values
       multiSelect.value([]);

       // Optional: Clear existing data source
       multiSelect.setDataSource(new kendo.data.DataSource({ data: [] }));                    dskeyfield = new kendo.data.DataSource({
                           data: data,
                           sort: { field: "name", dir: "asc" }
                       });
                              // console.log("dskeyfield", dskeyfield);
                       $("#keyfield_drp").data("kendoMultiSelect").setDataSource(dskeyfield);
                   },
                   error: function (er) {
                       jAlert(er, "Error");
                   }
               });
           }
       }

       function tablefieldlist() {
           var conn_code = document.getElementById("connectors");
           var v_conn_code = conn_code.value;

           var db_name = document.getElementById("databasename");
           var v_db_name = db_name.value;

           var src_tbl = document.getElementById("srctblview");
           var v_src_table = src_tbl.value;

           var trg_tbl = document.getElementById("trgdataset");
           var v_trg_table = trg_tbl.value;

           if (v_src_table == "" || v_src_table == null) {
               jAlert("Please select source table name.", "Connector");
               return
           }

           //if (v_trg_table == "" || v_trg_table == null) {
           //    jAlert("Please select target data set.", "Connector");
           //    return
           //}

           $.ajax({
               type: 'GET',
               url: '@Url.Action("GetTableFieldlist", "Pipeline")?conn_code=' + v_conn_code + "&dbname=" + v_db_name + "&srctable=" + v_src_table
                   + "&trgtable=" + v_trg_table,
               //url: "../Pipeline/GetTableFieldlist?conn_code=" + v_conn_code + "&dbname=" + v_db_name +
               //    "&srctable=" + v_src_table + "&trgtable=" + v_trg_table,
               contentType: false,
               success: function (response) {
                   //loadgrid(response);
               },
               error: function (er) {
                   jAlert(er, "Error");
               }
           });
       }
       function Changetargetds(datasetinsert) {
           var data = {};
           var ppl_code = $("#txt_ppl_code").val();
           var trg_tbl = $('#trgdataset').val();
           var conn_code = $('#connectors').val();
           var database_name = $('#databasename').val();
           var ds_code = $("#txtds_code").val();
           // if ($("#txt_source_db_type").val() == "MySql") {
           //     srcmysqlfields(conn_code, ppl_code, database_name, v_srctblviewqry_desc, v_srctblviewqry_type, ds_code, datasetinsert);
           // }
           data.pipeline_code = $("#txt_ppl_code").val();
           trg_tbl = trg_tbl.split('-', 1);
           data.dataset_code = $('#txtds_code').val();
           data.created_by = _user_code;
           $.ajax({
               type: "Post",
               url: '@Url.Action("Addnewpplfieldmap", "Pipeline")',
               data: JSON.stringify(data),
               dataType: "json",
               contentType: 'application/json; charset=utf-8',
               success: function (response) {
                   if (response == "Inserted Successfully") {
                       // TablefieldGriddata();
                       // fetchpplcond("Filter");
                       // fetchpplcond("Rejection");
                       // fetchpplcond("Validation");
                       // DataprocessingLoadgrid([]);
                   }
                   else {
                       jAlert(response, "Error");
                   }
               },
               error: function (er) {
                   jAlert(er, "Error");
               }
           });
       }

       function PPLfieldMapInsert() {
           var current_targetds = "";
           current_targetds = document.getElementById("trgdataset");
           var selectedOption1 = current_targetds.options[current_targetds.selectedIndex];
           var selectedText1 = selectedOption1.textContent;
           if (previous_targetds != "") {
               let text = "On changing Targetdataset existing (Expression, Inclusion,\n" +
                   "Rejection, Validation, Conversion Rules) will be deleted.\n " +
                   " Are You sure to change the Targetdataset ?  ";
               jConfirm(text, "Connector", function (f) {
                   if (f == true) {
                      // Changetargetds();
                   }
               });
           }
           else {
              // Changetargetds();
           }
           previous_targetds = selectedText1;
       }

       function togglebutton(actionfor) {
           var condition = "";

           if (actionfor == "Filter") {
               condition = $("#txt_filtercond").val();
               if (condition.trim() == '') {
                   document.getElementById('btn_filtersave').disabled = false;
                   document.getElementById('btn_flcheckquery').disabled = true;
               } else {
                   document.getElementById('btn_filtersave').disabled = true;
                   document.getElementById('btn_flcheckquery').disabled = false;
               }
           }
           else if (actionfor == "Rejection") {
               condition = $("#txt_rejectioncond").val();
               if (condition.trim() == '') {
                   document.getElementById('btn_rejectionsave').disabled = false;
                   document.getElementById('btn_rjcheckquery').disabled = true;
               } else {
                   document.getElementById('btn_rejectionsave').disabled = true;
                   document.getElementById('btn_rjcheckquery').disabled = false;
               }
           }
           else if (actionfor == "Validation") {
               condition = $("#txt_validationcond").val();
               if (condition.trim() == '') {
                   document.getElementById('btn_validationsave').disabled = false;
                   document.getElementById('btn_vlcheckquery').disabled = true;
               } else {
                   document.getElementById('btn_vaidationsave').disabled = true;
                   document.getElementById('btn_vlcheckquery').disabled = false;
               }
           }

       }

       function pplfiltercondsave() {
           var current_date = new Date;
           var data = {};
           data.pipeline_code = $("#txt_ppl_code").val();
           data.condition_type = "Filter";
           data.condition_text = $("#txt_filtercond").val().trim();
           data.dataset_code = $("#txtds_code").val();
           if ($("#txt_filter_gid").val() == "") {
               data.pplcondition_gid = "0";
               data.created_date = current_date;
               data.created_by = _user_code;

               $.ajax({
                   type: "Post",
                   url: '@Url.Action("Addnewpplcondition", "Pipeline")',
                   data: JSON.stringify(data),
                   dataType: "json",
                   contentType: 'application/json; charset=utf-8',
                   success: function (response) {
                       jAlert("Filter Condition Saved Successfully..!", "Connector");
                       fetchpplcond("Filter");
                   },
                   error: function (er) {
                       jAlert(er, "Error");
                   }
               });
           }
           else {
               data.pplcondition_gid = $("#txt_filter_gid").val();
               data.updated_date = current_date;
               data.updated_by = _user_code;

               $.ajax({
                   type: "Post",
                   url: '@Url.Action("Updateexistingpplcondition", "Pipeline")',
                   data: JSON.stringify(data),
                   dataType: "json",
                   contentType: 'application/json; charset=utf-8',
                   success: function (response) {
                       jAlert("Filter Condition Updated Successfully..!", "Connector");
                       fetchpplcond("Filter");
                       document.getElementById('btn_filtersave').disabled = true;
                   },
                   error: function (er) {
                       jAlert(er, "Error");
                   }
               });
           }
       }

       function fetchpplcond(condition_type) {
           var ppl_code = $('#txt_ppl_code').val();
           var ds_code = $('#txtds_code').val();
           $.ajax({
               type: "GET",
               url: '@Url.Action("ReadpipelineCondition", "Pipeline")?pipelinecode=' + ppl_code + '&condition_type=' + condition_type+ '&datasetcode=' + ds_code,
               dataType: "json",
               contentType: 'application/json; charset=utf-8',
               success: function (response) {
                   if (response.length > 0) {
                       if (condition_type == "Filter") {
                           $('#txt_filter_gid').val(response[0].pplcondition_gid);
                           $('#txt_filtercond').val(response[0].condition_text);
                       }
                       else if (condition_type == "Rejection") {
                           $('#txt_rejection_gid').val(response[0].pplcondition_gid);
                           $('#txt_rejectioncond').val(response[0].condition_text);
                       }
                   }

                   if (condition_type == "Filter" && response.length == 0) {
                       $('#txt_filter_gid').val("");
                       $('#txt_filtercond').val("");
                   }
                   else if (condition_type == "Rejection" && response.length == 0) {
                       $('#txt_rejection_gid').val("");
                       $('#txt_rejectioncond').val("");
                   }

                   if (condition_type == "Validation") {
                       ValidationGrid(response);
                       Validationclear();
                   }
               },
               error: function (er) {
                   jAlert(er, "Error");
               }
           });
       }

       function pplrejectioncondsave() {
           var current_date = new Date;
           var data = {};

           data.pipeline_code = $("#txt_ppl_code").val();
           data.condition_type = "Rejection";
           data.condition_text = $("#txt_rejectioncond").val().trim();
           data.dataset_code = $("#txtds_code").val();
           if ($("#txt_rejection_gid").val() == "") {
               data.pplcondition_gid = "0";
               data.created_date = current_date;
               data.created_by = _user_code;

               $.ajax({
                   type: "Post",
                   url: '@Url.Action("Addnewpplcondition", "Pipeline")',
                   data: JSON.stringify(data),
                   dataType: "json",
                   contentType: 'application/json; charset=utf-8',
                   success: function (response) {
                       jAlert("Rejection Condition Saved Successfully..!", "Connector");
                       fetchpplcond("Rejection");
                   },
                   error: function (er) {
                       jAlert(er, "Error");
                   }
               });
           }
           else {
               data.pplcondition_gid = $("#txt_rejection_gid").val();
               data.updated_date = current_date;
               data.updated_by = _user_code;

               $.ajax({
                   type: "Post",
                   url: '@Url.Action("Updateexistingpplcondition", "Pipeline")',
                   data: JSON.stringify(data),
                   dataType: "json",
                   contentType: 'application/json; charset=utf-8',
                   success: function (response) {
                       jAlert("Rejection Condition Updated Successfully..!", "Connector");
                       fetchpplcond("Rejection");
                       document.getElementById('btn_rejectionsave').disabled = true;

                   },
                   error: function (er) {
                       jAlert(er, "Error");
                   }
               });
           }
       }

       function pplvalidationrulesave() {
           var current_date = new Date;
           var data = {};

           data.pipeline_code = $("#txt_ppl_code").val();
           data.condition_type = "Validation";
           data.condition_text = $("#txt_validationcond").val();
           data.condition_name = $("#txt_validation_name").val();
           data.condition_msg = $("#txt_validation_msg").val();
           data.dataset_code = $("#txtds_code").val();
           if ($("#txt_validation_name").val() == "") {
               jAlert("Validation name cannot be empty..!", "Connector");
               return
           }
           if ($("#txt_validationcond").val() == "") {
               jAlert("Validation condition cannot be empty..!", "Connector");
               return
           }

           if ($("#txt_validation_gid").val() == "") {
               data.pplcondition_gid = "0";
               data.created_date = current_date;
               data.created_by = _user_code;

               $.ajax({
                   type: "Post",
                   url: '@Url.Action("Addnewpplcondition", "Pipeline")',
                   data: JSON.stringify(data),
                   dataType: "json",
                   contentType: 'application/json; charset=utf-8',
                   success: function (response) {
                       jAlert("Validation Condition Saved Successfully..!", "Connector");
                       fetchpplcond("Validation");
                   },
                   error: function (er) {
                       jAlert(er, "Error");
                   }
               });
           }
           else {
               data.pplcondition_gid = $("#txt_validation_gid").val();
               data.updated_date = current_date;
               data.updated_by = _user_code;

               $.ajax({
                   type: "Post",
                   url: '@Url.Action("Updateexistingpplcondition", "Pipeline")',
                   data: JSON.stringify(data),
                   dataType: "json",
                   contentType: 'application/json; charset=utf-8',
                   success: function (response) {
                       jAlert("Validation Condition Updated Successfully..!", "Connector");
                       fetchpplcond("Validation");
                   },
                   error: function (er) {
                       jAlert(er, "Error");
                   }
               });
           }
       }
    
       function srcupdatetimestampfields(connection_code, databasename, sourcetable) {
           $.ajax({
               type: 'GET',
               url: '@Url.Action("GetSrcUpdatetimestampFielddrp", "Pipeline")?conn_code=' + connection_code + "&dbname=" + databasename +
                   "&srctable=" + sourcetable,
               dataType: "json",
               contentType: 'application/json; charset=utf-8',
               success: function (data) {
                   var select = $("#updtimestamp");

                   // Clear existing options
                   select.empty();
                   // Add new options from the JSON data
                   select.append($("<option>").attr("value", "").text("-- Select --"));

                   $.each(data, function (index, item) {
                       select.append($("<option>").attr("value", item.id).text(item.name));
                   });

               },
               error: function (er) {
                   jAlert(er, "Error");
               }
           });
       }

       function pplfinsave() {
           document.getElementById('btn_submit').disabled = false;
           var current_date = new Date;
           var data = {};
           var multselectedval = "";
           var v_chkdup = "N";
           var v_error_mode = "";
           var v_duplicate_mode = "";

           var runtype = document.getElementById("run_type");
           var v_runtype = runtype.value;

           var v_cron_expression = $("#txt_cronexpr").val();

           var ext_mode = document.getElementById("extract_mode");
           var v_ext_mode = ext_mode.value;

           var upldmode = document.getElementById("upload_mode");
           var v_upldmode = upldmode.value;

           var v_extract_cond = $("#txt_extractcond").val();
           var v_lastxdays = $("#txt_pulllastxdays").val();

           var parentdataset = document.getElementById("parentdataset");
           var v_parentdataset = parentdataset.value;
           var v_parentds = v_parentdataset.toString().split('-')[0];

           if (v_runtype == "--select--") {
               jAlert("Please Select the runtype..!", "Connector");
               return;
           }

           else if (v_runtype == "Scheduled Run" && v_cron_expression == "") {
               jAlert("Cron Expression Cannot be blank.", "Connector");
               return;
               // Stay on same screen
           }
           else if (v_runtype == "Dependent" && v_parentdataset == "") {
               jAlert("Parent Dataset Cannot be blank.", "Connector");
               return;
               // Stay on same screen
           }

           if ($("#txt_source_db_type").val() == "MySql" && v_ext_mode == "--select--") {
               jAlert("Please Select the Extract Mode..!", "Connector");
               return;
           }

           if (v_upldmode == "--select--") {
               jAlert("Please Select the uploadmode..!", "Connector");
               return;
           }

           if ((v_ext_mode == "Incremental records" || v_ext_mode == "Pull last X days") && $('#txt_extractcond').val().trim() == "") {
               jAlert("Extract condition Cannot be blank.", "Connector");
               return;
           }

           if (v_ext_mode == "Pull last X days" && parseInt($("#txt_pulllstxdays").val(), 10) <= 0) {
               jAlert("Pull last X days Cannot be blank.", "Connector");
               return;
           }

           var checkbox = document.getElementById("chkbox_rejduplicate");
           if (checkbox.checked) {
               v_chkdup = "Y";
           }
           else {
               v_chkdup = "N";
           }

           var radio1 = document.getElementById("rdo_abort");
           var radio2 = document.getElementById("rdo_continue");

           var radio3 = document.getElementById("rdo_abort1");
           var radio4 = document.getElementById("rdo_continue1");

           if (radio1.checked) {
               v_error_mode = "Abort on Errors";
           } else if (radio2.checked) {
               v_error_mode = "Continue With Errors";
           }

           if (radio3.checked) {
               v_duplicate_mode = "Abort on Duplicates";
           } else if (radio4.checked) {
               v_duplicate_mode = "Continue With Duplicates";
           }

           for (var option of document.getElementById('keyfield_drp').options) {
               if (option.selected) {
                   multselectedval = multselectedval + (option.value) + ",";
               }
           }

           if (multselectedval != "") {
               multselectedval = multselectedval.slice(0, -1);
           }

           if ((checkbox.checked == true || v_duplicate_mode == "Abort on Duplicates") && multselectedval == "") {
               jAlert("Please Select the Keyfield..!", "Connector");
               return;
           }

           if ((v_upldmode == "Insert or Update based on key" || v_upldmode == "Insert or Update based on key with log") && multselectedval == "") {
               jAlert("Please Select the Keyfield..!", "Connector");
               return;
           }

           if (v_runtype == "Scheduled Run" && v_cron_expression == "") {
               jAlert("Cron Expression Cannot be blank.", "Connector");
               return;
           }

           if (v_upldmode == "Clean and Insert" &&
               (checkbox.checked == false && v_duplicate_mode != "Abort on Duplicates") &&
               $("#keyfield_drp").val() != undefined) {
               jAlert("Please Check the Reject Duplicates (or) remove the keyfield..!", "Connector");
               return;
               // Stay on same screen
           }

           // if (v_upldmode!= "Pull all X days" v_extract_cond == "") {
           //     jAlert("Extraction Condition cannot be empty..!", "Connector");
           //     return;
           // }

           data.pipeline_code = $("#txt_ppl_code").val();
           data.run_type = v_runtype;
           data.cron_expression = v_cron_expression;//$("#txt_cronexpr").val();
           data.extract_mode = v_ext_mode;
           data.upload_mode = v_upldmode;
           data.key_field = multselectedval;
           data.extract_condition = v_extract_cond;
           data.pull_days = parseInt($("#txt_pulllstxdays").val(), 10);
           data.reject_duplicate_flag = v_chkdup;
           data.error_mode = v_error_mode;
           data.duplicate_mode = v_duplicate_mode;
           data.pipeline_status = $('#txt_ppl_status').val();
           data.parent_dataset_code = v_parentds;
           data.dataset_code = $("#txtds_code").val();
           setTimeout(function () {
               if ($("#txt_pplfinalization_gid").val() == "") {
                   data.finalization_gid = "0";
                   data.created_date = current_date;
                   data.created_by = _user_code;

                   $.ajax({
                       type: "Post",
                       url: '@Url.Action("Addnewpplfinalization", "Pipeline")',
                       data: JSON.stringify(data),
                       dataType: "json",
                       contentType: 'application/json; charset=utf-8',
                       success: function (response) {
                           jAlert(response, "Connector", function (g) {
                               if (g == true) {
                                   fetchppl($("#txt_ppl_gid").val());
                                   gridhasChange = false;
                                   multselectedval = "";
                                   document.getElementById('pipelne').classList.remove('active');
                                   document.getElementById('datasource').classList.add('active');
                                   document.getElementById('preprocess').classList.remove('active');
                                   document.getElementById('processing').classList.remove('active');
                                   document.getElementById('postprocessing').classList.remove('active');
                                   $("#tab1").hide();
                                   $("#tab2").show();
                                   $("#tab2").addClass("show-tab-important");
                                   $("#tab3").hide();
                                   $("#tab4").hide();
                                   $("#tab5").hide();
                                   dataSelection.classList.add("active");
                                   templateSelectionConf.style.display = "none";
                                   dataSelectionConf.style.display = "block";
                                   loadexistingdataset("");
                                   //window.location.href = '@Url.Action("PipelineList", "Pipeline")';
                               }
                           });
                       },
                       error: function (er) {
                           jAlert(er, "Error");
                       }
                   });
               }
               else {
                   data.finalization_gid = $("#txt_pplfinalization_gid").val();
                   data.updated_date = current_date;
                   data.updated_by = _user_code;

                   $.ajax({
                       type: "Post",
                       url: '@Url.Action("Updateexistingpplfinalization", "Pipeline")',
                       data: JSON.stringify(data),
                       dataType: "json",
                       contentType: 'application/json; charset=utf-8',
                       success: function (response) {
                           jAlert(response, "Connector", function (g) {
                               if (g == true) {
                                   fetchppl($("#txt_ppl_gid").val());
                                   gridhasChange = false;
                                   multselectedval = "";
                                   document.getElementById('pipelne').classList.remove('active');
                                   document.getElementById('datasource').classList.add('active');
                                   document.getElementById('preprocess').classList.remove('active');
                                   document.getElementById('processing').classList.remove('active');
                                   document.getElementById('postprocessing').classList.remove('active');
                                   $("#tab1").hide();
                                   $("#tab2").show();
                                   $("#tab2").addClass("show-tab-important");
                                   $("#tab3").hide();
                                   $("#tab4").hide();
                                   $("#tab5").hide();
                                   dataSelection.classList.add("active");
                                   templateSelectionConf.style.display = "none";
                                   dataSelectionConf.style.display = "block";
                                   loadexistingdataset("");
                                  // window.location.href = '@Url.Action("PipelineList", "Pipeline")';
                               }
                           });

                       },
                       error: function (er) {
                           jAlert(er, "Error");
                       }
                   });
               }
           }, 1200);

       }

       function fetchpplfinalization() {
           var ppl_code = $('#txt_ppl_code').val();
           var ds_code = $('#txtds_code').val();
           $.ajax({
               type: "GET",
               url: '@Url.Action("ReadpipelineFinalization", "Pipeline")?pipelinecode=' + ppl_code+'&dataset_code='+ds_code,
               dataType: "json",
               contentType: 'application/json; charset=utf-8',
               success: function (response) {
                   if (response.length > 0) {
                       $('#txt_pplfinalization_gid').val(response[0].finalization_gid);
                       $('#run_type').val((response[0].run_type).toString());
                       schedulecron_cond();

                       $('#txt_cronexpr').val(response[0].cron_expression);
                       $('#extract_mode').val((response[0].extract_mode).toString());
                       extracttext_cond();

                       // if ((response[0].upload_mode).toString() == "Insert or Update based on key") {
                       //     rejectduplicate_cond();
                       // }
                       $('#upload_mode').val((response[0].upload_mode).toString());
                       // if ($('#upload_mode').val() == 'Clean and Insert') {
                       //     document.getElementById("chkbox_rejduplicate").disabled = true;
                       // }
                       pulllastxdays_cond();
                       rejectduplicate_cond();
                       $('#txt_extractcond').val(response[0].extract_condition);
                       $('#txt_pulllstxdays').val(response[0].pull_days);
                      // loadparenttrgtbl(response[0].parent_dataset_code, response[0].parent_dataset_code);
                       $("#txt_parentdataset").val(response[0].parent_dataset_code);
                       if (response[0].reject_duplicate_flag == "Y") {
                           document.getElementById("chkbox_rejduplicate").checked = true;
                       }
                       else {
                           document.getElementById("chkbox_rejduplicate").checked = false;
                       }

                       var radio1 = document.getElementById("rdo_abort");
                       var radio2 = document.getElementById("rdo_continue");

                       if (response[0].error_mode == "Abort on Errors") {
                           radio1.checked = true;
                           radio2.checked = false;
                       } else {
                           radio1.checked = false;
                           radio2.checked = true;
                       }
                       var radio3 = document.getElementById("rdo_abort1");
                       var radio4 = document.getElementById("rdo_continue1");
                       if (response[0].duplicate_mode == "Abort on Duplicates") {
                           radio3.checked = true;
                           radio4.checked = false;
                       } else {
                           radio3.checked = false;
                           radio4.checked = true;
                       }
                       selectColumns(response[0].key_field);
                   } else {
                          $('#txt_pplfinalization_gid').val("");
                          $('#run_type').val("On Demand");
                          schedulecron_cond();
                          document.getElementById("chkbox_rejduplicate").checked = true;
                          extracttext_cond();
                          $('#upload_mode').val("Insert or Update based on key");
                          pulllastxdays_cond();
                          rejectduplicate_cond();
                          selectColumns();
                          var radio3 = document.getElementById("rdo_abort1");
                          radio3.checked = true;
                   }
               },
               error: function (er) {
                   jAlert(er, "Error");
               }
           });
       }

       function selectColumns(selectedData) {
           if (selectedData != null) {
               var multiSelect = $("#keyfield_drp").data("kendoMultiSelect");
               var newValues = [];
               // alert(multiSelect);
               if (multiSelect != undefined) {
                   var selectedDatas = selectedData.split(',');
                   // Iterate over the array using jQuery.each
                   $.each(selectedDatas, function (index, value) {
                       newValues.push(value);
                   });
                   multiSelect.value(newValues);
               }
           }
       }

       function checkquery(queryfor) {
           var conn_code = $('#connectors').val();
           var database_name = $('#databasename').val();
           var src_table = $('#txt_table_view_query_desc').val();
           var query = "";
           var fltcond = "";
           var rejcond = "";
           if ($('#txt_filtercond').val() != "") {
               fltcond = "and " + $('#txt_filtercond').val();
           }
           if ($('#txt_rejectioncond').val() != "") {
               rejcond = "and " + $('#txt_rejectioncond').val();
           }
           if (queryfor == "CustomQuery") {
               query = $('#txt_cusquery').val();
           }
           else if (queryfor == "Filter") {
               query = "select * from " + src_table + " where 1=1 " + fltcond;
           }
           else if (queryfor == "Rejection") {
               query = "select * from " + src_table + " where 1=1 " + rejcond;
           }
           $.ajax({
               type: "GET",
               url: '@Url.Action("IsCheckQuery", "Pipeline")?conn_code=' + conn_code + "&dbname=" + database_name +
                   "&extractionquery=" + query,
               dataType: "json",
               contentType: 'application/json; charset=utf-8',
               success: function (response) {
                   if (response == true) {
                       jAlert("Validation Success..!", "Connector");
                       if (queryfor == "Filter") {
                           document.getElementById("btn_filtersave").disabled = false;
                       }
                       else if (queryfor == "Rejection") {
                           document.getElementById("btn_rejectionsave").disabled = false;
                       }
                   }
                   else {
                       jAlert("Validation Failed..!", "Connector");
                   }
               },
               error: function (er) {
                   jAlert(er, "Error");
               }
           });
       }

       function IsCheckQuery(queryfor) {
           var pplcode = $('#txt_ppl_code').val();
           var ds_code = $("#txtds_code").val();
           var isquery = "";
           if (queryfor == "Filter") {
               // isquery = $('#txt_filtercond').val();
               isquery = "and " + $('#txt_filtercond').val();
           }
           else if (queryfor == "Rejection") {
               // isquery = $('#txt_rejectioncond').val();
               isquery = "and " + $('#txt_rejectioncond').val();
           }
           else if (queryfor == "Expression") {
               isquery = $('#txt_expression_field').val();
           }
           else if ($('#txt_validationcond').val() != "" && queryfor == "Validation") {
               isquery = "and " + $('#txt_validationcond').val();
           }
           else if ($('#txt_extractcond').val() != "" && queryfor == "ExtractCondition") {
               isquery = "and " + $('#txt_extractcond').val();
               // var searchText = "*datefield";
               // var searchText1 = "*integerfield";

               // // Check if the textarea value contains the search text
               // if (isquery.includes(searchText) || isquery.includes(searchText1) || isquery.includes("now()")) {

               // } else {
               //     jAlert("Use *datefield for Date field (or) Use *integerfield for Integer field", "Connector");
               //     return;
               // }
           }

           if (isquery == "" && queryfor != "ExtractCondition") {
               jAlert("Condition/Rule Cannot be empty..!", "Connector");
               return
           }
           else if (isquery == "" && queryfor == "ExtractCondition") {
               jAlert("Extract Condition Cannot be empty..!", "Connector");
               return
           }

           $.ajax({
               type: "GET",
               url: '@Url.Action("IsCheckQueryValidation", "Pipeline")?pipeline_code=' + pplcode + "&dataset_code=" +ds_code+ "&query=" + encodeURIComponent(isquery) + "&queryfor=" + queryfor,
               success: function (response) {
                   if (response == "Success") {
                       jAlert("Query Validated Successfully..!", "Connector");
                       if (queryfor == "Filter") {
                           document.getElementById("btn_filtersave").disabled = false;
                       }
                       else if (queryfor == "Rejection") {
                           document.getElementById("btn_rejectionsave").disabled = false;
                       }
                       else if (queryfor == "Expression") {
                           document.getElementById("btn_expressionsave").disabled = false;
                       }
                       else if (queryfor == "Validation") {
                           document.getElementById("btn_validationsave").disabled = false;
                       }
                       else if (queryfor == "ExtractCondition") {
                           document.getElementById("btn_submit").disabled = false;
                       }
                   }
                   else {
                       jAlert(response, "Error");
                   }
               },
               error: function (er) {
                   jAlert(er.responseText, "Error");
               }
           });
       }

       function ExcelIsCheckQuery(queryfor, sourcedbtype) {

           if (sourcedbtype == "MySql") {
               checkquery(queryfor);
           }
           else if (sourcedbtype == "CSV") {
               IsCheckQuery(queryfor);
           }
           else {
               var isquery = "";
               if (queryfor == "Filter") {
                   isquery = $('#txt_filtercond').val();
               }
               else if (queryfor == "Rejection") {
                   isquery = $('#txt_rejectioncond').val();
               }
               else if (queryfor == "Expression") {
                   isquery = $('#txt_expression_field').val();
               }
               else if (queryfor == "Validation") {
                   isquery = $('#txt_validationcond').val();
               }
               if (isquery == "") {
                   jAlert("Condition/Rule Cannot be empty..!", "Connector");
                   return
               }
               $.ajax({
                   type: "GET",
                   url: '@Url.Action("ExcelCheckQuery", "Pipeline")?filelocation=' + path + "&query=" + encodeURIComponent(isquery) + "&queryfor=" + queryfor,
                   //dataType: "json",
                   //contentType: 'application/json; charset=utf-8',
                   success: function (response) {
                       if (response == "Success") {
                           jAlert("Query Validated Successfully..!", "Connector");
                           if (queryfor == "Filter") {
                               document.getElementById("btn_filtersave").disabled = false;
                           }
                           else if (queryfor == "Rejection") {
                               document.getElementById("btn_rejectionsave").disabled = false;
                           }
                           else if (queryfor == "Expression") {
                               document.getElementById("btn_expressionsave").disabled = false;
                           }
                           else if (queryfor == "Validation") {
                               document.getElementById("btn_validationsave").disabled = false;
                           }
                       }
                       else {
                           jAlert(response, "Error");
                       }
                   },
                   error: function (er) {
                       jAlert(er.responseText, "Error");
                   }
               });
           }

       }


</script>

<script>
    function getdblist(connection_code) {
        // $("#fileInput").removeClass('no-file-chosen'); // Remove the CSS class
        $("#fileInput").addClass('no-file-chosen');
        var e = document.getElementById("connectors");
        var value = e.value;
        var text = e.options[e.selectedIndex].text;

        if (text == "-- Select --") {
            // $("#div_fileinput").hide();
            // $("#grid_tvc").hide();
            // $("#div_selectfile").hide();
            // $("#img_div").hide();
            $("#div_srcdbname").hide();
            $("#div_tvq").hide();
            $("#div_apiurl").hide();
            $("#div_fileinput").hide();
            $("#div_delimited").hide();
            $("#div_csv").hide();
            $("#div_selectfile").hide();
            $("#div_downloadtemp").hide();
            $("#img_div").hide();
            $("#grid_tvc").hide();
            document.getElementById("btn_nextppl1").disabled = true;
        }
        else {
            $.ajax({
                type: "GET",
                url: '@Url.Action("Getconndblist", "Pipeline")?connection_code=' + connection_code,
                dataType: "json",
                contentType: 'application/json; charset=utf-8',
                success: function (data) {
                    var select = $("#databasename");
                    select.empty();
                    select.append($("<option>").attr("value", "").text("-- Select --"));
                    $.each(data, function (index, item) {
                        select.append($("<option>").attr("value", item.name).text(item.name));
                    });
                },
                error: function (er) {
                    jAlert(er, "Error");
                }
            });
        }
    }

    function gettablelist(connection_code, database_name) {
        //document.getElementById("btn_nextppl1").disabled = true;
        $.ajax({
            type: "GET",
            url: '@Url.Action("Gettablelist", "Pipeline")?connection_code=' + connection_code + "&database_name=" + database_name,
            dataType: "json",
            contentType: 'application/json; charset=utf-8',
            success: function (data) {
               $("#src_tblviewquery").val("");
                SrcTableGrid(data);
            },
            error: function (er) {
                jAlert(er, "Error");
            }
        });
    }

    function getviewlist(connection_code, database_name) {
        $.ajax({
            type: "GET",
            url: '@Url.Action("Getviewlist", "Pipeline")?connection_code=' + connection_code + "&database_name=" + database_name,
            dataType: "json",
            contentType: 'application/json; charset=utf-8',
            success: function (data) {
                SrcViewGrid(data);
            },
            error: function (er) {
                jAlert(er, "Error");
            }
        });
    }

    function macro_file_change(value) {
            const files = value.files[0];
            if (files && !files.name.endsWith('.xlsm')) {
                jAlert("Only .xlsm files are allowed.");
                value.value = ""; 
                return;
            }
            console.log("File", files);
           // $("#div_selectfile").hide();
            var slctfilename = $("#selectedmacrofilename").val();
            if (slctfilename == "") {
                $("#fileInput_macro").removeClass('no-file-chosen');
            } else {
                $("#fileInput_macro").addClass('no-file-chosen');
            }
            $("#selectedmacrofilename").val('');
            var fileInput = value;
            var file = fileInput.files[0];
            var formData = new FormData();
            excel_file = file;
            var pplcode = $('#txt_ppl_code').val();
            formData.append('pipeline_code', pplcode);
            formData.append('file', file);
            document.getElementById("selectedmacrofilename").textContent = file.name;
            $.ajax({
                url: '/Pipeline/UploadMacroFile',
                type: 'POST',
                data: formData,
                processData: false,
                contentType: false,
                success: function (response) { 
                    if(response.success){
                        $("#selectedmacrofilename").val(file.name);
                    }
                },
                error: function (er) {
                    jAlert(er, "Error");
                }
            });
    }

    function file_change(value) {
        //document.getElementById("selectedfilename").textContent = "";
        if($('#txt_fileextension').val()) {
             let text = "On changing Template (Expression, Inclusion,\n" +
                "Rejection, Validation, Conversion Rules) will be deleted.\n " +
                " Are You sure to change the Template ?  ";
            jConfirm(text, "Connector", function (f) {
                if (f == true) {
            var pipelineCode = $('#txt_ppl_code').val();
            var data = {};
            data.dataset_systemflag = "";
            data.pipelinedet_id = 0;
            data.pipeline_code = pipelineCode;
            data.dataset_name = "",
            data.datasetCode = "";
            data.dataset_id = 0;
            data.dataset_category = "",
            data.clone_dataset = "";
            data.active_status = "";
            data.inactive_reason = "";
            data.in_action = "EXCELCHANGE";
            data.in_action_by =_user_code;
            data.pipelinedet_dataset_type = $('input[name="rdo_dsmode"]:checked').val();
            $.ajax({
            type: "Post",
            url: '@Url.Action("datasetheader", "Pipeline")',
            data: JSON.stringify(data),
            dataType: "json",
            contentType: 'application/json; charset=utf-8',
            success: function (response) {
                var res = JSON.parse(response);
                   if(res.length >= 0 && res[0].out_result == 1){
                    jAlert(res[0].out_msg, "Connector");
                    $("#div_selectfile").hide();
                    var slctfilename = $("#selectedfilename").val();
                    if (slctfilename == "") {
                        $("#fileInput").removeClass('no-file-chosen');
                    } else {
                        $("#fileInput").addClass('no-file-chosen');
                    }
                    $("#selectedfilename").val('');
                    var fileInput = value;
                    var file = fileInput.files[0];
                    var formData = new FormData();
                    excel_file = file;
                    var pplcode = $('#txt_ppl_code').val();
                    formData.append('pipeline_code', pplcode);
                    formData.append('file', file);
                    document.getElementById("selectedfilename").textContent = file.name;
                    const files = value.files[0];
                    if (files && !files.name.endsWith('.xlsx')) {
                        jAlert("Only .xlsx files are allowed.");
                        value.value = ""; // Clear the invalid file
                        $("#div_selectfile").hide();
                        $("#fileInput").removeClass('no-file-chosen');
                        $('#txt_fileextension').val("");
                        $("#div_excel").hide();
                        $("#div_csv").hide();
                        $("#div_api").hide();
                        $("#tab2").addClass("show-tab-important");
                        document.getElementById("btn_nextppl1").disabled = true;
                        return;
                    } else {
                    $.ajax({
                        url: '@Url.Action("UploadFile", "Pipeline")',
                        type: 'POST',
                        data: formData,
                        processData: false,
                        contentType: false,
                        success: function (response) {
                            if (response.success) {
                                document.getElementById("btn_nextppl1").disabled = false;
                                $('#temp_download').prop('disabled', true);
                                getexcelsheetlist(response.path, '');
                                getExcelResponse(response.path);
                            }
                        },
                        error: function (er) {
                            jAlert(er, "Error");
                        }
                    });
                }
                }
            },
            error: function (er) {
                jAlert(er, "Error");
            }
        });
                }
            });
        } else {
            const files = value.files[0];
            if (files && !files.name.endsWith('.xlsx')) {
                jAlert("Only .xlsx files are allowed.");
                value.value = ""; // Clear the invalid file
                $("#div_selectfile").hide();
                $("#fileInput").removeClass('no-file-chosen');
                $('#txt_fileextension').val("");
                $("#div_excel").hide();
                $("#div_csv").hide();
                $("#div_api").hide();
                $("#tab2").addClass("show-tab-important");
                document.getElementById("btn_nextppl1").disabled = true;
                $("#datasetSelection").addClass("disable_li");
                return;
            }
            $("#div_selectfile").hide();
            var slctfilename = $("#selectedfilename").val();
            if (slctfilename == "") {
                $("#fileInput").removeClass('no-file-chosen');
            } else {
                $("#fileInput").addClass('no-file-chosen');
            }
            $("#selectedfilename").val('');
            // document.getElementById("btn_nextppl1").disabled = true;
            var fileInput = value;
            var file = fileInput.files[0];
            var formData = new FormData();
            excel_file = file;
            var pplcode = $('#txt_ppl_code').val();
            formData.append('pipeline_code', pplcode);
            formData.append('file', file);
            document.getElementById("selectedfilename").textContent = file.name;
            $.ajax({
                url: '@Url.Action("UploadFile", "Pipeline")',
                type: 'POST',
                data: formData,
                processData: false,
                contentType: false,
                success: function (response) {
                    if (response.success) {
                        document.getElementById("btn_nextppl1").disabled = false;
                        getexcelsheetlist(response.path, '');
                    }
                },
                error: function (er) {
                    jAlert(er, "Error");
                }
            });
        }

    };

    function getexcelsheetlist(file_path, password) {
        $.ajax({
            type: "GET",
            url: '@Url.Action("GetExcelsheetlist", "Pipeline")?path=' + file_path + "&password=" + password,
            dataType: "json",
            contentType: 'application/json; charset=utf-8',
            success: function (data) {
                $("#div_excel").show();
                SrcExcelGrid(data);
            },
            error: function (er) {
                jAlert(er, "Error");
                $("#div_excel").hide();

            }
        });
    }

     $("#fileInput").on("change", function (e) {
        readtemplateheader(e);
    });

    function readtemplateheader(e){
            var file = e.target.files[0];
            var reader = new FileReader();
            reader.onload = function (e) {
                var data = new Uint8Array(e.target.result);
                var workbook = XLSX.read(data, { type: "array" });

                // Get the first sheet name
                var sheetName = workbook.SheetNames[0];

                // Get the first sheet data
                var worksheet = workbook.Sheets[sheetName];

                // Convert to JSON
                var json = XLSX.utils.sheet_to_json(worksheet, { header: 1 });

                if (json.length > 0) {
                    var headers = json[0];
                    headers.forEach(h => console.log(h));
                }
            };
            reader.readAsArrayBuffer(file);
    }

    function loadparenttrgtbl(id, name) {
        $.ajax({
            type: "GET",
            url: '@Url.Action("GetTargetTablelist", "Pipeline")',
            //url: "../Pipeline/GetTargetTablelist",
            dataType: "json",
            contentType: 'application/json; charset=utf-8',
            success: function (data) {
                var select = $("#parentdataset");
                // Clear existing options
                select.empty();
                // Add new options from the JSON data
                select.append($("<option>").attr("value", "").text("-- Select --"));

                $.each(data, function (index, item) {
                    select.append($("<option>").attr("value", item.dataset_code).text(item.dataset_name));
                });
                $('#parentdataset').val(id + "-" + name);

            },
            error: function (er) {
                jAlert(er, "Error");
            }
        });
    }

</script>
<script>
    function showscheduled() {
        if ($('#scheduled_run').is(':checked')) {
            $("#Scheduled_expression").show();
        }
        else {
            $("#Scheduled_expression").hide();
        }
    }

    function showincremental() {
        if ($('#incremental_rec').is(':checked')) {
            $("#updatedtimestamp").show();
            $("#div_pulllastxdays").hide();
        }
        if ($('#pulllastxdays').is(':checked')) {
            $("#updatedtimestamp").show();
            $("#div_pulllastxdays").show();
        }
        if ($('#pullallrec').is(':checked')) {
            $("#updatedtimestamp").hide();
            $("#div_pulllastxdays").hide();

        }
    }

    function addNew(widgetId, value) {
        var widget = $("#" + widgetId).getKendoMultiSelect();
        var dataSource = widget.dataSource;

        if (confirm("Are you sure?")) {
            dataSource.add({
                Id: dataSource.data().length + 1,
                sportName: value
            });

            var currentValue = widget.value();
            currentValue.push(dataSource.data().length)
            widget.value(currentValue);
            widget.trigger("change");
        }
    };

    var srctblviewqry = document.getElementById("src_tblviewquery");

    srctblviewqry.addEventListener("change", function () {
        var selectedValue = srctblviewqry.value; // Get the selected value
        checkTVQ(selectedValue);
        document.getElementById("btn_nextppl1").disabled = false;
    });

    function checkTVQ(selectedValue) {
        var e = document.getElementById("connectors");
        var conn_code = e.value;

        var e1 = document.getElementById("databasename");
        var dbname = e1.value;

        if (selectedValue == "T") {
            gettablelist(conn_code, dbname)
            //SrcTableGrid([]);
            $("#div_table").show();
            $("#div_view").hide();
            $("#div_excel").hide();
            $("#div_query").hide();
        }
        else if (selectedValue == "V") {
            getviewlist(conn_code, dbname)
            $("#div_view").show();
            $("#div_excel").hide();
            $("#div_table").hide();
            $("#div_query").hide();

        }
        else if (selectedValue == "Q") {
            GetSourceDBType($('#connectors').val());
            $("#div_view").hide();
            $("#div_table").hide();
            $("#div_excel").hide();
            $("#div_query").show();
        }
    }

    var cnnect = document.getElementById("connectors");

    cnnect.addEventListener("change", function () {
        $("#div_view").hide();
        $("#div_table").hide();
        $("#div_query").hide();
        GetSourceDBType(cnnect.value)
    });

    var databs = document.getElementById("databasename");

    databs.addEventListener("change", function () {
        $("#div_view").hide();
        $("#div_table").hide();
        $("#div_query").hide();
    });

    // function loadgrid(data1) {
    //     try {

    //         $("#TablefieldGrid").remove();
    //         $('#search').append('<div id="TablefieldGrid" style="width: 96%; height: 200px!important; margin-top: 10px;margin-left: 15px;"></div>');
    //         $("#TablefieldGrid").kendoGrid({
    //             dataSource: {
    //                 data: data1,
    //                 schema: {
    //                     model: {
    //                         fields: {
    //                             selected: { type: "boolean", editable: false },
    //                             pplfieldmapping_gid: { type: "string", editable: false },
    //                             seq_no: {type: "string"},
    //                             pipeline_code: { type: "string", editable: false },
    //                             ppl_field_name: { type: "string", editable: false },
    //                             dataset_field_name: { type: "string", editable: false },
    //                             dataset_field_desc: { type: "string", editable: false },
    //                             field_type: { type: "string", defaultvalue:"TEXT", editable: false},
    //                             field_length: { type: "string",defaultvalue:"255", editable: false},
    //                             default_value: { type: "string" }
    //                         }
    //                     }
    //                 },
    //                 pageSize: 100,
    //             },
    //             height: 200,
    //             width: 1058,
    //             editable: true,
    //             pageable: true,
    //             sortable: true,
    //             filterable: true,
    //             selectable: false,

    //             columns: [
    //                 {
    //                     field: "selected",
    //                     title: "Mandatory",
    //                     template: function (dataItem) {
    //                         if (dataItem.field_mandatory == "Y" && dataItem.pplfieldmapping_flag == 1) {
    //                             return "<input id='fieldmapcheckbox' type='checkbox' checked='checked' disabled/>";
    //                         }
    //                         else if (dataItem.field_mandatory == "N" && dataItem.pplfieldmapping_flag == 1) {
    //                             return "<input id='fieldmapcheckbox' type='checkbox' checked='checked' disabled/>";
    //                         }
    //                         else {
    //                             return "<input id='fieldmapcheckbox' type='checkbox' disabled/>";
    //                         }
    //                     },
    //                     sortable: false,
    //                     filterable: false,
    //                     width: 70,
    //                     attributes: {
    //                         style: "text-align: center;"
    //                     }

    //                 },
    //                 {
    //                    field: "seq_no",
    //                    title: "Seq No",
    //                    width: 50
    //                 },
    //                 {
    //                     field: "pplfieldmapping_gid",
    //                     title: "pplfieldmapping_gid",
    //                     width: 20,
    //                     hidden: true
    //                 },
    //                 {
    //                     field: "pipeline_code",
    //                     title: "pipeline_code",
    //                     width: 200,
    //                     hidden: true
    //                 },
    //                 {
    //                     field: "dataset_field_name",
    //                     title: "Target Field code",
    //                     width: 200,
    //                     hidden: true
    //                 },
    //                 {
    //                     field: "dataset_field_desc",
    //                     title: "Target Field Name",
    //                     width: 200

    //                 },
    //                 {
    //                     field: "ppl_field_name",
    //                     title: "Source Field Name",
    //                     width: 200,
    //                     template: "#= createDropdown(pplfieldmapping_gid,ppl_field_name) #"

    //                 },{
    //                     field: "field_type",
    //                     title: "Field Type",
    //                     width: 100
    //                 },
    //                 {
    //                     field: "field_length",
    //                     title: "Field Length",
    //                     width: 100
    //                 },
    //                 {
    //                     field: "default_value",
    //                     title: "Default Value",
    //                     width: 100
    //                 }
    //             ],
    //         });

    //     }
    //     catch (err) {
    //         jAlert(err, "Error");
    //     }
    // }

    // function createDropdown(pplfieldmapping_gid, ppl_field_name) {
    //     var dropdownId = 'ppl_field_' + pplfieldmapping_gid;
    //     var dropdownHTML = '<select id="' + dropdownId + '" style="width:100%; height: 22px; border-radius: 6px;" class="source-field-dropdown">';
    //     for (var i = 0; i < sourceFieldNames.length; i++) {
    //         var optionId = sourceFieldNames[i].id;
    //         var optionName = sourceFieldNames[i].name;
    //         var selected = ppl_field_name === optionId ? 'selected' : '';
    //         var textColor = optionName.startsWith('*') ? 'color: red;' : '';
    //         dropdownHTML += '<option style="' + textColor + '" ' + selected + ' value="' + optionId + '">' + optionName + '</option>';
    //     }
    //     dropdownHTML += '</select>';
    //     return dropdownHTML;
    // }

    function fieldmapsave(){
        var grid = $("#grid_dsfieldMapping").data("kendoGrid");
        grid.dataSource.sync();
         var objpplmapupdlist = [];
         var selectedRow = {};
         var items = grid.dataSource._data;
         var hasValidationError = false;
        $.each(items, function (i, item) {
        delete item.field_length_Precision;
        delete item.field_length_scale;
        for (let key in item) {
            if (item[key] === undefined) {
                item[key] = null;
            }
        }
        
        if (item.field_mandatory === 'Y' || item.field_mandatory === "y") {
        if (!item.ppl_field_name || item.ppl_field_name.trim() === "-- Select --" || item.ppl_field_name.trim() === "--Select--" || item.field_mapped == "N" || !item.field_mapped) {
            jAlert("Please map Source fields for mandatory dataset fields", "Connector");
            hasValidationError = true;
            return false;
        }
       }
       if((!item.field_name || item.filed_name == '-- Select --' || item.field_name.trim() == "") && (item.field_mapped == "Y" || !item.field_mapped)) {
            jAlert("Dataset Name should not be empty when Enable is checked", "Connector");
            hasValidationError = true;
            return false;
        }
        if(item.field_mapped == "Y") {
             if((item.pplsourcefield_format == '-- Select --' || item.pplsourcefield_format == '--Select--' || item.pplsourcefield_format.trim() == "") && (item.field_type == "DATE" || item.field_type == "DATETIME")) {
            jAlert("Date Format is missing, Please Select the Date Format", "Connector");
            hasValidationError = true;
            return false;
            }
        }        
         if((item.ppl_field_name == '-- Select --' || item.ppl_field_name == '--Select--' || item.ppl_field_name.trim() == "" || item.ppl_field_name == undefined) && (item.field_mapped == 'Y')) {
            jAlert("Source Field is missing, Please choose source field or unselect the Enable", "Connector");
            hasValidationError = true;
            return false;
        }
        if((item.field_name == '-- Select --' || item.field_name == '--Select--' || item.field_name.trim() == '') && (item.datasetfield_gid != '0')) {
            jAlert("Dataset Field Name should not be empty", "Connector");
            hasValidationError = true;
            return false;
        }
    });

    if (hasValidationError) {
        return;
    }

    $.each(items, function (i, item) {
        item.dataset_seqno = item.dataset_seqno != null ? item.dataset_seqno.toString() : null;
        // if(item.pplsourcefield_gid != '0' && (item.field_name.trim() != "" && item.field_name != '-- Select --'
        //         && item.field_name != '--Select--' && item.field_name != undefined))
        //     {
        //         objpplmapupdlist.push(item);
        //     }
    });

    objpplmapupdlist = items;
            $.ajax({
            type: "Post",
            url: '@Url.Action("pplfieldmapupdatelist", "Pipeline")',
            data: JSON.stringify(objpplmapupdlist),
            dataType: "json",
            contentType: 'application/json; charset=utf-8',
            success: function (response) {
                jAlert(response, "Connector", function (g) {
                    if (g == true) {
                         gridhasChange = false;
                         $("#tab3").removeClass("show-tab-important");
                         getdatasetfield();
                         fetchpplcond("Filter");
                         fetchpplcond("Rejection");
                         fetchpplcond("Validation");
                    }
                });
            },
            error: function (er) {
                gridhasChange = false;
                jAlert(er, "Error");
            }
        });

    }

    // function fieldmapsave_old() {
    //     var grid = $("#TablefieldGrid").data("kendoGrid");
    //     var checkedrows = $("#fieldmapcheckbox:checked", grid.tbody).closest("tr");
    //     var uncheckedrows = $("#fieldmapcheckbox:not(:checked)", grid.tbody).closest("tr");
    //     var objpplmapupdlist = [];
    //     var selectedRow = {};
    //     var dropdownValuesSet = new Set(); // Set to keep track of unique dropdown values

    //     //Checked rows data pushed into array
    //     for (var i = 0; i < checkedrows.length; i++) {
    //         var item = grid.dataItem(checkedrows[i]);
    //         var dropdownid = "ppl_field_" + item.pplfieldmapping_gid;
    //         //var pplfieldid = "'#" + dropdownid + "'";
    //         var dropdownValue = $("#" + dropdownid).val();
    //         var chkdefault_val = (item.default_value || "").trim();

    //         // if (dropdownValue.startsWith("*")) {
    //         //     dropdownValue = dropdownValue.Substring(1)
    //         // }
    //         var trg_tbl = $('#trgdataset').val();
    //         trg_tbl = trg_tbl.split('-', 1);

    //         if (dropdownValue == "-- Select --" && (chkdefault_val == "" || chkdefault_val == null)) {
    //             jAlert("Please select the Source Field Name for " + item.dataset_field_desc, "Connector");
    //             return;
    //         }
    //         //Duplicate check for Source field name

    //         if (dropdownValuesSet.has(dropdownValue) && dropdownValue != "-- Select --") {
    //             jAlert("Duplicate Source Field Name: " + dropdownValue + " for " + item.dataset_field_desc, "Connector");
    //             return;
    //         } else {
    //             dropdownValuesSet.add(dropdownValue);
    //         }

    //         selectedRow = {
    //             pplfieldmapping_gid: item.pplfieldmapping_gid,
    //             pipeline_code: item.pipeline_code,
    //             ppl_field_name: dropdownValue,
    //             dataset_field_name: item.dataset_field_name,
    //             dataset_field_desc: item.dataset_field_desc,
    //             default_value: item.default_value,
    //             pplfieldmapping_flag: 1,
    //             dataset_code: trg_tbl[0],
    //             created_by: _user_code,
    //             updated_by: _user_code
    //         }

    //         objpplmapupdlist.push(selectedRow);
    //     }

    //     //Unchecked rows basic validation
    //     for (var i = 0; i < uncheckedrows.length; i++) {
    //         var item = grid.dataItem(uncheckedrows[i]);
    //         var dropdownid = "ppl_field_" + item.pplfieldmapping_gid;
    //         var dropdownValue = $("#" + dropdownid).val();
    //         // if (dropdownValue.startsWith("*")) {
    //         //     dropdownValue = dropdownValue.Substring(1)
    //         // }
    //         var trg_tbl = $('#trgdataset').val();
    //         trg_tbl = trg_tbl.split('-', 1);

    //         //Duplicate check for Source field name
    //         if (dropdownValuesSet.has(dropdownValue) && dropdownValue != "-- Select --") {
    //             jAlert("Duplicate Source Field Name: " + dropdownValue + " for " + item.dataset_field_desc, "Connector");
    //             return;
    //         } else {
    //             dropdownValuesSet.add(dropdownValue);
    //         }

    //         selectedRow = {
    //             pplfieldmapping_gid: item.pplfieldmapping_gid,
    //             pipeline_code: item.pipeline_code,
    //             ppl_field_name: dropdownValue,
    //             dataset_field_name: item.dataset_field_name,
    //             dataset_field_desc: item.dataset_field_desc,
    //             default_value: item.default_value,
    //             pplfieldmapping_flag: 0,
    //             dataset_code: trg_tbl[0],
    //             created_by: _user_code,
    //             updated_by: _user_code
    //         }

    //         objpplmapupdlist.push(selectedRow);
    //     }

    //     $.ajax({
    //         type: "Post",
    //         url: '@Url.Action("pplfieldmapupdatelist", "Pipeline")',
    //         data: JSON.stringify(objpplmapupdlist),
    //         dataType: "json",
    //         contentType: 'application/json; charset=utf-8',
    //         success: function (response) {
    //             jAlert(response, "Connector", function (g) {
    //                 if (g == true) {
    //                     TablefieldGriddata();
    //                 }
    //             });
    //         },
    //         error: function (er) {
    //             jAlert(er, "Error");
    //         }
    //     });
    //     //pplsave();
    // };

</script>



<script>
      function GetExpressionlines(pipeline_code) {
          var dataset_code = $("#txtds_code").val();
          $.ajax({
              type: 'GET',
              url: '@Url.Action("GetAllexpressions", "Pipeline")?pipelinecode=' + pipeline_code+"&dataset_code="+dataset_code,
              contentType: false,
              processData: false,
              cache: false,
              success: function (response) {
                  ExpressionGrid(response);
              },
              error: function (er) {
                  alert(er)
              }
          });
      }

      function ExpressionGrid(data1) {
          try {
              $("#expressionGrid").remove();
              $('#expressionsearch').append('<div id="expressionGrid" style="width: 96%; height: 232px; margin-top: 6px; margin-left: 20px;"></div>');
              $("#expressionGrid").kendoGrid({
                  dataSource: {
                      data: data1,
                      schema: {
                          model: {
                              fields: {
                                  pplsourcefield_gid: { type: "string" },
                                  sourcefield_name: { type: "string" },
                                  sourcefield_datatype: { type: "string" },
                                  sourcefield_expression: { type: "string" },
                                  Action: { type: "string" }
                              }
                          }
                      },
                      pageSize: 5
                  },
                  height: 232, // Corrected the height
                  width: "96%", // Use percentage for width

                  pageable: true,
                  sortable: true,
                  filterable: true,
                  selectable: "single",
                  columns: [
                      {
                          field: "pplsourcefield_gid",
                          title: "pplsourcefield_gid",
                          hidden: true
                      },
                      {
                          field: "sourcefield_name",
                          title: "Expression Name",
                          width: 150
                      },
                      {
                          field: "sourcefield_datatype",
                          title: "Expression DataType",
                          width: 150
                      },
                      {
                          field: "sourcefield_expression",
                          title: "Expression",
                          width: 200
                      },
                      {
                          field: "Action",
                          title: "Action",
                          //template: "<i class='glyphicon glyphicon-trash' style='color:red;margin-left: 40% !important'></i>",
                          template: "<div class= 'action-cell' style = 'text-align: center;' > <i class='glyphicon glyphicon-pencil' onclick='editexpression($(this))' style = color: green; cursor: pointer; ' title='Edit'></i> </t> </t> <i class='glyphicon glyphicon-trash' onclick='deleteExpression($(this))' style='color:red;margin-left: 20% !important'></i></div>",
                          width: 80
                      }
                  ],
                  editable: "inline"
              });
          } catch (err) {
              jAlert(err, "Error");
          }
      }

      function editexpression(e) {
          var entityGrid = $("#expressionGrid").data("kendoGrid");
          var pplsrcgid = entityGrid.dataItem(e.select().closest("tr")).pplsourcefield_gid;
          var expression_name = entityGrid.dataItem(e.select().closest("tr")).sourcefield_name;
          var drp_datatype = entityGrid.dataItem(e.select().closest("tr")).sourcefield_datatype;
          var expression_field = entityGrid.dataItem(e.select().closest("tr")).sourcefield_expression;
          $('#txt_pplsourcefield_gid').val(pplsrcgid);
          $('#txt_expression_name').val(expression_name);
          $('#drp_datatype').val(drp_datatype);
          $('#txt_expression_field').val(expression_field);
      }

      function PPLexpressionSave() {
            document.getElementById("btn_expressionsave").disabled = true;
          var current_date = new Date;
          var ppl_code = $("#txt_ppl_code").val();
          var pplsrcgid = $('#txt_pplsourcefield_gid').val();
          var expression_name = $('#txt_expression_name').val().trim();
          var expression_datatype = $('#drp_datatype').val();
          var expression_field = $('#txt_expression_field').val().trim();
          var dscode = $("#txtds_code").val();
          if (expression_name == "") {
              jAlert("Expression name cannot be blank ", "Connector");
              return;
          }
          if (expression_datatype == "-- Select --") {
              jAlert("Please select the Expression datatype ", "Connector");
              return;
          }
          if (expression_field == "") {
              jAlert("Expression cannot be blank ", "Connector");
              return;
          }
          if (pplsrcgid == "") {
              var data = {};
              data.pplsourcefield_gid = pplsrcgid;
              data.pipeline_code = ppl_code;
              data.sourcefield_name = expression_name;
              data.sourcefield_datatype = expression_datatype;
              data.sourcefield_expression = expression_field;
              data.source_type = "Expression";
              data.created_date = current_date;
              data.created_by = _user_code;
              data.dataset_code = dscode;
              data.sourcefield_format = "";
              $.ajax({
                  type: "Post",
                  url: '@Url.Action("Addnewpplsourcefield", "Pipeline")',
                  data: JSON.stringify(data),
                  dataType: "json",
                  contentType: 'application/json; charset=utf-8',
                  success: function (response) {
                      jAlert(response, "Connector");
                      if (response == "Record Inserted Successfully") {
                          GetExpressionlines(ppl_code);
                          Expressionclear();
                          document.getElementById("btn_expressionsave").disabled = true;
                      }
                  },
                  error: function (er) {
                      jAlert(er, "Error");
                        document.getElementById("btn_expressionsave").disabled = false;
                  }
              });
          }
          else {
              var data = {};
              data.pplsourcefield_gid = pplsrcgid;
              data.pipeline_code = ppl_code;
              data.sourcefield_name = expression_name;
              data.sourcefield_datatype = expression_datatype;
              data.sourcefield_expression = expression_field;
              data.source_type = "Expression";
              data.updated_date = current_date;
              data.created_by = _user_code;
              $.ajax({
                  type: "Post",
                  url: '@Url.Action("Updateexistingpplsourcefield", "Pipeline")',
                  data: JSON.stringify(data),
                  dataType: "json",
                  contentType: 'application/json; charset=utf-8',
                  success: function (response) {
                      jAlert(response, "Connector");
                      if (response == "Record Updated Successfully") {
                          GetExpressionlines(ppl_code);
                          Expressionclear();
                          document.getElementById("btn_expressionsave").disabled = true;
                      }

                  },
                  error: function (er) {
                      jAlert(er, "Error");
                        document.getElementById("btn_expressionsave").disabled = false;
                  }
              });
          }
      }

      function deleteExpression(e) {
          var ppl_code = $("#txt_ppl_code").val();
          let text = "Are you sure to delete?";
          jConfirm(text, "Connector", function (f) {
              if (f == true) {
                  var entityGrid = $("#expressionGrid").data("kendoGrid");
                  var v_pplsourcefield_gid = entityGrid.dataItem(e.select().closest("tr")).pplsourcefield_gid;
                  $.ajax({
                      type: "Post",
                      url: '@Url.Action("Deleteexistingpplsourcefield", "Pipeline")?id=' + v_pplsourcefield_gid,
                      dataType: "json",
                      success: function (response) {
                          jAlert(response, "Connector", function (g) {
                              if (g == true) {
                                  GetExpressionlines(ppl_code);
                                  Expressionclear();
                              }
                          });
                      },
                      error: function (er) {
                          jAlert(er, "Error");
                      }
                  });
              } else {
                  text = "You canceled!";
              }
          });
      }

      function closeexpressionpopup() {
          $("#expression_conf").data("kendoWindow").close();
          getsourcefielddrpdown();
          //TablefieldGriddata();
          Expressionclear();
      }

      function Expressionclear() {
          $("#txt_pplsourcefield_gid").val("");
          $("#txt_expression_name").val("");
          $("#drp_datatype").val("");
          $("#txt_expression_field").val("");
      }

      // Get references to the tab links and content divs
      const fieldmappingTab = document.getElementById("fieldmappingTab");
      const filtersTab = document.getElementById("filtersTab");
      const validationTab = document.getElementById("validationTab");
      const dataprocessingTab = document.getElementById("dataprocessingTab");

      const expressionConf = document.getElementById("expression_conf");
      const fieldmappingConf = document.getElementById("fieldmapping_conf");
      const filtersConf = document.getElementById("filters_conf");
      const validationConf = document.getElementById("validation_conf");
      const dataprocessingConf = document.getElementById("dataprocessing_conf");
      const finalizationConf = document.getElementById("finalization_conf");



      fieldmappingTab.addEventListener("click", () => {
          expressionConf.style.display = "none";
          fieldmappingConf.style.display = "block";
          filtersConf.style.display = "none";

          fieldmappingTab.classList.add("active");
          filtersTab.classList.remove("active");
      });

      filtersTab.addEventListener("click", () => {
          expressionConf.style.display = "none";
          fieldmappingConf.style.display = "none";
          filtersConf.style.display = "block";

          fieldmappingTab.classList.remove("active");
          filtersTab.classList.add("active");
      });

      validationTab.addEventListener("click", () => {
          fetchpplcond("Validation");
          dataprocessingConf.style.display = "none";
          validationConf.style.display = "block";

          dataprocessingTab.classList.remove("active");
          validationTab.classList.add("active");
      });

      dataprocessingTab.addEventListener("click", () => {
          dataprocessingConf.style.display = "block";
          validationConf.style.display = "none";

          dataprocessingTab.classList.add("active");
          validationTab.classList.remove("active");
      });


      function RejectionGrid(data1) {
          try {
              var data1 = [
                  { pplcondition_gid: "1", condition_name: "Credit Rule", condition_text: "credit_amt > 0", Action: "Delete" },
                  { pplcondition_gid: "2", condition_name: "Debit Rule", condition_text: "debit_amt > 0", Action: "Delete" },
                  // Add more data as needed
              ];
              $("#rejectionGrid").remove();
              $('#rejectionsearch').append('<div id="rejectionGrid" style="width: 96%; height: 350px; margin-left: 5px;"></div>');
              $("#rejectionGrid").kendoGrid({
                  dataSource: {
                      data: data1,
                      schema: {
                          model: {
                              fields: {
                                  pplcondition_gid: { type: "string" },
                                  condition_name: { type: "string" },
                                  condition_text: { type: "string" },
                                  expression_field: { type: "string" },
                                  Action: { type: "string" }
                              }
                          }
                      },
                      pageSize: 5
                  },
                  height: 248, // Corrected the height
                  width: "96%", // Use percentage for width

                  pageable: true,
                  sortable: true,
                  filterable: true,
                  selectable: "single",
                  columns: [
                      {
                          field: "pplcondition_gid",
                          title: "pplcondition_gid",
                          hidden: true
                      },
                      {
                          field: "condition_name",
                          title: "Rejection Name",
                          width: 200
                      },
                      {
                          field: "condition_text",
                          title: "Rejection rule",
                          width: 200
                      },
                      {
                          field: "Action",
                          title: "Action",
                          template: "<div class= 'action-cell' style = 'text-align: center;' > <i class='glyphicon glyphicon-pencil'style = color: green; cursor: pointer; ' title='Edit'></i> </t> </t> <i class='glyphicon glyphicon-trash' style='color:red;margin-left: 20% !important'></i></div>",
                          //template: "<i class='glyphicon glyphicon-trash' style='color:red;margin-left: 40% !important'></i>",
                          width: 80
                      }
                  ],
                  editable: "inline"
              });
          } catch (err) {
              jAlert(err, "Error");
          }
      }

      function FilterGrid(data1) {
          try {
              var data1 = [
                  { pplcondition_gid: "1", condition_name: "Credit Rule", condition_text: "credit_amt > 0", Action: "Delete" },
                  { pplcondition_gid: "2", condition_name: "Debit Rule", condition_text: "debit_amt > 0", Action: "Delete" },
                  // Add more data as needed
              ];
              $("#filterGrid").remove();
              $('#filtersearch').append('<div id="filterGrid" style="width: 96%; height: 350px; margin-left: 5px;"></div>');
              $("#filterGrid").kendoGrid({
                  dataSource: {
                      data: data1,
                      schema: {
                          model: {
                              fields: {
                                  pplcondition_gid: { type: "string" },
                                  condition_name: { type: "string" },
                                  condition_text: { type: "string" },
                                  expression_field: { type: "string" },
                                  Action: { type: "string" }
                              }
                          }
                      },
                      pageSize: 5
                  },
                  height: 248, // Corrected the height
                  width: "96%", // Use percentage for width

                  pageable: true,
                  sortable: true,
                  filterable: true,
                  selectable: "single",
                  columns: [
                      {
                          field: "pplcondition_gid",
                          title: "pplcondition_gid",
                          hidden: true
                      },
                      {
                          field: "condition_name",
                          title: "Filter Name",
                          width: 200
                      },
                      {
                          field: "condition_text",
                          title: "Filter rule",
                          width: 200
                      },
                      {
                          field: "Action",
                          title: "Action",
                          template: "<div class= 'action-cell' style = 'text-align: center;' > <i class='glyphicon glyphicon-pencil'style = color: green; cursor: pointer; ' title='Edit'></i> </t> <i class='glyphicon glyphicon-trash' style='color:red;margin-left: 20% !important'></i></div>",
                          //template: "<i class='glyphicon glyphicon-trash' style='color:red;margin-left: 40% !important'></i>",
                          width: 80
                      }
                  ],
                  editable: "inline"
              });
          } catch (err) {
              jAlert(err, "Error");
          }
      }

      function ValidationGrid(data1) {
          try {
              $("#validationGrid").remove();
              $('#validationsearch').append('<div id="validationGrid" style="width: 109%; height: 350px; margin-left: 5px;margin-top: -1%;"></div>');
              $("#validationGrid").kendoGrid({
                  dataSource: {
                      data: data1,
                      schema: {
                          model: {
                              fields: {
                                  pplcondition_gid: { type: "string" },
                                  condition_name: { type: "string" },
                                  condition_text: { type: "string" },
                                  expression_field: { type: "string" },
                                        // sys_flag:{ type: "string" },
                                  Action: { type: "string" }
                              }
                          }
                      },
                      pageSize: 5
                  },
                  height: 246, // Corrected the height
                  width: "109%", // Use percentage for width

                  pageable: true,
                  sortable: true,
                  filterable: true,
                  selectable: "single",
                  columns: [
                      {
                          field: "pplcondition_gid",
                          title: "pplcondition_gid",
                          hidden: true
                      },
                      {
                          field: "condition_name",
                          title: "Validation Name",
                          width: 100
                      },
                      {
                          field: "condition_text",
                          title: "Validation rule",
                          width: 150
                      },
                      {
                          field: "condition_msg",
                          title: "Message",
                          width: 150
                      },
                        {
                          field: "sys_flag",
                          title: "sys_flag",
                          hidden:true,
                      },
                      {
                          field: "Action",
                          title: "Action",

                          //template: "<i class='glyphicon glyphicon-trash' style='color:red;margin-left: 40% !important'></i>",
                            template: function (dataItem) {
                            if (dataItem.sys_flag =="N") {
                                  return `
                                      <div class='action-cell' style='text-align: center;'>
                                        <i class='glyphicon glyphicon-eye-open' onclick='viewValidationRule($(this))' style='color:blue; cursor: pointer; margin-right: 15%;' title='View'></i>
                                        <i class='glyphicon glyphicon-pencil' style='color: green; cursor: pointer;' title='Edit' onclick='editvalidationrule($(this))'></i>
                                        <i class='glyphicon glyphicon-trash' style='color:red; margin-left: 20%; cursor: pointer;' onclick='deleteValidationrule($(this))'></i>
                                      </div>`;

                                 // return "<div class= 'action-cell' style = 'text-align: center;' > <i class='glyphicon glyphicon-pencil' onclick='editvalidationrule($(this))' style = 'color: green; cursor: pointer; ' title='Edit'></i> </t> <i class='glyphicon glyphicon-trash' onclick='deleteValidationrule($(this))' style='color:red;margin-left: 20% !important'></i></div>";
                            }
                            else
                            {
                                        return "<div class= 'action-cell' style = 'text-align: center;' > <i class='glyphicon glyphicon-eye-open' onclick='viewValidationRule($(this))' style='color:blue; cursor: pointer; margin-right: 15%;' title='View'></i> <i class='glyphicon glyphicon-pencil'  style = 'color: grey; opacity:0.5;cursor: not-allowed;pointer-events: none;' title='Edit'></i> </t> <i class='glyphicon glyphicon-trash' style='color:grey;opacity:0.5;cursor: not-allowed;pointer-events: none;margin-left: 20% !important' ></i></div>";
                            }
                            },
                          sortable: false,
                          filterable: false,
                          width: 80
                      }
                  ],
                  editable: "inline"
              });
          } catch (err) {
              jAlert(err, "Error");
          }
      }

      function enabledisablevalidation(condition){
          const fields = [
            "txt_validation_name",
            "txt_validationcond",
            "txt_validation_msg",
            "btn_vlcheckquery",
            "btn_validationsave"
        ];
           fields.forEach(id => {
            const element = document.getElementById(id);
            if (element) {
                element.disabled = condition;

                if (condition) {
                    element.classList.add("custom-disabled");
                } else {
                    element.classList.remove("custom-disabled");
                }
            }
        });
      }

      function viewValidationRule(e) {
            enabledisablevalidation(true);
            var entityGrid = $("#validationGrid").data("kendoGrid");
            var pplcondgid = entityGrid.dataItem(e.select().closest("tr")).pplcondition_gid;
            var cond_name = entityGrid.dataItem(e.select().closest("tr")).condition_name;
            var cond_text = entityGrid.dataItem(e.select().closest("tr")).condition_text;
            var cond_msg = entityGrid.dataItem(e.select().closest("tr")).condition_msg;

            $('#txt_validation_gid').val(pplcondgid);
            $('#txt_validation_name').val(cond_name);
            $('#txt_validationcond').val(cond_text);
            $('#txt_validation_msg').val(cond_msg);
      }

      function editvalidationrule(e) {
          enabledisablevalidation(false);
          var entityGrid = $("#validationGrid").data("kendoGrid");
          var pplcondgid = entityGrid.dataItem(e.select().closest("tr")).pplcondition_gid;
          var cond_name = entityGrid.dataItem(e.select().closest("tr")).condition_name;
          var cond_text = entityGrid.dataItem(e.select().closest("tr")).condition_text;
          var cond_msg = entityGrid.dataItem(e.select().closest("tr")).condition_msg;

          $('#txt_validation_gid').val(pplcondgid);
          $('#txt_validation_name').val(cond_name);
          $('#txt_validationcond').val(cond_text);
          $('#txt_validation_msg').val(cond_msg);
      }

      function deleteValidationrule(e) {
          let text = "Are you sure to delete?";
          jConfirm(text, "Connector", function (f) {
              if (f == true) {
                  var entityGrid = $("#validationGrid").data("kendoGrid");
                  var v_pplcondition_gid = entityGrid.dataItem(e.select().closest("tr")).pplcondition_gid;
                  $.ajax({
                      type: "Post",
                      url: '@Url.Action("Deleteexistingpplcondition", "Pipeline")?id=' + v_pplcondition_gid,
                      dataType: "json",
                      success: function (response) {
                          jAlert(response, "Connector", function (g) {
                              if (g == true) {
                                  fetchpplcond("Validation");
                                  Validationclear();
                              }
                          });
                      },
                      error: function (er) {
                          jAlert(er, "Error");
                      }
                  });
              } else {
                  text = "You canceled!";
              }
          });
      }

      function Validationclear() {
          $('#txt_validation_gid').val("");
          $('#txt_validation_name').val("");
          $('#txt_validationcond').val("");
          $('#txt_validation_msg').val("");
      }

      function schedulecron_cond_old() {
          if ($('#run_type').val() == 'Scheduled Run') {
              //$('#txt_cronexpr').val("0 0 * * *");
              // document.getElementById('txt_cronexpr').disabled = true;
              document.getElementById('txt_cronexpr').disabled = false;
              document.getElementById("txt_cronexpr_s").style.display = "inline";
          }
          else {
              $('#txt_cronexpr').val("");
              document.getElementById('txt_cronexpr').disabled = true;
              document.getElementById("txt_cronexpr_s").style.display = "none";
          }
      }

      // 20-08-2024
      function schedulecron_cond() {
          document.getElementById('parentdataset').disabled = true;
          document.getElementById("txt_parentdataset_s").style.display = "none";
          $('#parentdataset').val("-- Select --");

          if ($('#run_type').val() == 'Scheduled Run') {
              //$('#txt_cronexpr').val("0 0 * * *");
              // document.getElementById('txt_cronexpr').disabled = true;
              document.getElementById('txt_cronexpr').disabled = true;
              document.getElementById("txt_cronexpr_s").style.display = "none";
              document.getElementById('btn_editscheduler').disabled = false;
              document.getElementById('btn_editscheduler').classList.remove('disabled');
              document.getElementById('btn_editscheduler').classList.add('set_val');
              document.getElementById("txt_cronexpr_s").style.display = "inline";

          }
          else if ($('#run_type').val() == 'Dependent') {
              document.getElementById('parentdataset').disabled = false;
              document.getElementById("txt_parentdataset_s").style.display = "inline";
          }
          else {
              $('#txt_cronexpr').val("");
              document.getElementById('txt_cronexpr').disabled = true;
              document.getElementById("txt_cronexpr_s").style.display = "none";
              document.getElementById('btn_editscheduler').disabled = true;
              document.getElementById('btn_editscheduler').classList.remove('set_val');
              document.getElementById('btn_editscheduler').classList.add('disabled');
              document.getElementById("txt_cronexpr_s").style.display = "none";
          }
      }
      // 20-08-2024
      function scheduler_pop() {
          if ($('#run_type').val() == 'Scheduled Run') {
              $('#scheduler_exp_Popup').show();
              var cronExpression = $('#txt_cronexpr').val();
              var cronParts = cronExpression.split(' ');
              $('#txt_second').val(cronParts[0]);
              $('#txt_minute').val(cronParts[1]);
              $('#txt_hour').val(cronParts[2]);
              $('#txt_dayhour').val(cronParts[3]);
              $('#txt_month').val(cronParts[4]);
              $("#txt_cronexpression").val(cronExpression);
          }
      }

      function pulllastxdays_cond() {
          if ($('#extract_mode').val() == 'Pull last X days' || $('#extract_mode').val() == 'Incremental records') {
              $('#txt_extractcond').val("");
              document.getElementById('txt_extractcond').disabled = false;
             
          }
          else {
              $('#txt_extractcond').val("");
              document.getElementById('txt_extractcond').disabled = true;
             
          }
      }

      function extractcond_label() {
          if ($('#extract_mode').val() == 'Pull last X days') {
              $("#div_lblExtractcond").text("Fields");
              document.getElementById('txt_pulllstxdays').disabled = false;
              document.getElementById("txt_pulllstxdays_s").style.display = "inline";
          }
          else {
              $("#div_lblExtractcond").text("Extract Condition");
              $('#txt_pulllstxdays').val("0");
              document.getElementById('txt_pulllstxdays').disabled = true;
              document.getElementById("txt_pulllstxdays_s").style.display = "none";
          }
      }

      function extracttext_cond() {
          if ($('#extract_mode').val() == 'Pull all records' || $('#extract_mode').val() == '--select--') {
              $('#txt_extractcond').val("");
              document.getElementById('txt_extractcond').disabled = true;
              document.getElementById('btn_submit').disabled = false;
          }
          else {
              document.getElementById('txt_extractcond').disabled = false;
              document.getElementById('btn_submit').disabled = true;
          }
          if ($('#extract_mode').val() == 'Incremental records') {
              document.getElementById('setVal').classList.remove('disabled');
              document.getElementById('setVal').classList.add('set_val');
          }
          else {
              document.getElementById('setVal').classList.add('disabled');
              document.getElementById('setVal').classList.remove('set_val');
          }
          extractcond_label();

      }
      function rejectduplicate_cond1() {
          if ($('#upload_mode').val() == 'Clean and Insert') {
              document.getElementById("chkbox_rejduplicate").checked = false;
              document.getElementById("chkbox_rejduplicate").disabled = true;
          }
          else {
              document.getElementById("chkbox_rejduplicate").disabled = false;
          }
      }
      function rejectduplicate_cond() {
          rejectduplicatedwn();
      }

      function submitBtnCondition() {
          if ($('#txt_extractcond').val().trim() == "") {
              document.getElementById('btn_submit').disabled = false;
          }
          else {
              document.getElementById('btn_submit').disabled = true;
          }
      }

      function Getpplstatus(type) {
          document.getElementById('pipelne').classList.remove('active');
          document.getElementById('datasource').classList.remove('active');
          document.getElementById('preprocess').classList.remove('active');
          document.getElementById('processing').classList.remove('active');
          document.getElementById('postprocessing').classList.add('active');
          $("#tab1").hide();
          $("#tab2").hide();
          $("#tab3").hide();
          $("#tab4").hide();
          $("#tab5").show();
          var dscode = $("#txtds_code").val();
          var pplcode = $("#txt_ppl_code").val();
          $.ajax({
              type: "GET",
              url: '@Url.Action("SetPPlStatus", "Pipeline")?type=' + type + "&dataset_code=" + dscode + "&pipeline_code=" + pplcode,
              success: function (res) {
                  $('#txt_ppl_status').val(res);
                  if (type == "finsave") {
                      pplfinsave();
                  }
                  else if (type == "fieldmappingInsert") {
                    //  PPLfieldMapInsert();
                  }
              },
              error: function (er) {
                  jAlert(er, "Error");
              }
          });
      }

      function SetValuePopUp() {
          $("#field_mappingPopup").show();
          setgridValue();
      }


      function setgridValue() {
          var pipelinecode = $('#txt_ppl_code').val();
          $.ajax({
              type: 'GET',
              url: '@Url.Action("GetIncrementalRecord", "Pipeline")?pipelinecode=' + pipelinecode,
              contentType: false,
              processData: false,
              cache: false,
              success: function (response) {
                  fetchgrid(response);
              },
              error: function (er) {
                  alert(er)
                  console.log(er)
              }
          });
      }

      function fetchgrid(data) {
          try {

              $("#grid_setvalue").kendoGrid({
                  dataSource: {
                      data: data,
                      schema: {
                          model: {
                              fields: {
                                  serialNumber: { type: "int", editable: false },
                                  incremental_gid: { type: "int", editable: false },
                                  pipeline_code: { type: "string", editable: false },
                                  incremental_field: { type: "string", editable: false },
                                  incremental_value: { type: "string", editable: true },
                                  delete_flag: { type: "string" },
                              }
                          }
                      },
                      pageSize: 10
                  },
                  height: 300,
                  width: 900,
                  editable: "inline",
                  editable: true,
                  pageable: true,
                  sortable: true,
                  filterable: true,
                  selectable: "single",
                  columns: [
                      {
                          field: "serialNumber",
                          title: "S.No",
                          width: 100,
                      },
                      {
                          field: "incremental_gid",
                          title: "incremental Gid",
                          width: 100,
                          hidden: true
                      },
                      {
                          field: "pipeline_code",
                          title: "pipeline_code",
                          width: 100,
                          hidden: true
                      },
                      {
                          field: "incremental_field",
                          title: "Incremental Field",
                          width: 100,
                      },
                      {
                          field: "incremental_value",
                          title: "Incremental Value",
                          width: 100,
                      }],
              });
          }
          catch (err) {
              alert(err);
          }
      }

      function addcsvColumns() {
          $("#csvColumn_Popup").show();
      }

      function GetSrcCsvlist(pipeline_code) {
          $.ajax({
              type: 'GET',
              url: '@Url.Action("GetAllCsvSource", "Pipeline")?pipelinecode=' + pipeline_code,
              contentType: false,
              processData: false,
              cache: false,
              success: function (response) {
                  SrcCsvGrid(response);
              },
              error: function (er) {
                  alert(er)
              }
          });
      }

      function saveCsvColumns() {
          var current_date = new Date;
          var ppl_code = $("#txt_ppl_code").val();
          var pplsrcgid = $('#txt_pplcsvfield_gid').val();
          var sourcefield_name = $('#txt_columnname').val().trim();
          var sourcefield_datatype = $('#drp_csvcol_datatype').val();
          //var serila_no = $('#txt_serialno').val().trim();
          var serila_no = parseFloat($('#txt_serialno').val().trim());
          var dataset_code = "";
          if (serila_no == "" || serila_no == "0" || serila_no == 0 || serila_no <= 0) {
              jAlert("Serial No cannot be blank or Zero", "Connector");
              return;
          }
          if (sourcefield_name == "") {
              jAlert("Column name cannot be blank ", "Connector");
              return;
          }

          if (sourcefield_datatype == "-- Select --") {
              jAlert("Please select the Column Type ", "Connector");
              return;
          }

          if($('#txt_pplcsvheader_gid').val()== ""){
              jAlert("Please CSV Header ", "Connector");
              return;
          }

          if (pplsrcgid == "") {
              var data = {};
              data.pplsourcefield_gid = pplsrcgid;
              data.pipeline_code = ppl_code;
              data.sourcefield_name = sourcefield_name;
              data.sourcefield_datatype = sourcefield_datatype;
              data.sourcefield_sno = serila_no
              data.source_type = "CSV";
              data.created_date = current_date;
              data.created_by = _user_code;
              data.dataset_code = dataset_code;
              $.ajax({
                  type: "Post",
                  url: '@Url.Action("Addnewpplcsvsourcefield", "Pipeline")',
                  data: JSON.stringify(data),
                  dataType: "json",
                  contentType: 'application/json; charset=utf-8',
                  success: function (response) {
                      jAlert(response, "Connector");
                      if (response == "Record Inserted Successfully") {
                          GetSrcCsvlist(ppl_code);
                          Clearcsvsrcfield();
                      }
                  },
                  error: function (er) {
                      jAlert(er, "Error");
                  }
              });
          }
          else {
              var data = {};
              data.pplsourcefield_gid = pplsrcgid;
              data.pipeline_code = ppl_code;
              data.sourcefield_name = sourcefield_name;
              data.sourcefield_datatype = sourcefield_datatype;
              data.sourcefield_sno = serila_no
              data.source_type = "CSV";
              data.updated_date = current_date;
              data.created_by = _user_code;
              data.dataset_code = dataset_code;
              $.ajax({
                  type: "Post",
                  url: '@Url.Action("Updateexistingpplcsvsrcfield", "Pipeline")',
                  data: JSON.stringify(data),
                  dataType: "json",
                  contentType: 'application/json; charset=utf-8',
                  success: function (response) {
                      jAlert(response, "Connector");
                      if (response == "Record Updated Successfully") {
                          GetSrcCsvlist(ppl_code);
                          Clearcsvsrcfield();
                      }

                  },
                  error: function (er) {
                      jAlert(er, "Error");
                  }
              });
          }
      }

      function deleteCsvSrcfield(e) {
               let text = "On changing any Columns (Expression, Inclusion,\n" +
              "Rejection, Validation, Conversion Rules) will be deleted.\n " +
              " Are you sure to change ?  ";
          jConfirm(text, "Connector", function (f) {
              if (f == true) {
          var pipelineCode = $('#txt_ppl_code').val();
          var data = {};
          data.dataset_systemflag = "";
          data.pipelinedet_id = 0;
          data.pipeline_code = pipelineCode;
          data.dataset_name = "",
          data.datasetCode = "";
          data.dataset_id = 0;
          data.dataset_category = "",
          data.clone_dataset = "";
          data.active_status = "";
          data.inactive_reason = "";
          data.in_action = "EXCELCHANGE";
          data.in_action_by =_user_code;
          $.ajax({
          type: "Post",
          url: '@Url.Action("datasetheader", "Pipeline")',
          data: JSON.stringify(data),
          dataType: "json",
          contentType: 'application/json; charset=utf-8',
          success: function (response) {
              var res = JSON.parse(response);
                 if(res.length >= 0 && res[0].out_result == 1){
                     var ppl_code = $("#txt_ppl_code").val();
                    var entityGrid = $("#SrcCsvGrid").data("kendoGrid");
                    var v_pplsourcefield_gid = entityGrid.dataItem(e.select().closest("tr")).pplsourcefield_gid;
                    $.ajax({
                        type: "Post",
                        url: '@Url.Action("Deleteexistingpplsourcefield", "Pipeline")?id=' + v_pplsourcefield_gid,
                        dataType: "json",
                        success: function (response) {
                            jAlert(response, "Connector", function (g) {
                                if (g == true) {
                                    GetSrcCsvlist(ppl_code);
                                }
                            });
                        },
                        error: function (er) {
                            jAlert(er, "Error");
                        }
                    });
                    } else {
                         jAlert(res[0].out_msg, "Connector");
                    }
              },
          error: function (er) {
              jAlert(er, "Error");
          }
          });
              } else {
                    jAlert("You Cancelled ..!");
              }
          });
          }

      function SrcCsvGrid(data) {
          try {
              $("#SrcCsvGrid").remove();
              $('#srccsvsearch').append('<div id="SrcCsvGrid" style="width: 98%; height: 350px !important; margin-top: 15px;margin-left: 0px;"></div>');
              $("#SrcCsvGrid").kendoGrid({
                  dataSource: {
                      data: data,
                      schema: {
                          model: {
                              fields: {
                                  pplsourcefield_gid: { type: "string" },
                                  Action: { type: "string" },
                                  sourcefield_sno: { type: "integer" },
                                  sourcefield_name: { type: "string" },
                                  sourcefield_datatype: { type: "string" },
                              }
                          }
                      },
                      pageSize: 2000,
                  },
                  height: 306,
                  width: 1058,
                  pageable: true,
                  sortable: true,
                  filterable: true,
                  selectable: "single",
                  columns: [
                      {
                          field: "pplsourcefield_gid",
                          title: "pplsourcefield_gid",
                          hidden: true,
                          width: 50
                      },
                      {
                          field: "Action",
                          title: "Action", // Change column title
                          template: "<div class= 'action-cell' style = 'text-align: center;' > <i class='glyphicon glyphicon-pencil' onclick='editcsvsrcfield($(this))' style = color: green; cursor: pointer; ' title='Edit'></i> </t> </t> <i class='glyphicon glyphicon-trash' onclick='deleteCsvSrcfield($(this))' style='color:red;margin-left: 20% !important'></i></div>",
                          sortable: false,
                          filterable: false,
                          width: 50
                      },
                      {
                          field: "sourcefield_sno",
                          title: "Serial No",
                          width: 50
                      },
                      {
                          field: "sourcefield_name",
                          title: "Column Name",
                          width: 150
                      },
                      {
                          field: "sourcefield_datatype",
                          title: "Type",
                          width: 150
                      }

                  ],
                  editable: false
              });
          }
          catch (err) {
              jAlert(er, "Error");
          }
      }

      function editcsvsrcfield(e) {
          addcsvColumns();
          var entityGrid = $("#SrcCsvGrid").data("kendoGrid");
          var pplsrcgid = entityGrid.dataItem(e.select().closest("tr")).pplsourcefield_gid;
          var srcfield_sno = entityGrid.dataItem(e.select().closest("tr")).sourcefield_sno;
          var srcfield_name = entityGrid.dataItem(e.select().closest("tr")).sourcefield_name;
          var srcfield_datatype = entityGrid.dataItem(e.select().closest("tr")).sourcefield_datatype;

          $('#txt_pplcsvfield_gid').val(pplsrcgid);
          $('#txt_serialno').val(srcfield_sno);
          $('#txt_columnname').val(srcfield_name);
          $('#drp_csvcol_datatype').val(srcfield_datatype);
      }

      function Clearcsvsrcfield() {
          $('#txt_pplcsvfield_gid').val("");
          $('#txt_serialno').val("");
          $('#txt_columnname').val("");
          $('#drp_csvcol_datatype').val("");
      }

      function saveCsvHeader() {
          var current_date = new Date;
          var pplcsvhdr_gid = $("#txt_pplcsvheader_gid").val();
          var ppl_code = $("#txt_ppl_code").val();
          var col_separator = $("#txt_columnseparator").val().trim();
          var num_ofcolumns = $('#txt_number_of_columns').val().trim();
          var csv_dateformat = $('#txt_date_format').val().trim();
          var csv_datetimeformat = $('#txt_datetime_format').val().trim();
          var lines_toskip = $('#txt_linesto_skip').val().trim();
          if (lines_toskip == "" || lines_toskip == null) lines_toskip = "0"
          if (col_separator == "") {
              jAlert("Column Separator cannot be blank ", "Connector");
              return;
          }

          if (num_ofcolumns == "") {
              jAlert("Number of columns cannot be blank ", "Connector");
              return;
          }

          if (csv_datetimeformat != "QCD_SELECT" && csv_dateformat == "QCD_SELECT") {
              jAlert("Date Format cannot be blank ", "Connector");
              return;
          }

          if (pplcsvhdr_gid == "") {
              var data = {};
              data.pplcsvheader_gid = pplcsvhdr_gid;
              data.pipeline_code = ppl_code;
              data.column_separator = col_separator;
              data.number_ofcolumns = num_ofcolumns;
              data.csvfile_dateformat = csv_dateformat;
              data.csvfile_datetimeformat = csv_datetimeformat;
              data.number_oflines_toskip = lines_toskip;
              data.created_date = current_date;
              data.created_by = _user_code;

              $.ajax({
                  type: "Post",
                  url: '@Url.Action("Addnewpplcsvheader", "Pipeline")',
                  data: JSON.stringify(data),
                  dataType: "json",
                  contentType: 'application/json; charset=utf-8',
                  success: function (response) {
                      jAlert(response, "Connector");
                      if (response == "Record Inserted Successfully") {
                          fetchpplcsvheader();
                         document.getElementById("btn_nextppl1").disabled = false;
                      }
                  },
                  error: function (er) {
                      jAlert(er, "Error");
                  }
              });
          }
          else {
              var data = {};
              data.pplcsvheader_gid = pplcsvhdr_gid;
              data.pipeline_code = ppl_code;
              data.column_separator = col_separator;
              data.number_ofcolumns = num_ofcolumns;
              data.csvfile_dateformat = csv_dateformat;
              data.csvfile_datetimeformat = csv_datetimeformat;
              data.number_oflines_toskip = lines_toskip;
              data.updated_date = current_date;
              data.updated_by = _user_code;

              $.ajax({
                  type: "Post",
                  url: '@Url.Action("Updateexistingpplcsvheader", "Pipeline")',
                  data: JSON.stringify(data),
                  dataType: "json",
                  contentType: 'application/json; charset=utf-8',
                  success: function (response) {
                      jAlert(response, "Connector");
                      if (response == "Record Updated Successfully") {
                          fetchpplcsvheader();
                          document.getElementById("btn_nextppl1").disabled = false;
                      }
                  },
                  error: function (er) {
                      jAlert(er, "Error");
                  }
              });
          }
      }

      function fetchpplcsvheader() {
          var ppl_code = $('#txt_ppl_code').val();

          $.ajax({
              type: "GET",
              url: '@Url.Action("ReadpipelineCsvHeader", "Pipeline")?pipelinecode=' + ppl_code,
              dataType: "json",
              contentType: 'application/json; charset=utf-8',
              success: function (response) {
                  if (response.length > 0) {
                      $('#txt_pplcsvheader_gid').val(response[0].pplcsvheader_gid);
                      $('#txt_columnseparator').val((response[0].column_separator).toString());
                      $('#txt_number_of_columns').val(response[0].number_ofcolumns);
                      $('#txt_date_format').val((response[0].csvfile_dateformat).toString());
                      $('#txt_datetime_format').val((response[0].csvfile_datetimeformat).toString());
                      $('#txt_linesto_skip').val(response[0].number_oflines_toskip);
                  }
              },
              error: function (er) {
                  jAlert(er, "Error");
              }
          });
      }

      function validateNumberInput(input, type) {
          if (type == "serialno") {
              // Remove any non-numeric characters
              //input.value = input.value.replace(/[^1-9]/g, '');
               const rawValue = input.value.trim();
                if (rawValue === "0") return;           
                const valid = /^[1-9]\d*$/.test(rawValue);
                if (!valid) {
                    input.value = "";
                    jAlert("Please enter a valid non-negative integer without leading zeros", "Connector");
                }
              }
              else {
                  input.value = input.value.replace(/[^0-9]/g, '');
              }
      }

      function DownloadTemplate() {
          var pipelineCode = $("#txt_ppl_code").val(); 
          if (!pipelineCode) {
              jAlert("Pipeline code is required.", "Error");
              return;
          }
          var fileext_val = $('#txt_fileextension').val();
          if (fileext_val == "") {
              fileext_val = input.toString();
          }
          var extension = fileext_val;
          var lastIndex = extension.lastIndexOf(".");
          if (lastIndex !== -1) {
              var fileexts = extension.substring(lastIndex);
               var filename = extension.substring(0, lastIndex);
          }
          var downloadUrl = `@Url.Action("TemplateDownload", "Pipeline")?pipelinecode=${encodeURIComponent(pipelineCode)}&fileExtension=${encodeURIComponent(fileexts)}&sourceFileName=${encodeURIComponent(filename)}`;
          window.location.href = downloadUrl;
      }

        function DownloadMacroTemplate(){
            var pipelineCode = $("#txt_ppl_code").val();
          if (!pipelineCode) {
              jAlert("Pipeline code is required.", "Error");
              return;
          } 
          var fileext_val = $('#txt_macrofileextension').val();
          if (fileext_val == "") {
              fileext_val = input.toString();
          }
          var extension = fileext_val;
          var lastIndex = extension.lastIndexOf(".");
          if (lastIndex !== -1) {
              var fileexts = extension.substring(lastIndex);
               var filename = extension.substring(0, lastIndex);
          }
          var downloadUrl = `@Url.Action("TemplateDownload", "Pipeline")?pipelinecode=${encodeURIComponent(pipelineCode)}&fileExtension=${encodeURIComponent(fileexts)}&sourceFileName=${encodeURIComponent(filename)}`;
          window.location.href = downloadUrl;
        }

      function GetDrpDownDateList() {
          $.ajax({
              url: '@Url.Action("getQCDMasterData", "Pipeline")?parentCode=' + "QCD_DATE_FORMAT" + "& depend_code=''", // Replace with your controller action URL
              method: 'POST',
              dataType: 'json',
              success: function (data) {
                  dateformatfield = data;
                  // Populate the dropdown with data
                  var dropdown = $('#txt_date_format');
                  dropdown.empty();

                  $.each(data, function (key, entry) {
                      dropdown.append($('<option></option>').val(entry.id).text(entry.name));
                  });
              },
              error: function (er) {
                  jAlert(er, "Error");
              }
          });
      }

      function GetDrpDownTimeList() {
          $.ajax({
              url: '@Url.Action("getQCDMasterData", "Pipeline")?parentCode=' + "QCD_TIME_FORMAT" + "& depend_code=''", // Replace with your controller action URL
              method: 'POST',
              dataType: 'json',
              success: function (data) {
                  // Populate the dropdown with data
                  var dropdown = $('#txt_datetime_format');
                  dropdown.empty();

                  $.each(data, function (key, entry) {
                      dropdown.append($('<option></option>').val(entry.id).text(entry.name));
                  });
              },
              error: function (er) {
                  jAlert(er, "Error");
              }
          });
      }

    function loaddatasetgrid(datasetfield) {
       $("#grid_datasetfield").remove();
       $('#dsgrid').append('<div id="grid_datasetfield" style="width: 96%; height: 230px !important; margin-top: 10px;margin-left: 15px;"></div>');
       $("#grid_datasetfield").kendoGrid({
      dataSource: {
      data: datasetfield,
      pageSize: 100,
      schema: {
      model: {
          fields: {
              dataset_gid: { type: "string", defaultValue: 0},
              dataset_name: {type: "string"},
              dataset_field: { type: "string" },
              field_type: { type: "string", defaultValue: "TEXT"},
              field_length: { type: "string", defaultValue: "255"},
              mandatory: { type: "string"},
              seq_no: {type: "string"},
              target_dataset_field: {type: "string"},
              source_dataset_field: {type: "string"}
              }
          }
        }
      },
      height: 200,
      edit: OnEdit,
      dataBound: function (e) {
              resultData = e.sender._data;
              var rows = $('#grid_datasetfield').data('kendoGrid').tbody.children();
          },
      height: 200,
      width: 1058,
      editable: '',
      pageable: false,
      sortable: true,
      filterable: true,
      selectable: "row",
      toolbar: "<a href='javascript:void(0)' onclick='add()' > <span class='glyphicon glyphicon-plus' style = 'color:white' > </span></a> ",
      columns: [
      {
          field: "dataset_gid",
          title: "dataset_gid",
          hidden: true,
      },
           {
              field: "Action",
              title: "Action",
              template: "<div class= 'action-cell' style = 'text-align: center;' > </t> <i class='glyphicon glyphicon-trash' style='color:red;margin-left: 20% !important'></i></div>",
              sortable: false,
              filterable: false,
              width: 50
          },
      {
          field: "dataset_name",
          title: "Dataset Name",
          editor: datanameEditor,
          width: 100,
      },
      {
          field: "dataset_field",
          title: "Dataset Field",
          width: 100,
      },{
          field : "seq_no",
          title: "seq_no",
          width:10,
          hidden: true
      },
      {
          field: "field_type",
          title: "Field Type",
          editor: fieldTypeEditor,
          width:100,
      },
      {
          field: "field_length",
          title: "Field Length",
          width:50
      },
       {
           field: "field_typeval",
           title: "Field Typeval",
           hidden: true
       },
      {
      field: "mandatory",
      title: "Mandatory",
      width: 70,
      template: function (dataItem) {
      if (dataItem.dataset_gid > 0) {
          return '<input type="checkbox" ' + (dataItem.dataset_gid == "Y" ? 'checked="checked"' : '') + ' class="chkbx1" />';
      } else {
          return '<input type="checkbox" ' + (dataItem.dataset_gid == "Y" ? 'checked="checked"' : '') + ' class="chkbx1" />';
      }
      }
      }],
      editable: true,
      });

      $(function () {
          $('#grid_datasetfield').on('click', '.chkbx1', function () {
          var checked = $(this).is(':checked');
          var grid = $('#grid_datasetfield').data().kendoGrid;
          var dataItem = grid.dataItem($(this).closest('tr'));
          var row = $(this).closest('tr');
          if (checked == true) {
          dataItem._set('mandatory', 'Y');
          }
          else {
          dataItem._set('mandatory', 'N');
          }
          })
         });
      }

      function OnEdit(e) {
          try {
          setDefaultValues(e);
          }
          catch (err) {
          javascript_log4j_root(arguments.callee.name, err);
          }
      }

      function setDefaultValues(e) {
              if (e.type != "click" || e.type == undefined) {
                  if (e.action == "" || e.action == undefined) {
                      for (var i = 0; i < e.sender._data.length; i++) {
                          var rows = e.sender.tbody.children();
                          var row = $(rows[i]);
                          row.css('backgroundColor', 'transparent')
                      }
                  }
              }
          }

      function add() {
         ds_name1 = "sheet1";
          if($("#txt_source_db_type").val() == "API") {
              ds_name1 = selectedAPIDS;
          } else {
                ds_name1 = "sheet1";
          }
          var grid = $("#grid_dsfieldMapping").data("kendoGrid");
          var dataSource = grid.dataSource;
          var rowIndex = 2;
          grid.select("tr:eq(" + rowIndex + ")");
          var max = 0;
          var lastSeqNo = grid.dataSource._data.length;
          var newSeqNo = parseInt(lastSeqNo) + 1;
            dataSource.add({seq_no: newSeqNo, mandatory: "N",dataset_field: "", field_type: "TEXT",field_length: "255", dataset_gid: 0,  field_typeval: "", target_dataset_field: "", source_dataset_field: "", dataset_name: ds_name1});
          var lastRow = grid.tbody.children().last();
          grid.content.scrollTop(lastRow.position().top);
          grid.refresh();
      }

      function addfieldmapping() {
          var ds_code = $("#txtds_code").val();
          var ppl_code = $("#txt_ppl_code").val();
          var grid = $("#grid_dsfieldMapping").data("kendoGrid");
          var dataSource = grid.dataSource;
            var newSeqNo = (dataSource.data().length + 1).toFixed(2);

          var newRow = dataSource.add({
              dataset_gid: "0",
              dataset_code: ds_code,
              datasetfield_gid: "0",
              dataset_code1: ds_code,
              dataset_seqno: newSeqNo,
              field_name: "-- Select --",
              field_type: "TEXT",
              field_length: "255",
              precision_length: "0",
              scale_length: "0",
              field_mandatory: "N",
              dataset_field_sno: "0",
              dataset_table_field: "",
              status: "Active",
              pipeline_code: ppl_code,
              pplfieldmapping_gid: "0",
              pplfieldmapping_flag: "0",
              ppl_field_name: "",
              dataset_field_name: "",
              default_value: "",
              pplsourcefield_format: "--Select--",
              pplsourcefield_gid: "0",
              parent_pipeline_code: "",
              Action: "",
              pipelinedet_dataset_type: "New",
              field_mapped: "N",
              its_parent_pipeline: "Y"
          });

          newRow.set("field_name", "--Select--");

          newRow.dirty = true;
          dataSource.sync();
          grid.refresh();

          var lastRow = grid.tbody.find("tr").last();
          grid.editRow(lastRow);
             setTimeout(function () {
            var cellIndex = grid.columns.findIndex(c => c.field === "ppl_field_name");
            if (cellIndex !== -1) {
                var cell = lastRow.find("td:eq(" + cellIndex + ")");
                grid.editCell(cell);
            }
        }, 0);
      }

      function deletefieldmapping(iconElement) {
          var grid = $("#grid_dsfieldMapping").data("kendoGrid");
          var row = $(iconElement).closest("tr");
          var dataItem = grid.dataItem(row);
            if(dataItem.pplfieldmapping_gid == "0") {
                  grid.dataSource.remove(dataItem);
            } else {
              let text = "Are you sure to delete?";
              jConfirm(text, "Connector", function (f) {
              if (f == true) {
                  var data = {
                      datasetCode: dataItem.dataset_code,
                      datasetdetail_id: parseInt(dataItem.datasetfield_gid),
                      field_name: dataItem.field_name,
                      field_type: dataItem.field_type,
                      field_length: dataItem.field_length,
                      precision_length: dataItem.precision_length ? parseInt(dataItem.precision_length): 0,
                      scale_length: dataItem.scale_length ? parseInt(dataItem.scale_length) : 0,
                      field_mandatory: dataItem.field_mandatory,
                      dataset_seqno: dataItem.dataset_seqno ? parseFloat(dataItem.dataset_seqno) : 0.00,
                      in_action: "DELETE",
                      in_action_by: _user_code
                  };

                $.ajax({
                type: "Post",
                  url: '@Url.Action("datasetdetail", "Pipeline")',
                data: JSON.stringify(data),
                dataType: "json",
                contentType: 'application/json; charset=utf-8',
                success: function (response) {
                   var res = JSON.parse(response);
                     if(res.length >= 0 && res[0].out_result == 1){
                     var pplfieldmap_gid = parseInt(dataItem.pplfieldmapping_gid);
                    $.ajax({
                        type: "Post",
                        url: '@Url.Action("Deletepplfieldmap", "Pipeline")?id=' + pplfieldmap_gid,
                        dataType: "json",
                        contentType: 'application/json; charset=utf-8',
                        success: function (response) {
                           jAlert(response, "Connector");
                          if (response == "Deleted Successfully..!") {
                              getdatasetfield();
                        }

                        },
                        error: function (er) {
                            jAlert(er, "Error");
                        }
                    });

                       }
                },
                error: function (er) {
                    jAlert(er, "Error");
                }
            });
              } else {
                    text = "You canceled!";
                }
                });
            }
      }

      function cmbsourcefield() {
          return arr1 = [
          {
              code: "TEXT",
              desc: "TEXT"
          },
          {
              code: "DATE",
              desc: "DATE"
          },
          {
              code: "DATETIME",
              desc: "DATE TIME"
          },
          {
              code: "NUMERIC",
              desc: "NUMERIC"
          },
          {
              code: "INTEGER",
              desc: "INTEGER"
          },
          ];

      }

      function fieldTypeEditor(container, options) {
          var dropdown = $("<select id='" + options.field + "' name='" + options.field + "' style='width:100%; color:black;'></select>");

          for (var i = 0; i < field_list.length; i++) {
              var optionId = field_list[i].code;
              var optionName = field_list[i].desc;
              dropdown.append("<option value='" + optionId + "'>" + optionName + "</option>");
          }

          dropdown.appendTo(container);
          dropdown.val(options.model.get(options.field));
          dropdown.change(function() {
              var selectedValue = $(this).val();
              options.model.set("field_length", " ");
              options.model.set(options.field, selectedValue);
          });
      }

      function datanameEditor(container, options) {
            var dropdown = $("<select name='" + options.field + "' style='width:100%; color:black;'>");
                 for (var i = 0; i < dataset_name.length; i++) {
                      var ds_code = dataset_name[i].code;
                      var ds_name = dataset_name[i].desc;
                   var textColor = 'color: black; width:100%;';
                       dropdown.append("<option style='" + textColor + "' value='"+ds_code+"'>"+ds_name+"</option>");
               }
                dropdown.val(options.model.dataset_name);
              dropdown.change(function() {
                  var selectedValue = $(this).val();
                    options.model.set(options.field, options);
              });
              dropdown.appendTo(container);
      }

       function datafieldEditor(container, options) {
          var sourceType = options.model.get("source_type");
          var pplDatasetType = options.model.get("pipelinedet_dataset_type");
          var dropdownId = 'source_field_' + options.model.uid;
          var isDisabled = (options.model.get("system_flag") === 'P' && sourceType !== "Expression" && options.model.get("its_parent_pipeline") == 'Y') &&
                    options.model.get("pipelinedet_dataset_type") != "New";
          var disabledAttr = isDisabled ? 'disabled="disabled"' : '';
          var currentValue = options.model.get("ppl_field_name")?.trim() || "";
          var dropdownHTML = '<select id="' + dropdownId + '" ' + disabledAttr + ' style="width:100%; height: 22px; border-radius: 6px;" class="source-field-dropdown">';
          var pplFieldName = (pplDatasetType === "Matched" || pplDatasetType === "New")  ? options.model.get("field_name") : options.model.get("ppl_field_name");
         if(pplDatasetType == "Matched") {
                   //var data = sourceFieldNames.filter(item => (item.source_type == 'Expression' || item.sourcefield_name == pplFieldName));
                    var grid = $("#grid_dsfieldMapping").data("kendoGrid");
                    var dataItems = grid.dataSource.view();

                    function normalize(name) {
                        return name ? name.replace(/^\*\s*/, '').trim().toLowerCase() : '';
                    }

                    var normalizedCurrent = normalize(currentValue);
                        // 1. Get all mapped ppl_field_names (excluding empty & "-- Select --")
                    var mappedFields = dataItems
                        .map(item => normalize(item.ppl_field_name))
                        .filter(name => name && name !== '-- select --');

                    // 2. Filter sourceFieldNames first for Expression or exact match
                    var data = sourceFieldNames.filter(item => {
                        return (
                            item.source_type === 'Expression' ||
                            item.sourcefield_name === pplFieldName
                        );
                    });

                    // 3. Remove already mapped fields (except current value)
                    data = data.filter(item => {
                        var normalizedSource = normalize(item.sourcefield_name);
                        return (
                            normalizedSource === normalizedCurrent || // allow current even if mapped
                            !mappedFields.includes(normalizedSource)
                        );
                    });
                   for (var i = 0; i < data.length; i++) {
                    var option = data[i].sourcefield_name;
                    var optionValue = option.startsWith("*") ? option.substring(1) : option;
                    var selected = option === currentValue ? 'selected' : '';
                    var textColor = option.startsWith("*") ? 'color: red;' : 'color: black;';
                    dropdownHTML += '<option style="' + textColor + '" value="' + optionValue + '" ' + selected + '>' + option + '</option>';
                }
         } else if(pplDatasetType == "Unmatched") {
                         var grid = $("#grid_dsfieldMapping").data("kendoGrid");
                        var dataItems = grid.dataSource.view();

                        // Get selected ppl_field_name values, excluding '-- Select --'
                        var getpplfieldName = dataItems
                            .filter(item => item.ppl_field_name && item.ppl_field_name.trim() !== '-- Select --')
                            .map(item => item.ppl_field_name.trim().toLowerCase()); // Normalize for comparison

                        // Filter sourceFieldNames based on sourcefield_name property
                        var filteredSourceFields = sourceFieldNames.filter(obj =>
                            !getpplfieldName.includes(obj.sourcefield_name.trim().toLowerCase())
                        );
                     var data = filteredSourceFields;
                     for (var i = 0; i < data.length; i++) {
                        var option = data[i].sourcefield_name;
                      var optionValue = option.startsWith("*") ? option.substring(1) : option;
                      var selected = option === currentValue ? 'selected' : '';
                      var textColor = option.startsWith("*") ? 'color: red;' : 'color: black;';
                      dropdownHTML += '<option style="' + textColor + '" value="' + optionValue + '" ' + selected + '>' + option + '</option>';
         }
           }else if(pplDatasetType == "New" && parseInt(options.model.pplfieldmapping_gid) > 0) {
                 if (sourceType != "Expression"){
                        var grid = $("#grid_dsfieldMapping").data("kendoGrid");
                        var dataItems = grid.dataSource.view();

                        // Normalize helper
                        function normalize(name) {
                            return name ? name.replace(/^\*\s*/, '').trim().toLowerCase() : '';
                        }

                        var normalizedCurrent = normalize(currentValue);
                        var normalizedPplField = normalize(pplFieldName);

                        // STEP 1: Initial filtering (Expression, pplFieldName match, "-- Select --")
                        let initialFiltered = sourceFieldNames.filter(item => {
                            const normalizedSource = normalize(item.sourcefield_name);
                            return (
                                item.source_type === 'Expression' ||
                                item.sourcefield_name === "-- Select --" ||
                                normalizedSource === normalizedPplField ||
                                (normalizedPplField && normalizedSource.includes(normalizedPplField))
                            );
                        });

                        // STEP 2: Get all mapped ppl_field_name values in the grid (normalized)
                        let mappedFields = dataItems
                            .map(item => normalize(item.ppl_field_name))
                            .filter(name => name && name !== '-- select --');

                        // STEP 3: Filter out already mapped fields unless it's the current value
                        var data = initialFiltered.filter(item => {
                            const normalizedSource = normalize(item.sourcefield_name);
                            return (
                                normalizedSource === normalizedCurrent || // keep current value in dropdown
                                !mappedFields.includes(normalizedSource)
                            );
                        });
                        //  var data = sourceFieldNames.filter(item =>
                        //     item.source_type === 'Expression' ||
                        //     item.sourcefield_name === pplFieldName ||
                        //     item.sourcefield_name === "-- Select --" ||
                        //     (pplFieldName && item.sourcefield_name && item.sourcefield_name.includes(pplFieldName))
                        // );
                     for(var i = 0; i < data.length; i++) {
                         var option = data[i].sourcefield_name;
                         var optionValue = option.startsWith("*") ? option.substring(1) : option;
                         var selected = option === currentValue ? 'selected' : '';
                         var textColor = option.startsWith("*") ? 'color: red;' : 'color: black;';
                         dropdownHTML += '<option style="' + textColor + '" value="' + optionValue + '" ' + selected + '>' + option + '</option>';
                     }
                 }else{                     
                        var data = sourceFieldNames.filter(item =>
                            item.source_type === 'Expression' ||
                            item.sourcefield_name === pplFieldName ||
                            item.sourcefield_name === "-- Select --" ||
                            (pplFieldName && item.sourcefield_name && item.sourcefield_name.includes(pplFieldName))
                        );
                      for (var i = 0; i < data.length; i++) {
                      var option = data[i].sourcefield_name;
                    var optionValue = option.startsWith("*") ? option.substring(1) : option;
                    var selected = option === currentValue ? 'selected' : '';
                    var textColor = option.startsWith("*") ? 'color: red;' : 'color: black;';
                    dropdownHTML += '<option style="' + textColor + '" value="' + optionValue + '" ' + selected + '>' + option + '</option>';
                   }
                 }
              } else if(pplDatasetType == "New" && parseInt(options.model.pplfieldmapping_gid) == 0) {
                        var data = sourceFieldNames.filter(item => (item.source_type == 'Expression' || item.sourcefield_name == "-- Select --"));
                        for (var i = 0; i < data.length; i++) {
                        var option = data[i].sourcefield_name;
                      var optionValue = option.startsWith("*") ? option.substring(1) : option;
                      var selected = option === currentValue ? 'selected' : '';
                      var textColor = option.startsWith("*") ? 'color: red;' : 'color: black;';
                      dropdownHTML += '<option style="' + textColor + '" value="' + optionValue + '" ' + selected + '>' + option + '</option>';

                        }
              }
          dropdownHTML += '</select>';
          container.append(dropdownHTML);

          if (!isDisabled) {
              $('#' + dropdownId).on('change', function () {
                  var selectedName = $(this).find("option:selected").text();
                  var mapped = (selectedName === "-- Select --" || selectedName === "--Select--") ? 'N' : 'Y';

                  // Update model fields
                  options.model.set("ppl_field_name", selectedName);
                  options.model.set("field_mapped", mapped);
                  if(pplDatasetType == "New" && parseInt(options.model.pplfieldmapping_gid) == 0) {
                    options.model.set("field_name", selectedName.startsWith("*") ? selectedName.substring(1) : selectedName);
                  }

                  // Find the grid and the corresponding row
                  var grid = $("#grid_dsfieldMapping").data("kendoGrid");
                  var row = grid.table.find("tr[data-uid='" + options.model.uid + "']");
                  var checkbox = row.find(".chkbxFieldmapping");

                  // Update checkbox in that specific row
                  checkbox.prop("checked", mapped === 'Y');
              });
          }
      }

</script>

@* Hema *@

<script>
        document.addEventListener("DOMContentLoaded", function () {
            const radioButtons = document.querySelectorAll('input[name="radioFilter"]');
            const formNoneDiv = document.getElementById("formnone");
            const formDataDiv = document.getElementById("formdata");
            const rawDiv = document.getElementById("raw");
            const rawOptionsDiv = document.getElementById("rawoptions");

            radioButtons.forEach(radio => {
                radio.addEventListener("change", function () {
                    if (this.value === "formdata") {
                        formDataDiv.style.display = "block";
                        rawDiv.style.display = "none";
                        rawOptionsDiv.style.display = "none";
                    } else if (this.value === "raw") {
                        formDataDiv.style.display = "none";
                        rawDiv.style.display = "block";
                        rawOptionsDiv.style.display = "block";
                    } else if (this.value === "formnone") {
                        formDataDiv.style.display = "none";
                        rawDiv.style.display = "none";
                        rawOptionsDiv.style.display = "none";
                    }
                });
            });
        });

        function importurl(){
             $("#importurl_Popup").show();
            var fileInput = '';
            var fileType = '';
            var formData = new FormData();
            var filepath = $("#File_Import").val();
            fileInput = document.getElementById('File_Import');
            if (fileInput.files.length > 0) {
                formData.append('file', fileInput.files[0]);
                fileType = fileInput.files[0].name;
            }
            formData.append('method', $("#sel").val());
        }

        function saveapiHeader(){
            var pipelineCode = $("#txt_ppl_code").val();
            var current_date = new Date;
            var pplapigid = $('#txt_api_gid').val();
             var data = {};
                data.pipeline_code = pipelineCode;
                data.api_jsonvalue = $('#url').val();
                data.api_key = "";
                data.api_value = "";
                data.remarks = "";
                data.delete_flag = "N";
                if(pplapigid == "") {
                    data.api_gid = "0";
                    data.created_date = current_date;
                    data.created_by = _user_code;
                      $.ajax({
                      type: "Post",
                      url: '@Url.Action("Addnewpplapiheader", "Pipeline")',
                      data: JSON.stringify(data),
                      dataType: "json",
                      contentType: 'application/json; charset=utf-8',
                      success: function (response) {
                          if (response == "Record Inserted Successfully") {
                              fetchpplapiheader();
                              getAPIResponse();
                          }
                      },
                      error: function (er) {
                          jAlert(er, "Error");
                      }
                  });
                } else {
                    data.api_gid = pplapigid;
                     data.updated_date = current_date;
                     data.updated_by = _user_code;
                    $.ajax({
                      type: "Post",
                      url: '@Url.Action("Updateexistingpplapiheader", "Pipeline")',
                      data: JSON.stringify(data),
                      dataType: "json",
                      contentType: 'application/json; charset=utf-8',
                      success: function (response) {
                          if (response == "Record Updated Successfully") {
                              fetchpplapiheader();
                              getAPIResponse();
                          }
                      },
                      error: function (er) {
                          jAlert(er, "Error");
                      }
                  });
                }
          }

        function SrcApiGrid(data) {
            try {
                $("#SrcApiGrid").remove();
                $('#srcapisearch').append('<div id="SrcApiGrid" style="width: 98%; height: 350px !important; margin-top: 15px;margin-left: 0px;"></div>');
                $("#SrcApiGrid").kendoGrid({
                    dataSource: {
                        data: data,
                        schema: {
                            model: {
                                fields: {
                                    pplsourcefield_gid: { type: "string" },
                                    Action: { type: "string" },
                                    sourcefield_sno: { type: "integer" },
                                    sourcefield_name: { type: "string" },
                                    sourcefield_datatype: { type: "string" },
                                }
                            }
                        },
                        pageSize: 2000,
                    },
                    height: 306,
                    width: 1058,
                    pageable: true,
                    sortable: true,
                    filterable: true,
                    selectable: "single",
                    columns: [
                        {
                            field: "pplsourcefield_gid",
                            title: "pplsourcefield_gid",
                            hidden: true,
                            width: 50
                        },
                        {
                            field: "Action",
                            title: "Action",
                            template: "<div class= 'action-cell' style = 'text-align: center;' > <i class='glyphicon glyphicon-pencil' onclick='editapisrcfield($(this))' style = color: green; cursor: pointer; ' title='Edit'></i> </t> </t> <i class='glyphicon glyphicon-trash' onclick='deleteApiSrcfield($(this))' style='color:red;margin-left: 20% !important'></i></div>",
                            sortable: false,
                            filterable: false,
                            width: 50
                        },
                        {
                            field: "sourcefield_sno",
                            title: "Serial No",
                            width: 50
                        },
                        {
                            field: "sourcefield_name",
                            title: "Column Name",
                            width: 150
                        },
                        {
                            field: "sourcefield_datatype",
                            title: "Type",
                            width: 150
                        }

                    ],
                    editable: false
                });
            }
            catch (err) {
                jAlert(er, "Error");
            }
        }

        function addapiColumns(){
            $("#apiColumn_Popup").show();
        }

        function fetchpplapiheader() {
            var ppl_code = $('#txt_ppl_code').val();
            $.ajax({
                type: "GET",
                url: '@Url.Action("ReadpipelineApiHeader", "Pipeline")?pipelinecode=' + ppl_code,
                dataType: "json",
                contentType: 'application/json; charset=utf-8',
                success: function (response) {
                    if (response.length > 0) {
                        $('#txt_api_gid').val(response[0].api_gid);
                         $('#url').val(response[0].api_jsonvalue);
                       // $('#shortText').val((response[0].api_jsonvalue).toString());
                       // confirm();
                    }
                },
                error: function (er) {
                    jAlert(er, "Error");
                }
            });
        }

        function GetSrcApilist(pipeline_code) {
            $.ajax({
                type: 'GET',
                url: '@Url.Action("GetAllApiSource", "Pipeline")?pipelinecode=' + pipeline_code,
                contentType: false,
                processData: false,
                cache: false,
                success: function (response) {
                    SrcApiGrid(response);
                },
                error: function (er) {
                    alert(er)
                }
            });
        }

        function Clearapisrcfield() {
            $('#txt_pplapifield_gid').val("");
            $('#txt_apiserialno').val("");
            $('#txt_apicolumnname').val("");
            $('#drp_apicol_datatype').val("");
        }

        function editapisrcfield(e) {
            addapiColumns();
            var entityGrid = $("#SrcApiGrid").data("kendoGrid");
            var pplsrcgid = entityGrid.dataItem(e.select().closest("tr")).pplsourcefield_gid;
            var srcfield_sno = entityGrid.dataItem(e.select().closest("tr")).sourcefield_sno;
            var srcfield_name = entityGrid.dataItem(e.select().closest("tr")).sourcefield_name;
            var srcfield_datatype = entityGrid.dataItem(e.select().closest("tr")).sourcefield_datatype;

            $('#txt_pplapifield_gid').val(pplsrcgid);
            $('#txt_apiserialno').val(srcfield_sno);
            $('#txt_apicolumnname').val(srcfield_name);
            $('#drp_apicol_datatype').val(srcfield_datatype);
        }

        function deleteApiSrcfield(e) {
            var ppl_code = $("#txt_ppl_code").val();
            let text = "Are you sure to delete?";
            jConfirm(text, "Connector", function (f) {
                if (f == true) {
                    var entityGrid = $("#SrcApiGrid").data("kendoGrid");
                    var v_pplsourcefield_gid = entityGrid.dataItem(e.select().closest("tr")).pplsourcefield_gid;
                    $.ajax({
                        type: "Post",
                        url: '@Url.Action("Deleteexistingpplsourcefield", "Pipeline")?id=' + v_pplsourcefield_gid,
                        dataType: "json",
                        success: function (response) {
                            jAlert(response, "Connector", function (g) {
                                if (g == true) {
                                    GetSrcApilist(ppl_code);
                                }
                            });
                        },
                        error: function (er) {
                            jAlert(er, "Error");
                        }
                    });
                } else {
                    text = "You canceled!";
                }
            });
        }

        function saveApiColumns() {
            var current_date = new Date;
            var ppl_code = $("#txt_ppl_code").val();
            var pplapigid = $('#txt_pplapifield_gid').val();
            var sourcefield_name = $('#txt_apicolumnname').val().trim();
            var sourcefield_datatype = $('#drp_apicol_datatype').val();
            var serila_no = $('#txt_apiserialno').val().trim();
            if (serila_no == "" || serila_no == "0") {
                jAlert("Serial No cannot be blank ", "Connector");
                return;
            }
            if (sourcefield_name == "") {
                jAlert("Column name cannot be blank ", "Connector");
                return;
            }
            if (sourcefield_datatype == "-- Select --") {
                jAlert("Please select the Column Type ", "Connector");
                return;
            }
            if (pplapigid == "") {
                var data = {};
                data.pplsourcefield_gid = pplapigid;
                data.pipeline_code = ppl_code;
                data.sourcefield_name = sourcefield_name;
                data.sourcefield_datatype = sourcefield_datatype;
                data.sourcefield_sno = serila_no
                data.source_type = "API";
                data.created_date = current_date;
                data.created_by = _user_code;
                $.ajax({
                    type: "Post",
                    url: '@Url.Action("Addnewpplapisourcefield", "Pipeline")',
                    data: JSON.stringify(data),
                    dataType: "json",
                    contentType: 'application/json; charset=utf-8',
                    success: function (response) {
                        jAlert(response, "Connector");
                        if (response == "Record Inserted Successfully") {
                            GetSrcApilist(ppl_code);
                            Clearapisrcfield();
                        }
                    },
                    error: function (er) {
                        jAlert(er, "Error");
                    }
                });
            }
            else {
                var data = {};
                data.pplsourcefield_gid = pplapigid;
                data.pipeline_code = ppl_code;
                data.sourcefield_name = sourcefield_name;
                data.sourcefield_datatype = sourcefield_datatype;
                data.sourcefield_sno = serila_no
                data.source_type = "API";
                data.updated_date = current_date;
                data.created_by = _user_code;
                $.ajax({
                    type: "Post",
                    url: '@Url.Action("Updateexistingpplapisrcfield", "Pipeline")',
                    data: JSON.stringify(data),
                    dataType: "json",
                    contentType: 'application/json; charset=utf-8',
                    success: function (response) {
                        jAlert(response, "Connector");
                        if (response == "Record Updated Successfully") {
                            GetSrcApilist(ppl_code);
                            Clearapisrcfield();
                        }
                    },
                    error: function (er) {
                        jAlert(er, "Error");
                    }
                });
            }
        }

        function getAPIResponse() {
            var url = $('#url').val();
              $.ajax({
                    type: "Get",
                    url: '@Url.Action("getAPIResponse", "Pipeline")?url='+url,
                    //data: JSON.stringify(data),
                    dataType: "json",
                    contentType: 'application/json; charset=utf-8',
                    success: function (response) {
                        if(response != "" || response != "[]" || response != "{[]}"){
                            var res = JSON.parse(response);
                                apiResponse = JSON.parse(response);
                            datasetfiledname = [];
                            dataset_name = [];
                            var reslength = Object.keys(JSON.parse(res)).length;
                            var getds_name = Object.keys(JSON.parse(res))
                               Object.keys(JSON.parse(res)).forEach(function(key, index) {
                                        dataset_name.push({"code":key,"desc": key});
                                            var item = JSON.parse(res)[key][0];
                                            Object.keys(item).forEach(function(innerKey) {
                                            datasetfiledname.push({
                                                "dataset_field": innerKey,
                                                "dataset_name":key,
                                                "target_dataset_field": innerKey,
                                                "source_dataset_field":innerKey,
                                                 "field_type": "TEXT",
                                                 "field_length": "255",
                                        });
                                    });
                                });
                                dsfieldMapgrid(datasetfiledname);
                                loadapigrid(datasetfiledname);
                        }

                    },
                    error: function (er) {
                      jAlert(er.message, "Error");
                    }
                });
        }


        document.getElementById("btn_nextppl").addEventListener("click", function () {
            $("#tab1").removeClass("show-tab-important");
            $("#tab2").addClass("show-tab-important");
            $('#cc_progressbar li').addClass('active');
            $('#datasetSelection').removeClass('active');
            document.getElementById("templateSelection_conf").style.display = "block";
            var conn_code = document.getElementById("connectors");
            var selectedOption = conn_code.options[conn_code.selectedIndex];
            var selectedText = selectedOption.textContent;
            if(selectedText == "" || selectedText == undefined || selectedText == null || selectedText == "-- Select --" || selectedText == "--Select--"){
                $("#div_srcdbname").hide();
                $("#div_tvq").hide();
                $("#div_apiurl").hide();
                $("#div_fileinput").hide();
                $("#div_delimited").hide();
                $("#div_csv").hide();
                $("#div_selectfile").hide();
                $("#div_downloadtemp").hide();
                $("#img_div").hide();
                $("#grid_tvc").hide();
                document.getElementById("btn_nextppl1").disabled = true;
            }
        });

        document.getElementById("btn_nextppl1").addEventListener("click", function () {
            getsourcefielddrpdown();
            var activeTabId = $('#cc_progressbar li.active').attr('id');
            if (activeTabId === 'templateSelection') {
                var conn_code = document.getElementById("connectors");
                var selectedOption = conn_code.options[conn_code.selectedIndex];
                var selectedText = selectedOption.textContent;
                if(selectedText == "" || selectedText == undefined || selectedText == null || selectedText == "-- Select --" || selectedText == "--Select--"){
                    jAlert("Please select valid connectors type.", "Connector");
                    return;
                }
                var pplcsdheaderGid = $('#txt_pplcsvheader_gid').val();  
                var selectedfile = document.getElementById("selectedfilename").textContent;
                var sheet_name1 = document.getElementById("txt_sheetname").value;
                var txtfileextension = selectedfile == "" ? $('#txt_fileextension').val() : selectedfile;
                if (!txtfileextension && (txtfileextension == '' || txtfileextension == undefined) && $("#txt_source_db_type").val() == "Excel") {
                    jAlert("Please select valid file.", "Connector");
                    $("#tab2").addClass("show-tab-important");
                    document.getElementById("btn_nextppl1").disabled = true;
                    return;
                }
                else if ((pplcsdheaderGid == 0 || pplcsdheaderGid == "" || pplcsdheaderGid == "0" || pplcsdheaderGid == undefined) && $("#txt_source_db_type").val() == "CSV") {
                    jAlert("Please fill and save all the mandatory fields.", "Connector");
                    return;
                }
                else {
                    if (activeTabId === 'templateSelection') {
                        $("#tab2").addClass("show-tab-important");
                        $("#tab3").hide();
                        $("#tab3").removeClass("show-tab-important");
                        $('#datasetSelection').addClass('active');
                        $('#templateSelection_conf').hide();
                        $('#datasetSelection_conf').show();
                    }
                    else{
                        $("#tab2").removeClass("show-tab-important");
                    }
                    var grid = $("#grid_dataset").data("kendoGrid");
                    if (grid == null) {
                        jAlert("Please Select Dataset", "Connector");
                        return;
                    }
                    pplsave();
                    var selectedRow = grid.dataSource._data;
                    var getselectedrow = selectedRow.filter(item => item.selected == true);
                    if (getselectedrow.length > 0) {
                        var dataItem = getselectedrow[0];
                        sessionStorage.setItem("DS", JSON.stringify(dataItem));
                        $('#txtds_code').val(dataItem.dataset_code);
                        $('#trgdataset').val(dataItem.dataset_code);
                        $('#txt_trgdataset').val(dataItem.dataset_name);
                        if (dataItem.selected == true) {
                            if ($("#txt_source_db_type").val() == "API") {
                                getAPIResponse();
                            } else if ($("#txt_source_db_type").val() == "Excel" || $("#txt_source_db_type").val() == "CSV") {
                                getdatasetfield();
                            }
                            getsourcefielddrpdown();
                            selectedDataset = dataItem.dataset_name;
                            setTimeout(function () {
                                if (path && $("#txt_source_db_type").val() == "Excel") {
                                    getExcelResponse(path);
                                } else if ($("#txt_source_db_type").val() == "CSV") {
                                    var grid = $("#SrcCsvGrid").data("kendoGrid");
                                    var items = grid.dataSource._data;
                                    var sourcefield = items.map(f => f.sourcefield_name).toString();
                                    loadexistingdataset(sourcefield);
                                }
                            }, 600);
                        }
                    }else{
                        var grid = $("#SrcCsvGrid").data("kendoGrid");
                        var items = grid.dataSource._data;
                        var sourcefield = items.map(f => f.sourcefield_name).toString();
                        loadexistingdataset(sourcefield);
                    }
                    var conn_code = document.getElementById("connectors");
                    var label = document.getElementById('lbl_info');
                    var label1 = document.getElementById('lbl_info1');
                    var label2 = document.getElementById('lbl_info2');
                    var selectedOption = conn_code.options[conn_code.selectedIndex];
                    var selectedText = selectedOption.textContent;
                    label.innerHTML = "Pipeline Name -> " + $("#txtppl_name").val() + ";Connector Name -> " + selectedText + ";Target Dataset -> " + selectedDataset;
                    label1.innerHTML = "Pipeline Name -> " + $("#txtppl_name").val() + ";Connector Name -> " + selectedText + ";Target Dataset -> " + selectedDataset;
                    label2.innerHTML = "Pipeline Name -> " + $("#txtppl_name").val() + ";Connector Name -> " + selectedText + ";Target Dataset -> " + selectedDataset;
                }
                    $('#cc_progressbar li').removeClass('active');
                    $('#datasetSelection').addClass('active');
                    $('#templateSelection_conf').hide();
                    $('#datasetSelection_conf').show();
            }
            else if (activeTabId === 'datasetSelection') {
                if(selectedDataset == ""){
                    jAlert("Please Select the Dataset", "Connector");
                }
                else{
                $('#cc_progressbar li').removeClass('active');
                    $('#datasetSelection').removeClass('active');
                    $('#templateSelection_conf').hide();
                    $('#datasetSelection_conf').hide();
                    $("#tab2").removeClass("show-tab-important");
                    $("#tab3").removeClass("show-tab-important");
                    $('#fieldmappingTab').addClass('active');
                    $("#fieldmappingTab").show();
                    $("#filtersTab").show();
                    getdatasetfield();
                var conn_code = document.getElementById("connectors");
                var label = document.getElementById('lbl_info');
                var label1 = document.getElementById('lbl_info1');
                var label2 = document.getElementById('lbl_info2');
                var selectedOption = conn_code.options[conn_code.selectedIndex];
                var selectedText = selectedOption.textContent;
                label.innerHTML = "Pipeline Name -> " + $("#txtppl_name").val() + ";Connector Name -> " + selectedText + ";Target Dataset -> " + selectedDataset;
                label1.innerHTML = "Pipeline Name -> " + $("#txtppl_name").val() + ";Connector Name -> " + selectedText + ";Target Dataset -> " + selectedDataset;
                label2.innerHTML = "Pipeline Name -> " + $("#txtppl_name").val() + ";Connector Name -> " + selectedText + ";Target Dataset -> " + selectedDataset;
                }
            }
            const validationTab = document.getElementById("validationTab");
            const fieldmappingTab = document.getElementById("fieldmappingTab");
            const filtersTab = document.getElementById("filtersTab");
            const expressionConf = document.getElementById("expression_conf");
            const fieldmappingConf = document.getElementById("fieldmapping_conf");
              fieldmappingConf.style.display = "block";
              filtersConf.style.display = "none";
              fieldmappingTab.classList.add("active");
              filtersTab.classList.remove("active");
              fetchpplcond("Filter");
        });

        document.getElementById("btn_nextppl2").addEventListener("click", function() {
            DataprocessingLoadgrid([]);
            if(gridhasChange) {
                jAlert("Please click to save the modified changes or click revert to cancel changes", "Connector");
            } else {
                 $("#tab3").removeClass("show-tab-important");
                const validationTab = document.getElementById("validationTab");
                const validationConf = document.getElementById("validation_conf");
                const dataprocessingTab = document.getElementById("dataprocessingTab");
                const dataprocessingConf = document.getElementById("dataprocessing_conf");
                fetchpplcond("Validation");
                validationConf.style.display = "block";
                dataprocessingConf.style.display = "none";
                dataprocessingTab.classList.remove("active");
                validationTab.classList.add("active");

            }
        });

        document.getElementById("btn_nextppl3").addEventListener("click", function() {
            fetchpplfinalization();
            $("#tab4").removeClass("show-tab-important");
        });

        document.getElementById("btn_prvs2").addEventListener("click", function(e){
                if(gridhasChange) {
                    jAlert("Please click to save the modified changes or click revert to cancel changes", "Connector");
                }else{
                    $('#datasetSelection').addClass('active');
                    $('#templateSelection').removeClass('active');
                    $('#templateSelection_conf').hide();
                    $('#datasetSelection_conf').show();
                    $('#fieldmappingTab').removeClass('active');
                }
             });

        document.getElementById("btn_prvs3").addEventListener("click", function(){
            gridhasChange = false;
            getdatasetfield();
            enabledisablevalidation(false);
            $("#tab4").removeClass("show-tab-important");
        });

        function dsfieldMapgrid(datasetfield) {
            var dsppl_code = JSON.parse(sessionStorage.getItem("DS"));
            var pplcode = $('#txt_ppl_code').val();
            showplusIcon = datasetfield.some(item => item.parent_pipeline_code === pplcode);
            isExistingds = showplusIcon;
            var parent_dataset_name = datasetfield[0]?.parent_pipeline_name || '';
            var label = document.getElementById('parent_pipeline');
            label.innerHTML = "Note: Changes can be done only in Parent Pipeline --> " + parent_dataset_name;
            $("#grid_dsfieldMapping").remove();
            $('#dataset_fieldMapping').append('<div id="grid_dsfieldMapping" style="width: 97.5%; height: 300px !important; margin-top: 21px;margin-left: 15px;"></div>');

                var columnConfig = [];
                var isexistingDataset = datasetfield.length > 0 && datasetfield[0].system_flag === 'P' && datasetfield[0].its_parent_pipeline === 'Y';
            if (isexistingDataset) {
            // Show "Source Field Name" first
            columnConfig = [
                { field: "pplfieldmapping_gid", hidden: true },
                { field: "parent_pipeline_code", hidden: true },
                { field: "pplsourcefield_gid", hidden: true },
                { field: "pipeline_code", hidden: true },
                { field: "system_flag", hidden: true },
                { field: "mapped_ppl_field_name", hidden: true },
                {
                    field: "field_mandatory",
                    title: "Mandatory",
                    width: 30,
                    editable: true,
                    filterable: false,

                    template: function (dataItem) {
                        return showplusIcon ?
                            '<input type="checkbox" class="chkbx1" ' + (dataItem.field_mandatory === "Y" ? 'checked="checked"' : '') + '/>' :
                                '<input type="checkbox" style="pointer-events: none !important; cursor: not-allowed !important;" onmousedown="return false;" onkeydown="return false;" readonly class="chkbx1" ' + (dataItem.field_mandatory === "Y" ? 'checked="checked"' : '') + '/>';
                    }                   
                },
                { field: "dataset_code", title: "Dataset Name", hidden: true },
                { field: "ppl_field_name", title: "Source Field Name", editor: datafieldEditor, template: function(dataItem) {
                    const matchedSources = sourceFieldNames.filter(item =>
                                    item.source_type === "Expression" &&
                                    item.sourcefield_name.replace(/^\*\s*/, '') === dataItem.ppl_field_name.replace(/^\*\s*/, '')
                                );

                    if (
                        matchedSources.length > 0 &&
                        !dataItem.ppl_field_name.trim().startsWith("*")
                    ) {
                        return "* " + dataItem.ppl_field_name;
                    } else {
                        return dataItem.ppl_field_name;
                    }
                }, width: 100, },
                { field: "field_name", title: "Dataset Field Name", width: 100 },
                { field: "dataset_seqno", title: "Seq No", width: 30,editor: plainNumberEditor,     attributes: { style: "text-align: right;" },
                filterable: {
                ui: function (element) {
                    element.kendoNumericTextBox({
                        format: "n2",
                        decimals: 2,
                        step: 0.01
                    });
                }
            },
            format: "{0:n2}"},
                { field: "field_type", title: "Field Type", editor: fieldTypeEditor, width: 80},
                { field: "pplsourcefield_format", title: "pplsourcefield_format", hidden: true },
                { field: "field_length", title: "Field Length/Format", editor: fieldLengthEditor,filterable: false, width: 90 },
                { field: "default_value", title: "Default Value", hidden: true },
                { field: "parent_pipeline_name", title: "parent_pipeline_name", hidden: true },
                {
                    field: "field_mapped",
                    title: "Enable",
                    filterable: false,
                    template: function (dataItem) {
                             return '<input style="text-align:center;" type="checkbox" class="chkbxFieldmapping" ' + ((dataItem.field_mapped == "Y")  ? 'checked="checked"' : '') + '/>'
                    },
                    width: 30
                },
            ];
        } else {
            // Show "Dataset Field Name" first
            columnConfig = [
                { field: "pplfieldmapping_gid", hidden: true },
                { field: "parent_pipeline_code", hidden: true },
                { field: "pplsourcefield_gid", hidden: true },
                { field: "pipeline_code", hidden: true },
                { field: "system_flag", hidden: true },
                { field: "mapped_ppl_field_name", hidden: true },
                {
                    field: "field_mandatory",
                    title: "Mandatory",
                    width: 30,
                    editable: true,
                    filterable: false,
                    template: function (dataItem) {
                        return showplusIcon ?
                            '<input type="checkbox" class="chkbx1" ' + (dataItem.field_mandatory === "Y" ? 'checked="checked"' : '') + '/>' :
                            '<input type="checkbox" style="pointer-events: none !important; cursor: not-allowed !important;" onmousedown="return false;" onkeydown="return false;" readonly class="chkbx1" ' + (dataItem.field_mandatory === "Y" ? 'checked="checked"' : '') + '/>';
                    }                       
                },
                { field: "dataset_code", title: "Dataset Name", hidden: true },
                { field: "field_name", title: "Dataset Field Name", width: 100 },
               { field: "ppl_field_name", title: "Source Field Name", editor: datafieldEditor, template: function(dataItem) {
                const matchedSources = sourceFieldNames.filter(item =>
                                    item.source_type === "Expression" &&
                                    item.sourcefield_name.replace(/^\*\s*/, '') === dataItem.ppl_field_name.replace(/^\*\s*/, '')
                                );
                    if (
                        matchedSources.length > 0 &&
                        !dataItem.ppl_field_name.trim().startsWith("*")
                    ) {
                        return "* " + dataItem.ppl_field_name;
                    } else {
                        return dataItem.ppl_field_name;
                    }
                }, width: 100, },
                { field: "dataset_seqno", title: "Seq No", width: 30, editor: plainNumberEditor,  attributes: { style: "text-align: right;" },
                filterable: {
                ui: function (element) {
                    element.kendoNumericTextBox({
                        format: "n2",
                        decimals: 2,
                        step: 0.01
                    });
                }
            },
            format: "{0:n2}"},
                { field: "field_type", title: "Field Type", editor: fieldTypeEditor, width: 80 },
                { field: "pplsourcefield_format", title: "pplsourcefield_format", hidden: true },
                { field: "field_length", title: "Field Length/Format", editor: fieldLengthEditor,filterable: false,width: 90 },
                { field: "default_value", title: "Default Value", hidden: true },
                { field: "parent_pipeline_name", title: "parent_pipeline_name", hidden: true },
                    {
                        field: "field_mapped",
                        title: "Enable",
                        filterable: false,
                        template: function (dataItem) {
                            return '<input style="text-align:center;" type="checkbox" class="chkbxFieldmapping" ' + ((dataItem.field_mapped == "Y")  ? 'checked="checked"' : '') + '/>'
                        },
                        width: 30
                    },

            ];
        }

            $("#grid_dsfieldMapping").kendoGrid({
                dataSource: {
                    data: datasetfield,
                    schema: {
                        model: {
                            id: "datasetfield_gid",
                            fields: {
                                pipeline_code: { type: "string",editable: false },
                                Action: { type: "string" ,editable: false} ,
                                dataset_gid: { type: "string",editable: false, defaultValue: "0" },
                                dataset_code: { type: "string",editable: false },
                                datasetfield_gid: { type: "string",editable: false, defaultValue: "0" },
                                dataset_seqno: { type: "number",editable: true  },
                                field_name: { type: "string",editable: true },
                                field_type: { type: "string" ,editable: true },
                                field_length: { type: "string" ,editable: true},
                                precision_length: { type: "string" ,editable: true},
                                scale_length: { type: "string" ,editable: true},
                                field_mandatory: { type: "string",editable: false},
                                dataset_field_sno: { type: "string" ,editable: false},
                                dataset_table_field: { type: "string" ,editable: false},
                                Status: { type: "string" ,editable: false},
                                pplfieldmapping_gid: { type: "string",editable: false, defaultValue: "0" },
                                pplfieldmapping_flag: { type: "string",editable: false, defaultValue: "0" },
                                ppl_field_name: { type: "string" ,editable: true},
                                dataset_field_name: { type: "string" ,editable: true},
                                default_value: { type: "string" ,editable: false},
                                pplsourcefield_format: { type: "string",editable: true },
                                pplsourcefield_gid: { type: "string",editable: true },
                                parent_pipeline_code: { type: "string",editable: false },
                                parent_pipeline_name: { type: "string",editable: false },
                                field_mapped: {type:"string",editable: false}
                            }
                        }
                    },
                 pageSize: 100,
                },
                height: 300,
                sortable: true,
                filterable: true,
                selectable: "row",
                resizable: false,
                pageable: true,
                    toolbar: "<a href='javascript:void(0)'" + (showplusIcon ? "onclick='addfieldmapping()'" : "style='pointer-events: none; opacity: 0.4;'") + ">" +
                 "<span class='glyphicon glyphicon-plus' style='color: white !important;'></span></a>",
                     columns: columnConfig,
                editable : true,
                edit: function (e) {
                    if (!showplusIcon && e.field !== "field_name") {
                        e.preventDefault();
                    }
                    if (!showplusIcon && e.field !== "ppl_field_name") {
                        e.preventDefault();
                    }
                    if (typeof OnEdit === "function") {
                        OnEdit(e);
                    }
                },

                dataBound: function (e) {
                var grid = this;
                grid.dataSource.bind("change", function(e) {
                if (["itemchange", "remove", "add"].includes(e.action)) {
                    gridhasChange = true;
                }
                });
                if (!showplusIcon) {
                    var grid = this;
                    grid.tbody.find("tr").each(function () {
                        var datasetfieldcell = $(this).find("td").eq(8);
                        var seqnofieldcell = $(this).find("td").eq(10);
                        var fieldtypecell = $(this).find("td").eq(11);
                        datasetfieldcell.css({
                            "pointer-events": "none",
                        });
                         seqnofieldcell.css({
                            "pointer-events": "none",
                        });
                        fieldtypecell.css({
                            "pointer-events": "none",
                        })
                    });
                }
                resultData = e.sender._data;
            }
            });
                // Handle checkbox manually
                 $(document).on('change', '.chkbx1', function () {
                     var checked = $(this).is(':checked');
                     var grid = $('#grid_dsfieldMapping').data().kendoGrid;
                     var dataItem = grid.dataItem($(this).closest('tr'));
                         if(checked == true)
                             {
                                 dataItem._set('field_mandatory','Y');
                                 dataItem._set('pplfieldmapping_flag','1');
                             }
                         else
                             {
                                 dataItem._set('field_mandatory','N');
                                 dataItem._set('pplfieldmapping_flag','0');
                             }
            });

                        // Handle checkbox manually
                $(document).on('change', '.chkbxFieldmapping', function () {
                    
                    var checked = $(this).is(':checked');
                    var grid = $('#grid_dsfieldMapping').data().kendoGrid;
                    var dataItem = grid.dataItem($(this).closest('tr'));
                    if (checked == true) {
                        dataItem._set('field_mapped', 'Y');
                    }
                    else {
                        dataItem._set('field_mapped', 'N');
                    }
                    // grid.refresh();
                });

    }

        // function mandatoryCheck(checkbox, dataItem) {
        //     var grid = $("#grid_dsfieldMapping").data("kendoGrid");
        //     var dataSource = grid.dataSource;
        //     var model = dataSource.get(dataItem.datasetfield_gid);
        //     if (model) {
        //         if (checkbox.checked) {
        //             model.set("field_mandatory", "Y");
        //             dataItem.field_mandatory = "Y";
        //         } else {
        //             model.set("field_mandatory", "N");
        //             dataItem.field_mandatory = "N";
        //         }
        //         grid.refresh();
        //     } else {
        //         console.log("Model not found for datasetfield_gid:", dataItem.datasetfield_gid);
        //     }
        // }

        function plainNumberEditor(container, options) {
            $('<input type="number" step="0.01" style="height: 14px; width: 63%;" class="k-input form-control" />')
                .attr("name", options.field)
                .appendTo(container);
        }

        function fieldLengthEditor(container, options) {
            var dataItem = options.model;
            if (dataItem.field_type === 'DATE' || dataItem.field_type === 'DATETIME') {
                var dropdown = $("<select name='" + options.field + "' style='width:100%; color:black;'>");
                for (var i = 0; i < dateformatfield.length; i++) {
                    var option = $("<option style='color:black;' value='" + dateformatfield[i].name + "'>" + dateformatfield[i].name + "</option>");
                    dropdown.append(option);
                }
                dropdown.val(options.model.get(options.field));
                options.model.get("pplsourcefield_format");
                dropdown.change(function() {
                    var selectedValue = $(this).val();
                    options.model.set(options.field, selectedValue);
                    options.model.set("pplsourcefield_format", selectedValue);
                });
                dropdown.appendTo(container);

                }

        //          if (dataItem.field_type === 'DATE') {
        //     var dropdown = $("<select name='" + options.field + "' style='width:100%; color:black;'>");
        //     dropdown.append("<option style='color:blue;' value='__add_new__'>+ Custom Format</option>");
        //     for (var i = 0; i < dateformatfield.length; i++) {
        //         var option = $("<option style='color:black;' value='" + dateformatfield[i].name + "'>" + dateformatfield[i].name + "</option>");
        //         dropdown.append(option);
        //     }
        //     dropdown.val(options.model.get(options.field));
        //    dropdown.change(function () {
        //         var selectedValue = $(this).val();                
        //         if (selectedValue === "__add_new__") {
        //             $(this).val("");
        //             openAddFormatPopup(dropdown, options);
        //             } else {
        //             options.model.set(options.field, selectedValue);
        //             options.model.set("pplsourcefield_format", selectedValue);
        //         }
        //     });
        //     dropdown.appendTo(container);
        // } 
        else if (dataItem.field_type === 'NUMERIC' && showplusIcon) {
                var inputWrapper = $('<div style="display: flex; gap: 10px;"></div>');
                var input1 = $('<input class="form-control" name="' + options.field + '_Precision" type="text" style="width:45%;height:20px;" value="5" placeholder="Precision" />');
                var input2 = $('<input class="form-control" name="' + options.field + '_scale" type="text" style="width:45%;height:20px;" value="2" placeholder="scale" />');

                inputWrapper.append(input1);
                inputWrapper.append(input2);

                options.model.get("precision_length");
                options.model.get("scale_length");

                inputWrapper.appendTo(container);

                var updateModel = function() {
                    var preciousValue = input1.val();
                    var scaleValue = input2.val();
                    var combinedValue = preciousValue + "," + scaleValue;
                    options.model.set(options.field, combinedValue);
                    options.model.set("precision_length", preciousValue);
                    options.model.set("scale_length", scaleValue);
                    options.model.set("field_length", combinedValue);
                };

                // Populate the inputs if there's an initial value
                var initialModelValue = options.model.get(options.field);
                if (initialModelValue) {
                    var values = initialModelValue.split(',');
                    if (values.length === 2) {
                        var Precision = values[0].split(':')[1]?.trim();
                        var scale = values[1].split(':')[1]?.trim();
                        if (Precision && scale) {
                            input1.val(Precision);
                            input2.val(scale);
                        }
                    }
                }

                // Attach change event listeners to update the model
                input1.change(updateModel);
                input2.change(updateModel);

                }
                else if(!showplusIcon) {
                // For other field types, create a regular text input
                    $("<input disabled type='text' name='" + options.field + "' class='k-input k-textbox custom-disabled' style='color: #black;' />")
                    .appendTo(container)
                    .val(options.model[options.field]);
            }
                else if((dataItem.field_type === 'INTEGER' ||dataItem.field_type === 'TEXT' ) && showplusIcon) {
                    var value = dataItem.field_type == 'TEXT' ? '255' : '32';
                    $("<input type='text' value="+value+" name='" + options.field + "' class='k-input k-textbox' style='color:black ;' />")
                        .appendTo(container)
                        .val(options.model[options.field]);


            }
        }


        function fieldLengthEditor_M(container, options) {
        var dataItem = options.model;
        if (dataItem.field_type === 'DATE') {
            var dropdown = $("<select name='" + options.field + "' style='width:100%; color:black;'>");
            for (var i = 0; i < dateformatfield.length; i++) {
                var option = $("<option style='color:black;' value='" + dateformatfield[i].name + "'>" + dateformatfield[i].name + "</option>");
                dropdown.append(option);
            }
            dropdown.val(options.model.get(options.field));
            options.model.get("pplsourcefield_format");
           /* dropdown.change(function() {
                var selectedValue = $(this).val();
                options.model.set(options.field, selectedValue);
                options.model.set("pplsourcefield_format", selectedValue);
            });*/
        dropdown.change(function () {
            var selectedValue = $(this).val();

            if (selectedValue === 'Custom') {
                var isValid = false;
                var customValue = "";

                while (!isValid) {
                    customValue = prompt("Enter your custom date format (e.g., dd-MM-yyyy, yyyy/MM/dd):");

                    if (customValue === null) {
                        dropdown.val(options.model.get(options.field));
                        return;
                    }

                    customValue = customValue.trim();

                    // First basic character check
                    var allowedCharsRegex = /^[dMyHhms\-\/\s:]+$/;

                    // Semantic validation (valid format tokens)
                    var formatTokensRegex = /^(d{1,2}|M{1,2}|y{2,4}|H{1,2}|h{1,2}|m{1,2}|s{1,2})([-\/\s:]?(d{1,2}|M{1,2}|y{2,4}|H{1,2}|h{1,2}|m{1,2}|s{1,2}))*$/;

                    if (
                        customValue !== "" &&
                        allowedCharsRegex.test(customValue) &&
                        formatTokensRegex.test(customValue)
                    ) {
                        isValid = true;

                        if (dropdown.find("option[value='" + customValue + "']").length === 0) {
                            dropdown.append($("<option style='color:black;' value='" + customValue + "'>" + customValue + "</option>"));
                        }

                        dropdown.val(customValue);
                        selectedValue = customValue;
                    } else {
                        alert("Invalid date format. Use tokens like dd, MM, yyyy with valid separators (- / :). Examples: dd-MM-yyyy, yyyy/MM/dd.");
                    }
                }
            }

            options.model.set(options.field, selectedValue);
            options.model.set("pplsourcefield_format", selectedValue);
        });
            dropdown.appendTo(container);

            } else if (dataItem.field_type === 'NUMERIC' && showplusIcon) {
            var inputWrapper = $('<div style="display: flex; gap: 10px;"></div>');
            var input1 = $('<input class="form-control" name="' + options.field + '_Precision" type="text" style="width:45%;height:20px;" value="5" placeholder="Precision" />');
            var input2 = $('<input class="form-control" name="' + options.field + '_scale" type="text" style="width:45%;height:20px;" value="2" placeholder="scale" />');

            inputWrapper.append(input1);
            inputWrapper.append(input2);

            options.model.get("precision_length");
            options.model.get("scale_length");

            inputWrapper.appendTo(container);

            var updateModel = function() {
                var preciousValue = input1.val();
                var scaleValue = input2.val();
                var combinedValue = preciousValue + "," + scaleValue;
                options.model.set(options.field, combinedValue);
                options.model.set("precision_length", preciousValue);
                options.model.set("scale_length", scaleValue);
                options.model.set("field_length", combinedValue);
            };

            // Populate the inputs if there's an initial value
            var initialModelValue = options.model.get(options.field);
            if (initialModelValue) {
                var values = initialModelValue.split(',');
                if (values.length === 2) {
                    var Precision = values[0].split(':')[1]?.trim();
                    var scale = values[1].split(':')[1]?.trim();
                    if (Precision && scale) {
                        input1.val(Precision);
                        input2.val(scale);
                    }
                }
            }

            // Attach change event listeners to update the model
            input1.change(updateModel);
            input2.change(updateModel);

            }
            else if(!showplusIcon) {
            // For other field types, create a regular text input
                $("<input disabled type='text' name='" + options.field + "' class='k-input k-textbox custom-disabled' style='color: #black;' />")
                .appendTo(container)
                .val(options.model[options.field]);
        }
            else if((dataItem.field_type === 'INTEGER' ||dataItem.field_type === 'TEXT' ) && showplusIcon) {
                var value = dataItem.field_type == 'TEXT' ? '255' : '32';
                $("<input type='text' value="+value+" name='" + options.field + "' class='k-input k-textbox' style='color:black ;' />")
                    .appendTo(container)
                    .val(options.model[options.field]);


        }
    }


        function getExcelResponse(path){
            $.ajax({
                url: '@Url.Action("getExcelResponse", "Pipeline")?filePath='+path,
                type: 'Get',
                 dataType: "json",
                 contentType: 'application/json; charset=utf-8',
                success: function (response) {
                        if(response != "" || response != "[]" || response != "{[]}" || response != "{}"){
                              var responseData = JSON.parse(response);
                              var sheetdata = responseData[sheet_name]
                             //var keys = Object.keys(responseData.Sheet1[0]);
                                 var keys = Object.keys(sheetdata[0]);
                              var keysString = keys.join(",");
                              loadexistingdataset(keysString);
            }

            },
            error: function (er) {
                jAlert(er, "Error");
            }
        });
     }

        function Newdatasetgrid(dataset) {
            $("#grid_dataset").remove();
            $('#ds_grid').append('<div id="grid_dataset" style="height: 230px !important; width: 97%; margin-top: 10px;margin-left: 21px;"></div>');
            $("#grid_dataset").kendoGrid({
            dataSource: {
                data: dataset,
                pageSize: 100,
                schema: {
                    model: {
                        fields: {
                            Action: { type: "boolean" },
                            dataset_code: { type: "string"},
                            dataset_name: { type: "string", editable: false },
                            active_status: { type: "string"},
                            status: { type: "string"},
                            selected: { type: "boolean" },
                           dataset_gid: {type: "string"},
                           dataset_category: {type: "string"}
                        }
                    }
                }
            },
            height: 200,
            groupable: false,
            edit: OnEdit,
            sortable: true,
            dataBound: function (e) {
                    resultData = e.sender._data;
                    var rows = $('#grid_dataset').data('kendoGrid').tbody.children();
                },
            filterable: true,
            selectable: "row",
            navigatable: true,
            pageable: true,
            resizable: true,
            // toolbar: "<a href='javascript:void(0)' id='btn_newds' onclick='createNewDS()'> <span class='fa fa-plus' style = 'color:white' > </span></a> ",
            columns: [
                {
                    field: "Action",
                    title: "Select",
                    //template: '<div style="text-align:center;"><input type="radio" name="radioGroup" #= Action ? "checked" : "" # onclick="TableDSselectRow(this)" />  </t> </t> <i class="glyphicon glyphicon-pencil" style = "margin-left: 13% !important; cursor: pointer; " title="Edit"></i> </t> </t> <i class="glyphicon glyphicon-trash" style="color:red;margin-left: 13% !important;"></i></div>',
                       template: function(dataItem) {
                            return '<div style="text-align:center;">' +
                                '<input type="radio" name="radioGroup" ' + (dataItem.selected ? 'checked' : '') +
                                    ' onclick="TableDSselectRow($(this))" />' +
                                    '<i class="glyphicon glyphicon-trash" style="color:red;margin-left: 13% !important;" onclick="TableDSdeleteRow($(this))"></i>' +
                            '</div>';
                        },
                    sortable: false,
                    filterable: false,
                    width: 30
                },
                {
                    field: "dataset_code",
                    title: "Dataset Code",
                    width: 50
                },
                  {
                    field: "dataset_gid",
                    title: "dataset_gid",
                    width: 50,
                    hidden: true
                },
                {
                    field: "dataset_name",
                    title: "Dataset Name",
                    width: 90,
                 },{
                     field:"dataset_category",
                     title:"Category",
                     width:70,
                 },{
                    field: "status",
                    title: "Mapping Status",
                    width: 50
                },{
                    field: "active_status",
                    title: "Status",
                    width: 50,
                    hidden: true
                }],
                editable: false,
            });
        }

        function TableDSselectRow(e) {
            try {
                var datasetGrid = $("#grid_dataset").data("kendoGrid");
               var dataItem = datasetGrid.dataItem($(e).closest("tr"));
                dataItem.set("selected", true);
                datasetGrid.dataSource.data().forEach(function(item) {
                    if (item !== dataItem) {
                        item.set("selected", false);
                    }
                });
                if (dataItem.selected === true) {
                    sessionStorage.setItem("DS", JSON.stringify(dataItem));
                    $('#txtds_code').val(dataItem.dataset_code);
                    $('#trgdataset').val(dataItem.dataset_code + "_" + dataItem.dataset_code);
                    $('#txt_trgdataset').val(dataItem.dataset_name);
                    selectedDataset = dataItem.dataset_name;
                getsourcefielddrpdown();
                }

            } catch (err) {
                console.error("Error in TableDSselectRow:", err);
            }
        }

        function TableDSdeleteRow(e){
             try {
               var datasetGrid = $("#grid_dataset").data("kendoGrid");
               var dataItem = datasetGrid.dataItem($(e).closest("tr"));
               let text = "Are you sure to delete?";
               jConfirm(text, "Connector", function (f) {
                    if (f == true) {
                         var pipelineCode = $("#txt_ppl_code").val();
                var current_date = new Date;
                var ppldsgid = $('#txtds_gid').val();
                var data = {};
                data.dataset_systemflag = "N";
                data.pipelinedet_id = dataItem.pipelinedet_gid;
                data.pipeline_code = pipelineCode;
                data.dataset_name = $("#txtds_name").val(),
                data.datasetCode = dataItem.dataset_code;
                data.dataset_id = dataItem.dataset_gid;
                data.dataset_category = "",
                data.clone_dataset = "";
                data.active_status = "";
                data.inactive_reason = "";
                data.in_action = "PIPELINEMAPDELETE";
                data.in_action_by =_user_code;
                data.in_user_code = _user_code;
                data.in_role_code = "";
                data.in_lang_code = "";
                $.ajax({
                type: "Post",
                url: '@Url.Action("datasetheader", "Pipeline")',
                data: JSON.stringify(data),
                dataType: "json",
                contentType: 'application/json; charset=utf-8',
                success: function (response) {
                    var res = JSON.parse(response);
                       if(res.length >= 0 && res[0].out_result == 1){
                        jAlert(res[0].out_msg, "Connector");
                        $("#txtds_code").val(res[0].in_dataset_code);
                        $("#txtds_name").val("");
                        $("#txtds_category").val(""),
                        Newdatasetgrid();
                            if(path && $("#txt_source_db_type").val() == "Excel") {
                                getExcelResponse(path);
                            } else if($("#txt_source_db_type").val() == "CSV"){
                                var grid = $("#SrcCsvGrid").data("kendoGrid");
                                var items = grid.dataSource._data;
                                var sourcefield = items.map(f => f.sourcefield_name).toString();
                                loadexistingdataset(sourcefield);
                            }

                    }
                },
                error: function (er) {
                    jAlert(er, "Error");
                }
            });
            }
            else {
                text = "You canceled!";
            }
            });
            } catch (err) {
                console.error("Error in TableDSselectRow:", err);
            }
        }

        function loadapigrid(data){
                const uniqueData = data.filter((value, index, self) =>
                        index === self.findIndex((t) => (
                        t.dataset_name === value.dataset_name  // key to check uniqueness
                        ))
                );
               try {
                    $("#TablenameGrid").remove();
                    $('#srcapidssearch').append('<div id="TablenameGrid" style="width: 96%; height: 200px!important; margin-top: 10px;margin-left: 15px;"></div>');
                    $("#TablenameGrid").kendoGrid({
                        dataSource: {
                            data: uniqueData,
                            schema: {
                                model: {
                                    fields: {
                                        selected: { type: "boolean", editable: false },
                                        dataset_name: {type: "string", editable: false}
                                    }
                                }
                            },
                            pageSize: 100,
                        },
                        height: 200,
                        width: 1058,
                        editable: false,
                        pageable: true,
                        sortable: true,
                        filterable: true,
                        selectable: false,
                        columns: [
                            {
                                field: "selected",
                                title: "Mandatory",
                                template: function (dataItem) {
                                    return "<input id='selectedapiDS' name='dsname' type='radio' onclick='onselectedapiDS($(this))'/>";
                                },
                                sortable: false,
                                filterable: false,
                                width: 80,
                                attributes: {
                                    style: "text-align: center;"
                                }
                            },
                            {
                                field: "dataset_name",
                                title: "Result Name",
                                width: 200
                                },
                            {
                                title: "View",
                                width: 100,
                                template: `<a href="javascript:void(0)" onclick="openViewPopup('#=dataset_name#')">
                                                            <img src="../Content/images/10263790 (1).png" style="width:20px; height:20px;" title="View" />
                                                    </a>`
                            }
                            ],
                    });
                }
                catch (err) {
                    jAlert(err, "Error");
                }
            }

        function onselectedapiDS(e){
            try{
                var grid = $("#TablenameGrid").data("kendoGrid");
                var dataItem = grid.dataItem(e.select().closest("tr")).dataset_name;
                selectedAPIDS = dataItem;
                ds_name1=dataItem;
            } catch(err){

            }
    }

        function toggleDivs(type) {
             $("#txtds_name").val("");
             $("#txtds_category").val("");
             $("#txtds_category1").val("");
             $("#existingdataset").val("");
            if (type === 'new') {
                document.getElementById('add_newds').style.display = 'block';
                document.getElementById('add_existingds').style.display = 'none';
            } else if (type === 'existing') {
                document.getElementById('add_newds').style.display = 'none';
                document.getElementById('add_existingds').style.display = 'block';
                if (path && $("#txt_source_db_type").val() == "Excel") {
                    getExcelResponse(path);
                } else if ($("#txt_source_db_type").val() == "CSV") {
                    var grid = $("#SrcCsvGrid").data("kendoGrid");
                    var items = grid.dataSource._data;
                    var sourcefield = items.map(f => f.sourcefield_name).toString();
                    loadexistingdataset(sourcefield);
                } else if ($("#txt_source_db_type").val() == "MySql") {
                    var ppl_code = $("#txt_ppl_code").val();
                    var conn_code = $('#connectors').val();
                    var database_name = $('#databasename').val();
                    getmysqlsrcfields(conn_code, ppl_code, database_name, v_srctblviewqry_desc, v_srctblviewqry_type);
                }
            } else if (type === 'existingall') {
                document.getElementById('add_newds').style.display = 'none';
                document.getElementById('add_existingds').style.display = 'block';
                if (path && $("#txt_source_db_type").val() == "Excel") {
                    getExcelResponse(path);
                } else if ($("#txt_source_db_type").val() == "CSV") {
                    var grid = $("#SrcCsvGrid").data("kendoGrid");
                    var items = grid.dataSource._data;
                    var sourcefield = items.map(f => f.sourcefield_name).toString();
                    loadexistingdataset(sourcefield);
                } else if ($("#txt_source_db_type").val() == "MySql") {
                    loadexistingdataset("");
                }
            }
        }

        function dsSave(){
            var pipelineCode = $("#txt_ppl_code").val();
            var current_date = new Date;
            var ppldsgid = $('#txtds_gid').val();
            var data = {};
            data.dataset_systemflag = "N";
            data.pipelinedet_id = 0;
            data.pipeline_code = pipelineCode;
            data.dataset_name = $("#txtds_name").val(),
            data.datasetCode = "";
            data.dataset_id = 0;
            data.dataset_category = $("#txtds_category").val(),
            data.clone_dataset = "";
            data.active_status = 'D';
            data.inactive_reason = "";
            data.in_action = "INSERT";
            data.in_action_by =_user_code;
            data.in_user_code = _user_code;
            data.in_role_code = "";
            data.in_lang_code = ""; 
            data.pipelinedet_dataset_type = $('input[name="rdo_dsmode"]:checked').val();
            $.ajax({
            type: "Post",
            url: '@Url.Action("datasetheader", "Pipeline")',
            data: JSON.stringify(data),
            dataType: "json",
            contentType: 'application/json; charset=utf-8',
            success: function (response) {
                var res = JSON.parse(response);
                   if(res.length >= 0 && res[0].out_result == 1){
                    $("#txtds_code").val(res[0].in_dataset_code);
                    jAlert(res[0].out_msg, "Connector");
                    var ppl_code = $("#txt_ppl_code").val();
                    if ($("#txt_source_db_type").val() == "Excel") {
                        srcexcelfields(ppl_code, path, sheet_name, "Yes");
                    } else if($("#txt_source_db_type").val() == "CSV"){
                        Changetargetds("No");
                    } else if($("#txt_source_db_type").val() == "MySql") {
                           var ppl_code = $("#txt_ppl_code").val();
                           var conn_code = $('#connectors').val();
                           var database_name = $('#databasename').val();
                           var ds_code = $("#txtds_code").val();
                           srcmysqlfields(conn_code, ppl_code, database_name, v_srctblviewqry_desc, v_srctblviewqry_type, ds_code, "Yes");
                    }
                        $("#txtds_name").val("");
                        $("#txtds_category").val("");
                        $("#txtds_category1").val("");
                        $("#existingdataset").val("");
                    if(path && $("#txt_source_db_type").val() == "Excel") {
                            getExcelResponse(path);
                    } else if($("#txt_source_db_type").val() == "CSV"){
                        var grid = $("#SrcCsvGrid").data("kendoGrid");
                        var items = grid.dataSource._data;
                        var sourcefield = items.map(f => f.sourcefield_name).toString();
                        loadexistingdataset(sourcefield);
                    } else if($("#txt_source_db_type").val() == "MySql"){
                        loadexistingdataset("");
                    }
                } else {
                       jAlert(res[0].out_msg, "Connector");
                    }
            },
            error: function (er) {
                jAlert(er, "Error");
            }
        });
        }

            const tempSelection = document.getElementById("templateSelection");
            const dataSelection = document.getElementById("datasetSelection");
            const templateSelectionConf = document.getElementById("templateSelection_conf");
            const dataSelectionConf = document.getElementById("datasetSelection_conf");

            templateSelection.addEventListener("click", () => {
                templateSelectionConf.style.display = "block";
                dataSelectionConf.style.display = "none";

                dataSelection.classList.remove("active");
                tempSelection.classList.add("active");

            });

        datasetSelection.addEventListener("click", (event) => {
            event.preventDefault(); // stops default form submission
            event.stopPropagation(); // Optional: stop bubbling to parent handlers

            var pplcsdheaderGid = $('#txt_pplcsvheader_gid').val();
            var fileExtension = "";
            var itsValid = true;

            if($("#txt_source_db_type").val() == "Excel"){
                var selectedfile = document.getElementById("selectedfilename").textContent;
                var sheet_name1 = document.getElementById("txt_sheetname").value;
                var fileName = selectedfile == "" ? $('#txt_fileextension').val() : selectedfile;
                if (fileName) {
                    fileExtension = fileName.split;
                    var parts = fileName.split('.');
                    fileExtension = parts[parts.length - 1]; // gets the last part (e.g., 'xlsx')
                    if(fileExtension.toLowerCase() != "xlsx"){
                        jAlert("Please select .xlsx file.", "Connector");
                        $("#tab2").addClass("show-tab-important");
                        templateSelectionConf.style.display = "block";
                        dataSelectionConf.style.display = "none";
                        $('#cc_progressbar li').removeClass('active');
                        dataSelection.classList.remove("active");
                        document.getElementById("fieldmappingTab").classList.remove("active");
                        tempSelection.classList.add("active");
                        itsValid = false;
                        return;
                    }
                } else {
                    $("#tab2").addClass("show-tab-important");
                    templateSelectionConf.style.display = "block";
                    dataSelectionConf.style.display = "none";
                    dataSelection.classList.remove("active");
                    tempSelection.classList.add("active");
                    jAlert("Please select valid file.", "Connector");
                    itsValid = false;
                    return;
                }
            } else if($("#txt_source_db_type").val() == "MySql" && (!$("#databasename").val() || !$("#src_tblviewquery").val())){
                jAlert("Please fill and save all the mandatory fields.", "Connector");
                itsValid = false;
                return;
            }  else if ((pplcsdheaderGid == 0 || pplcsdheaderGid == "" || pplcsdheaderGid == "0" || pplcsdheaderGid == undefined) && $("#txt_source_db_type").val() == "CSV") {
                    jAlert("Please fill and save all the mandatory fields.", "Connector");
                    itsValid = false;
                    return;
                } else if($("#txt_source_db_type").val() == "MySql" && ($("#src_tblviewquery").val() != "-- Select --") ){
                    var srctblviewqry_type = document.getElementById("src_tblviewquery");
                    v_srctblviewqry_type = srctblviewqry_type.value;
                    // if (v_srctblviewqry_type == "T") {
                    //     var radioButton = $("input[name='radioGroup']:checked");
                    //     if (radioButton.length > 0) {
                    //         v_srctblviewqry_desc = TableselectRow(radioButton[0]);
                    //     }
                    // }
                    // else if (v_srctblviewqry_type == "V") {
                    //     var radioButton = $("input[name='radioGroup1']:checked");
                    //     if (radioButton.length > 0) {
                    //         v_srctblviewqry_desc = ViewselectRow(radioButton[0]);
                    //     }
                    // }
                    // else if (v_srctblviewqry_type == "Q") {
                    //     v_srctblviewqry_desc = document.getElementById("txt_cusquery").value;
                    // }
                    // else {
                    //     v_srctblviewqry_desc = trg_tbl.toString().split('-')[1];
                    // }
                    jAlert("Please fill all the mandatory fields.", "Connector");
                    itsValid = false;
                    return;
                }

            if(itsValid == true){
                if (!$('#txt_fileextension').val() && $("#txt_source_db_type").val() == "Excel" && fileExtension != "xlsx") {
                    jAlert("Please select valid file.", "Connector");
                    $("#tab2").addClass("show-tab-important");
                    document.getElementById("btn_nextppl1").disabled = true;
                    return;
                }  else if ((pplcsdheaderGid == 0 || pplcsdheaderGid == "" || pplcsdheaderGid == "0" || pplcsdheaderGid == undefined) && $("#txt_source_db_type").val() == "CSV") {
                    jAlert("Please fill and save all the mandatory fields.", "Connector");
                    return;
                }
                else if ($("#txt_source_db_type").val() == "MySql") {
                    jAlert("Please fill and save all the mandatory fields.", "Connector");
                    return;
                }

                if ($("#connectors").val()) {
                    pplsave();
                } else {
                    $("#tab2").addClass("show-tab-important");
                    templateSelectionConf.style.display = "block";
                    dataSelectionConf.style.display = "none";
                    datasetSelection.classList.remove("active");
                    templateSelection.classList.add("active");
                    jAlert("Please Choose Connector", "Connector");
                    return;
                }
                if (path && $("#txt_source_db_type").val() == "Excel" && fileExtension.toLowerCase() == "xlsx") {
                    getExcelResponse(path);
                    templateSelectionConf.style.display = "none";
                    dataSelectionConf.style.display = "block";

                    datasetSelection.classList.add("active");
                    templateSelection.classList.remove("active");
                } else if ($("#txt_source_db_type").val() == "CSV") {
                    var grid = $("#SrcCsvGrid").data("kendoGrid");
                    var items = grid.dataSource._data;
                    var sourcefield = items.map(f => f.sourcefield_name).toString();
                    loadexistingdataset(sourcefield);
                    templateSelectionConf.style.display = "none";
                    dataSelectionConf.style.display = "block";
                    datasetSelection.classList.add("active");
                    templateSelection.classList.remove("active");
                } else {
                    templateSelectionConf.style.display = "block";
                    dataSelectionConf.style.display = "none";
                    datasetSelection.classList.remove("active");
                    templateSelection.classList.add("active");
                }
            }
        });

        function SaveExistingDS(){
                var selectedValue = $("#existingdataset").val();
                var selectedText = $("#existingdataset option:selected").text() == '-- Select --' ? "" : selectedText;
                var pipelineCode = $("#txt_ppl_code").val();
                var current_date = new Date;
                var ppldsgid = $('#txtds_gid').val();
                var data = {};
                data.dataset_systemflag = "N";
                data.pipelinedet_id = 0;
                data.pipeline_code = pipelineCode;
                data.dataset_name = selectedText,
                data.datasetCode = selectedValue;
                data.dataset_id = 0;
                data.dataset_category = "",
                data.clone_dataset = "";
                data.active_status = "";
                data.inactive_reason = "";
                data.in_action = "PIPELINEMAP";
                data.in_action_by =_user_code;
                data.in_user_code = _user_code;
                data.in_role_code = "";
                data.in_lang_code = "";
                 data.pipelinedet_dataset_type = $('input[name="rdo_dsmode"]:checked').val();
                $.ajax({
                type: "Post",
                url: '@Url.Action("datasetheader", "Pipeline")',
                data: JSON.stringify(data),
                dataType: "json",
                contentType: 'application/json; charset=utf-8',
                success: function (response) {
                    var res = JSON.parse(response);
                       if(res.length >= 0 && res[0].out_result == 1){
                        $("#txtds_code").val(selectedValue);
                        jAlert(res[0].out_msg, "Connector");
                        var ppl_code = $("#txt_ppl_code").val();
                        if ($("#txt_source_db_type").val() == "Excel") {
                            srcexcelfields(ppl_code, path, sheet_name, "No");
                        }  else if($("#txt_source_db_type").val() == "CSV"){
                             Changetargetds("No");
                         } else if($("#txt_source_db_type").val() == "MySql") {
                           var ppl_code = $("#txt_ppl_code").val();
                           var conn_code = $('#connectors').val();
                           var database_name = $('#databasename').val();
                           var ds_code = $("#txtds_code").val();
                           srcmysqlfields(conn_code, ppl_code, database_name, v_srctblviewqry_desc, v_srctblviewqry_type, ds_code, "Yes");
                        }
                            $("#txtds_name").val("");
                            $("#txtds_category").val("");
                            $("#txtds_category1").val("");
                            $("#existingdataset").val("");
                             if(path && $("#txt_source_db_type").val() == "Excel") {
                                    getExcelResponse(path);
                                } else if($("#txt_source_db_type").val() == "CSV"){
                                  var grid = $("#SrcCsvGrid").data("kendoGrid");
                                 var items = grid.dataSource._data;
                                 var sourcefield = items.map(f => f.sourcefield_name).toString();
                                 loadexistingdataset(sourcefield);
                                } else if($("#txt_source_db_type").val() == "MySql"){
                                loadexistingdataset("");
                            }
                        } else {
                           jAlert(res[0].out_msg, "Connector");
                        }
                },
                error: function (er) {
                    jAlert(er, "Error");
                }
            });
        }

        function loadexistingdataset(excelheader) {
            getppldataset = [];
            dataset_grid1 = [];
            var foundMatch = false;
                var datasetType = $('input[name="rdo_dsmode"]:checked').val();
                var pipeline_code = $("#txt_ppl_code").val();
                $.ajax({
                    type: "GET",
                    url: '@Url.Action("GetDataSet", "Pipeline")?pipeline_code='+pipeline_code+"&source_fields="+excelheader+"&datasetType="+datasetType,
                    dataType: "json",
                    contentType: 'application/json; charset=utf-8',
                    success: function (data) {
                        if(data.length > 0){
                        for (var i = 0; i < data.length; i++) {
                            if(data[i].dataset_code == $("#txtds_code").val()){
                                data[i].selected = true;
                                selectedDataset = data[i].dataset_name;
                                foundMatch = true;
                            } else {
                                data[i].selected = false
                            }
                        }
                        if(!foundMatch){
                            $('#txtds_code').val("");
                            $('#trgdataset').val("");
                            $('#txt_trgdataset').val("");
                            selectedDataset = "";
                        }
                             dataset_grid1 = data.filter(item => item.pipeline_code != pipeline_code);
                             getppldataset = data.filter(item => item.pipeline_code == pipeline_code);
                        } else {
                             selectedDataset = "";
                        }
                        // var select = $("#existingdataset");
                        // select.empty();
                        // select.append($("<option>").attr("value", "").text("-- Select --"));
                        //     $.each(dataset_grid1, function (index, item) {
                        //     select.append($("<option>").attr("value", item.dataset_code).text(item.dataset_name));
                        // });

var combo = $("#existingdataset").kendoComboBox({
    dataTextField: "dataset_name",
    dataValueField: "dataset_code",
    dataSource: dataset_grid1,
    placeholder: "-- Select --",
    filter: "contains",
    suggest: true,
    change: function(e) {
        changeexistingds($(this.element));
    }
}).data("kendoComboBox");

                        Newdatasetgrid(getppldataset);
                    },
                    error: function (er) {
                        jAlert(er, "Error");
                    }
                });
            }

        function getdatasetfield() {
                    var pipeline_code = $("#txt_ppl_code").val();
                    var datset_code = $("#txtds_code").val();
                    $.ajax({
                        type: "GET",
                        url: '@Url.Action("GetDataSetField", "Pipeline")?pipeline_code='+pipeline_code+'&datset_code='+datset_code,
                        dataType: "json",
                        contentType: 'application/json; charset=utf-8',
                        success: function (data) {
                        if(data.length > 0) {
                        var showplusIcon = data.some(item => item.parent_pipeline_code === pipeline_code);
                        isExistingds = showplusIcon;
                        has_fieldmapsaved = data[0].has_saved;
                        var nextButton = document.getElementById('btn_nextppl2');
                        if(has_fieldmapsaved === "true") {
                            nextButton.disabled = false;
                        } else {
                            nextButton.disabled = true;
                        }
                        for(let i = 0 ; i< data.length; i++){
                            if(data[i]["source_type"] == "Expression"){

                            }
                        }
                          }
                          dsfieldMapgrid(data);
                         },
                        error: function (er) {
                            jAlert(er, "Error");
                        }
                    });
            }

        function getsourcefielddrpdown(){
                var pipeline_code = $("#txt_ppl_code").val();
                var datset_code = $("#txtds_code").val();
                $.ajax({
                    type: "GET",
                    url: '@Url.Action("GetSourceFiels", "Pipeline")?pipeline_code='+pipeline_code+'&datset_code='+datset_code,
                    dataType: "json",
                    contentType: 'application/json; charset=utf-8',
                    success: function (data) {
                        if(data.length > 0) {
                            sourceFieldNames = data;
                        }
                        },
                    error: function (er) {
                        jAlert(er, "Error");
                    }
                });
            }

        function datasetdetail(){
            var data = {};
            data.datasetCode = $("#txtds_code").val();
            data.datasetdetail_id = 0;
            data.field_name = pipelineCode;
            data.field_type = "TEXT",
            data.field_length = 255;
            data.precision_length = "";
            data.scale_length = "",
            data.field_mandatory = "";
            data.in_action = "INSERT";
            data.in_action_by = _user_code;
            $.ajax({
                type: "POST",
                url: '@Url.Action("datasetdetail", "Pipeline")',
                dataType: "json",
                contentType: 'application/json; charset=utf-8',
                success: function (data) {

                },
                error: function (er) {
                    jAlert(er, "Error");
                }
            });

    }

        function changeexistingds(ds){
            var selectedValue = $("#existingdataset").val();
            var choosecategory= dataset_grid1.filter(item => item.dataset_code == $("#existingdataset").val());
            if(choosecategory.length == 1) {
                 $("#txtds_category1").val(choosecategory[0].dataset_category);
            } else {
                $("#txtds_category1").val("");
            }
        }

        $("#grid_dsfieldMapping").data("kendoGrid").dataSource.bind("change", function(e) {
            if (["itemchange", "remove", "add"].includes(e.action)) {
                gridhasChange = true;
            }
        });

        function revert(){
            gridhasChange = false;
            getdatasetfield();
        }

       function getmysqlsrcfields(conn_code, pipeline_code, db_name, table_view_query_desc, table_view_query_type) {
              $.ajax({
               type: 'GET',
               url: '@Url.Action("Getmysqlcolheader", "Pipeline")?conn_code=' + conn_code + "&pipeline_code=" + pipeline_code + "&db_name="
                   + db_name + "&src_table=" + table_view_query_desc + "&table_view_query_type=" + table_view_query_type + "&user_code="
                   + _user_code,
               async: false,
               dataType: "json",
               contentType: 'application/json; charset=utf-8',
               success: function (data) {
                   var res = JSON.parse(data);
                   if(res.length > 0) {
                       loadexistingdataset(res.join(","));
                   }                
               },
               error: function (er) {
                   jAlert(er, "Error");
               }
           });
       }

    function rejectduplicatedwn(){
     var v_keydrop = document.getElementById("chkbox_rejduplicate");
     var radio3 = document.getElementById("rdo_abort1");
     var radio4 = document.getElementById("rdo_continue1");
     var upldmode = $("#upload_mode").val();

     var v_duplicate_mode = "";
    if (radio3.checked) {
        v_duplicate_mode = "Abort on Duplicates";
    } else if (radio4.checked) {
        v_duplicate_mode = "Continue With Duplicates";
    }
      if(v_keydrop.checked == false && v_duplicate_mode == 'Continue With Duplicates' && upldmode == 'Clean and Insert'){
         document.getElementById("keyfield_drp_s").style.display = "none";
    } else {
        document.getElementById("keyfield_drp_s").style.display = "inline";
    }
}

    function openAddFormatPopup(dropdown, options) {
        $("#formatPopup").remove(); 
        const popupContent = `
            <div style='padding: 20px;'>
                <label style="font-weight: bold;">New Custom Date Format</label><br/>
                <input type='text' id='newFormatInput' class='k-textbox' style='width: 100%; margin-top: 8px;' placeholder='e.g., yyyy-MM-dd' /><br/>
                <div style="margin-top: 15px; display: flex; justify-content: flex-end; gap: 10px;">
                            <button id='saveFormatBtn' style='background: #0fc9b7;color: #ffff;width: 50px; border-radius: 5px;border:#0fc9b7;'>Save</button>
                    <button id='closeFormatBtn' style='color: red;background-color: white;border: 1px solid red;width: 50px; border-radius: 5px;'>Close</button>
                </div>
            </div>
        `;

        const $popup = $("<div id='formatPopup'>").html(popupContent);
        $("body").append($popup);
        $popup.kendoWindow({
            width: "350px",
            height: "200px",
            title: "Add New Format",
            modal: true,
            visible: false,
            resizable: false,
            actions: [], 
            close: function () {
                this.destroy();
            }
        });

        const popupWindow = $popup.data("kendoWindow");
        popupWindow.center().open();
        $("#saveFormatBtn").on("click", function () {
            const newValue = $("#newFormatInput").val().trim();
            if (newValue) {
                dropdown.append(`<option value="${newValue}">${newValue}</option>`);
                dropdown.val(newValue);
                options.model.set(options.field, newValue);
                popupWindow.close();
            } else {
                 jAlert("Please enter a valid date format." ,"Connector" );
            }
        });
        $("#closeFormatBtn").on("click", function () {
            popupWindow.close();
            dropdown.val("--Select--");
            options.model.set(options.field, "--Select--");
        });
    }

    function saveNewFormat(dropdown, options, popupWindow) {
        const newFormat = $("#newFormatInput").val().trim();
        if (!newFormat) {
            jAlert("Please enter a valid date format." ,"Connector" );
            return;
        }
        const exists = dropdown.find("option").filter(function () {
            return $(this).val() === newFormat;
        }).length > 0;
        if (exists) {
            jAlert("This format already exists." ,"Connector" );
            return;
        }
        dateformatfield.unshift({ name: newFormat });
        const newOption = $("<option style='color:black;' value='" + newFormat + "'>" + newFormat + "</option>");
        dropdown.find("option:eq(1)").before(newOption);
        dropdown.val(newFormat);
        options.model.set(options.field, newFormat);
        options.model.set("pplsourcefield_format", newFormat);
        popupWindow.close();
    }

    function goToList(){
        user_code = sessionStorage.getItem("userCode");
        window.location.href = '@Url.Action("PipelineList", "Pipeline")?user_code=' + user_code;
    }

</script>
